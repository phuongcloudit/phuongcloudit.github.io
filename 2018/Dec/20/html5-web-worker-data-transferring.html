<!DOCTYPE html><title>HTML5 web worker: data transferring - manhhomienbienthuy's space</title> <meta charset=utf-8> <meta name=viewport content="width=device-width, initial-scale=1"> <link rel=apple-touch-icon href=/theme/images/icon-touch.png> <link rel=icon sizes=192x192 href=/theme/images/icon-touch.png> <link rel="shortcut icon" href=/theme/images/favicon.ico> <link rel=author href=/humans.txt> <meta name=msapplication-TileImage content=/theme/images/icon-tile.png> <meta name=twitter:dnt content=on> <meta name=Author content=manhhomienbienthuy> <meta name=rating content=general> <meta name=twitter:card content=product> <meta name=twitter:site content=@_naa_4f> <meta name=twitter:creator content=@_naa_4f> <link href=/feeds/all.atom.xml type=application/atom+xml rel=alternate title="manhhomienbienthuy's space Full Atom Feed"> <meta name=description content="Trong bài viết trước, chúng ta đã tìm hiểu những điều cơ bản về web worker cùng cách sử dụng đơn giản của nó. Trong bài viết này, chúng ta sẽ tìm hiểu sâu hơn về cơ ché truyền và nhận dữ liệu giữa thread chính của trang web và …"> <meta name=keywords content="JavaScript, Fundamental, Web worker, multithread, blog, naa, manhhomienbienthuy, pelican, static site generator"> <meta name=twitter:title content="HTML5 web worker: data transferring - manhhomienbienthuy's space"> <meta name=twitter:description content="Trong bài viết trước, chúng ta đã tìm hiểu những điều cơ bản về web worker cùng cách sử dụng đơn giản của nó. Trong bài viết này, chúng ta sẽ tìm hiểu sâu hơn về cơ ché truyền và nhận dữ liệu giữa thread chính của trang web và …"> <meta name=twitter:image content=/https://i.imgur.com/1zRqA1K.jpg> <link rel=stylesheet href=//cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css> <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.0.0/css/font-awesome.min.css> <link rel=stylesheet href=/theme/css/vpyeu.min.css?5d2c7d5e> <header> <div class=navbar> <div class=wrapper> <div class=nav-menu> <div class=menu-toggle> <i class="fa fa-reorder"></i> </div> <ul class=menus> <li><a href=/ >Home</a> <li><a href=/category/general.html> General <li><a href=/category/life.html> Life <li><a href=/category/programming.html class=current> Programming <li><a href=/category/travel.html> Travel </ul> </div><div class="right links"> <ul> <li> <a href=https://twitter.com/_naa_4f target=_blank> <i class="fa fa-twitter"></i> </a> <li> <a href=https://instagram.com/manhhomienbienthuy/ target=_blank> <i class="fa fa-instagram"></i> </a> <li> <a href=https://www.facebook.com/manhhomienbienthuy target=_blank> <i class="fa fa-facebook"></i> </a> <li> <a href=https://github.com/manhhomienbienthuy target=_blank> <i class="fa fa-github"></i> </a> <li> <a href=/feeds/all.atom.xml target=_blank> <i class="fa fa-rss"></i> </a> </ul> </div> </div> </div><noscript> <div class="warning head-warn"> <div class=wrapper> <p><strong>Notice:</strong> While JavaScript is not essential for this website, your interaction with the content will be limited. Please turn JavaScript on for the full experience. </div> </div> </noscript><div class=banner> <div class=wrapper> <a href=/ > <img alt="manhhomienbienthuy's space" src=/theme/images/logo.png> </a> </div> </div></header> <main> <div class=wrapper> <div class=main-wrapper> <div class=entry> <div class=entry-detail> <div class=post> <h1 class=title> HTML5 web worker: data transferring </h1> <div class=meta> Posted in <a href=/category/programming.html>Programming</a> on December 20, 2018 by <a href=/pages/about-me.html>manhhomienbienthuy</a> <span class=right> <i class="fa fa-comments"></i> <a href=#disqus_thread data-disqus-identifier=/2018/Dec/20/html5-web-worker-data-transferring.html> Comments </a> </span> </div> <div class=post-body> <img src=https://i.imgur.com/1zRqA1K.jpg alt="HTML5 web worker: data transferring"> <p>Trong <a href=../../../2018/Nov/20/html5-web-worker-the-fundamentals.html>bài viết trước</a>, chúng ta đã tìm hiểu những điều cơ bản về web worker cùng cách sử dụng đơn giản của nó. Trong bài viết này, chúng ta sẽ tìm hiểu sâu hơn về cơ ché truyền và nhận dữ liệu giữa thread chính của trang web và worker.</p> <h1 id=co-ban-ve-viec-truyen-va-nhan-du-lieu>Cơ bản về việc truyền và nhận dữ liệu<a class=headerlink href=#co-ban-ve-viec-truyen-va-nhan-du-lieu title="Permanent link">&para;</a></h1> <p>Dữ liệu được truyền và nhận giữa thread chính và worker theo phương pháp clone, chứ không truyền cùng một object. Object được serialize sau đó được truyền cho worker, rồi lại deserialize lúc nhận được. Thread chính và worker không bao giờ sử dụng chung một instance, dữ liệu nhận được ở một bên luôn là bản sao của dữ liệu từ bên còn lại.</p> <p>Phần lớn các trình duyệt đều cài đặt tính năng này bằng thuật toán <a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm>structured cloning</a>.</p> <p>Để minh hoạ cho quá trình này, chúng ta hãy xem xét một ví dụ như sau:</p> <div class=codehilite><pre><span></span><span class=kr>const</span> <span class=nx>emulateMsg</span> <span class=o>=</span> <span class=p>(</span><span class=nx>val</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nb>eval</span><span class=p>(</span><span class=sb>`(</span><span class=si>${</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span><span class=si>}</span><span class=sb>)`</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>Hàm <code>emulateMsg</code> mô phỏng hành vi của các tham số được truyền bằng cách clone chứ không phải giữ nguyên object cũ. Chúng ta có thể test thử xem sao:</p> <div class=codehilite><pre><span></span><span class=nx>val1</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Number</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
<span class=k>typeof</span> <span class=nx>val1</span> <span class=c1>// &quot;object&quot;</span>
<span class=k>typeof</span> <span class=nx>emulateMsg</span><span class=p>(</span><span class=nx>val1</span><span class=p>)</span> <span class=c1>// &quot;number&quot;</span>
<span class=nx>val2</span> <span class=o>=</span> <span class=kc>true</span>
<span class=k>typeof</span> <span class=nx>val2</span> <span class=c1>// &quot;boolean&quot;</span>
<span class=k>typeof</span> <span class=nx>emulateMsg</span><span class=p>(</span><span class=nx>val2</span><span class=p>)</span> <span class=c1>// &quot;boolean&quot;</span>
<span class=nx>val3</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>String</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>)</span>
<span class=k>typeof</span> <span class=nx>val3</span> <span class=c1>// &quot;object&quot;</span>
<span class=k>typeof</span> <span class=nx>emulateMsg</span><span class=p>(</span><span class=nx>val3</span><span class=p>)</span> <span class=c1>// &quot;string&quot;</span>
<span class=nx>val4</span> <span class=o>=</span> <span class=p>{</span><span class=nx>foo</span><span class=o>:</span> <span class=s1>&#39;foo&#39;</span><span class=p>,</span> <span class=nx>bar</span><span class=o>:</span> <span class=s1>&#39;bar&#39;</span><span class=p>}</span>
<span class=k>typeof</span> <span class=nx>val4</span> <span class=c1>// &quot;object&quot;</span>
<span class=k>typeof</span> <span class=nx>emulateMsg</span><span class=p>(</span><span class=nx>val4</span><span class=p>)</span> <span class=c1>// &quot;object&quot;</span>
</pre></div> <p>Như chúng ta đã biết, việc truyền và nhận dữ liệu từ thread chính và worker được thực hiện bằng cách truyền tham số vào hàm <code>postMessage</code> và giá trị của thuộc tính <code>data</code> trong <code>message</code> event. Với cách truyền tham số bằng clone như trên, việc gửi và nhận dữ liệu của thread chính và worker cũng hoàn toàn là copy.</p> <p>Đó cũng là lý do khiến cho dữ liệu truyền và nhận giữa worker được gọi là "message". Thuật toán <a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm>structured cloning</a> có thể nhận dữ liệu dưới dạng JSON và cả những dữ liệu phức tạp khác nữa.</p> <h1 id=vi-du>Ví dụ<a class=headerlink href=#vi-du title="Permanent link">&para;</a></h1> <p>Nếu cần phải truyền dữ liệu phức tạp, mà dữ liệu đó được gọi ở nhiều nơi cả thread chính lẫn worker thì chúng ta có thể xây dựng một hệ thống gộp chung tất cả.</p> <p>Trước hết, chúng ta tạo một class <code>QueryableWorker</code>, dùng để track các handler và giúp chúng ta giao tiếp với worker.</p> <div class=codehilite><pre><span></span><span class=kr>class</span> <span class=nx>QueryableWorker</span> <span class=p>{</span>
    <span class=nx>constructor</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>defaultHandler</span><span class=p>,</span> <span class=nx>errorHandler</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Worker</span><span class=p>(</span><span class=nx>url</span><span class=p>);</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>handlers</span> <span class=o>=</span> <span class=p>{};</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>defaultHandler</span> <span class=o>=</span> <span class=nx>defaultHandler</span> <span class=o>||</span> <span class=kd>function</span><span class=p>(){};</span>

        <span class=k>if</span> <span class=p>(</span><span class=nx>errorHandler</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>this</span><span class=p>.</span><span class=nx>worker</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=nx>errorHandler</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>this</span><span class=p>.</span><span class=nx>worker</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span> <span class=k>instanceof</span> <span class=nb>Object</span> <span class=o>&amp;&amp;</span>
                <span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>hasOwnProperty</span><span class=p>(</span><span class=s1>&#39;method&#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
                <span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>hasOwnProperty</span><span class=p>(</span><span class=s1>&#39;arguments&#39;</span><span class=p>))</span> <span class=p>{</span>
                    <span class=k>this</span><span class=p>.</span><span class=nx>handlers</span><span class=p>[</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>method</span><span class=p>].</span><span class=nx>apply</span><span class=p>(</span><span class=k>this</span><span class=p>,</span>
                        <span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>arguments</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=k>this</span><span class=p>.</span><span class=nx>defaultHandler</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=nx>postMessage</span><span class=p>(</span><span class=nx>message</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=nx>message</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nx>terminate</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>worker</span><span class=p>.</span><span class=nx>terminate</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=nx>addHandler</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>handler</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>handlers</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>handler</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nx>removeHandler</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>delete</span> <span class=k>this</span><span class=p>.</span><span class=nx>handlers</span><span class=p>[</span><span class=nx>name</span><span class=p>];</span>
    <span class=p>}</span>

    <span class=nx>sendQuery</span><span class=p>(...</span><span class=nx>args</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=mi>1</span> <span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=nx>TypeError</span><span class=p>(</span><span class=s1>&#39;at least 1 argument&#39;</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>this</span><span class=p>.</span><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>({</span>
            <span class=nx>method</span><span class=o>:</span> <span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
            <span class=nx>arguments</span><span class=o>:</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>slice</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>args</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
        <span class=p>})</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>Trong class trên, chúng ta sử dụng hai phương thức để thêm và bớt các handler.</p> <p>Các handler sẽ được thêm vào tuỳ ý sau khi tạo ra object thuộc class trên, cho phép nó có thể linh hoạt trong việc xử lý các phản hồi từ worker (xử lý thế nào hoàn toàn phụ thuộc vào handler được thêm vào).</p> <p>Còn phương thức <code>sendQuery</code> đùng dể gửi dữ liệu đến worker (bao gồm tên phương thức và tham số), yêu cầu worker thực hiện thao tác tương ứng.</p> <p>Với worker, để minh hoạ, chúng ta sẽ xây dựng worker thực hiện hai thao tác đơn giản: lấy một số ngẫu nhiên, tạm dừng 1 giây.</p> <div class=codehilite><pre><span></span><span class=kr>const</span> <span class=nx>reply</span> <span class=o>=</span> <span class=p>(...</span><span class=nx>args</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=mi>1</span> <span class=p>)</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=nx>TypeError</span><span class=p>(</span><span class=s1>&#39;at least 1 argument&#39;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=nx>postMessage</span><span class=p>({</span>
        <span class=nx>method</span><span class=o>:</span> <span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
        <span class=nx>arguments</span><span class=o>:</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>slice</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>args</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
    <span class=p>})</span>
<span class=p>}</span>

<span class=kr>const</span> <span class=nx>queryableFunctions</span> <span class=o>=</span> <span class=p>{</span>
    <span class=nx>getRandom</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=nx>reply</span><span class=p>(</span><span class=s1>&#39;printStuff&#39;</span><span class=p>,</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>());</span>
    <span class=p>},</span>
    <span class=nx>waitSomeTime</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span><span class=nx>reply</span><span class=p>(</span><span class=s1>&#39;doAlert&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;seconds&#39;</span><span class=p>)},</span> <span class=mi>1000</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>Phương thức <code>onmessage</code> của worker rất đơn giản: gọi và thực thi các phương thức cùng tham số nhận được. Code chỗ này tương tự như <code>onmessage</code> của thread chính, chỉ khác đó là nó sẽ gọi các hàm được định nghĩa sẵn chứ không phải handler được thêm vào sau.</p> <div class=codehilite><pre><span></span><span class=nx>onmessage</span> <span class=o>=</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span> <span class=k>instanceof</span> <span class=nb>Object</span> <span class=o>&amp;&amp;</span>
        <span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>hasOwnProperty</span><span class=p>(</span><span class=s1>&#39;method&#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
        <span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>hasOwnProperty</span><span class=p>(</span><span class=s1>&#39;arguments&#39;</span><span class=p>))</span> <span class=p>{</span>
        <span class=nx>queryableFunctions</span><span class=p>[</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>method</span><span class=p>].</span><span class=nx>apply</span><span class=p>(</span><span class=nx>self</span><span class=p>,</span>
            <span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>arguments</span><span class=p>)</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// do something</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>Demo cùng toàn bộ code của ví dụ này, mời các bạn xem <a href=https://manhhomienbienthuy.github.io/web-worker-sample/transfer/index.html>ở đây</a>.</p> <h1 id=tranferable>Tranferable<a class=headerlink href=#tranferable title="Permanent link">&para;</a></h1> <p>Structured cloning rất tuyệt vời, nhưng hoạt động của nó cũng là hành động copy dữ liệu mà thôi. Trong một số trường hợp cần truyền dữ liệu với kích thước lớn, structured cloning lại khiến tốc độ bị chậm đi. Ví dụ, nếu chúng ta cần truyền một <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer><code>ArrayBuffer</code></a> khoảng vài chục MB chẳng hạn, sẽ phải mất kha khá thời gian (khoảng nửa giây).</p> <p>Nửa giây nghe thì ít nhưng với các ứng dụng hiện nay, như vậy đã là một sự trễ giờ quá lớn. Rất may, các trình duyệt hiện đại đã có một cơ chế trong trường hợp này, đó là <a href=https://developer.mozilla.org/en-US/docs/Web/API/Transferable><code>Transferable</code></a> object.</p> <p>Các object thuộc loại Tranferable sẽ được truyền mà không hề cần tới thao tác clone. Điều đó sẽ khiến cho tốc độ tăng lên đáng kể. Tuy nhiên, việc sử dụng cách truyền dữ liệu này cũng có những tác dụng phụ. Không giống với cách thức truyền dữ liệu thông thường, dữ liệu truyền bằng cách này sẽ không còn truy cập được ở nơi đã truyền nó đi nữa.</p> <p>Ví dụ, nếu chúng ta truyền một <code>ArrayBuffer</code> từ thread chính vào worker thì dữ liệu của <code>ArrayBuffer</code> đó ở thread chính sẽ bị xoá và không thể truy cập được nữa. Có thể nói, toàn bộ dữ liệu đã được di chuyển hoàn toàn vào worker và không còn tồn tại ở chỗ cũ nữa.</p> <p>Để truyền dữ liệu vào worker dạng <code>Transferable</code>, chúng ta cần truyền hai tham số cho hàm <code>postMessage</code>: tham số đầu tiền là message, tham số thứ hai là danh sách các item cần transfer. Trong trường hợp này, chúng ta có thể truyền như sau:</p> <div class=codehilite><pre><span></span><span class=kr>const</span> <span class=nx>uInt8Array</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>(</span><span class=mi>1024</span> <span class=o>*</span> <span class=mi>1028</span> <span class=o>*</span> <span class=mi>32</span><span class=p>);</span> <span class=c1>// 32 MB</span>
<span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>uInt8Array</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>uInt8Array</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>i</span><span class=p>;</span>
<span class=p>}</span>
<span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=nx>uInt8Array</span><span class=p>.</span><span class=nx>buffer</span><span class=p>,</span> <span class=p>[</span><span class=nx>uInt8Array</span><span class=p>.</span><span class=nx>buffer</span><span class=p>]);</span>
</pre></div> <h1 id=so-sanh-toc-o>So sánh tốc độ<a class=headerlink href=#so-sanh-toc-o title="Permanent link">&para;</a></h1> <p>Dưới đây là cấu hình máy tính dùng để so sánh tốc độ giữa cách truyền dữ liệu thông thường (structured cloning) và cách dùng <code>Transferable</code>.</p> <p><img alt="cau hinh" src=https://i.imgur.com/QB3W7FK.png></p> <p>Với máy tính như vậy, tôi sẽ thực hiện so sánh với các trình duyệt <a href=https://www.apple.com/safari/ >Safari</a>, <a href=https://www.google.com/chrome/ >Chrome</a> và <a href=https://www.mozilla.org/en-US/firefox/new/ >Firefox</a>. Chúng ta sẽ so sánh tốc độ truyền dữ liệu với kích thước lớn (500MB) bằng hai phương pháp khác nhau.</p> <p>Ở đây, chúng ta chỉ so sánh tốc độ truyền tải dữ liệu giữa thread chính và worker, không so sánh tốc độ xử lý khi nhận dữ liệu. Dưới đây là code dùng để so sánh:</p> <p><strong>Truyền dử dụng bằng structured cloning</strong></p> <div class=codehilite><pre><span></span><span class=kr>const</span> <span class=nx>myWorker</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Worker</span><span class=p>(</span><span class=s2>&quot;worker.js&quot;</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>(</span><span class=mi>500</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>startTime</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>getTime</span><span class=p>();</span>
<span class=nx>myWorker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>timeTaken</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>getTime</span><span class=p>()</span> <span class=o>-</span> <span class=nx>startTime</span><span class=p>;</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Tranfer completed in </span><span class=si>${</span><span class=nx>timeTaken</span><span class=si>}</span><span class=sb>ms.`</span><span class=p>);</span>
</pre></div> <p><strong>Transferable</strong></p> <div class=codehilite><pre><span></span><span class=kr>const</span> <span class=nx>myWorker</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Worker</span><span class=p>(</span><span class=s2>&quot;worker.js&quot;</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>(</span><span class=mi>500</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>startTime</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>getTime</span><span class=p>();</span>
<span class=nx>myWorker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=p>[</span><span class=nx>data</span><span class=p>.</span><span class=nx>buffer</span><span class=p>]);</span>
<span class=kr>const</span> <span class=nx>timeTaken</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>getTime</span><span class=p>()</span> <span class=o>-</span> <span class=nx>startTime</span><span class=p>;</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Tranfer completed in </span><span class=si>${</span><span class=nx>timeTaken</span><span class=si>}</span><span class=sb>ms.`</span><span class=p>);</span>
</pre></div> <p>Dưới đây là bảng kết quả đo được khi sử dụng truyền dữ liệu bằng hai phương thức này:</p> <table> <thead> <tr> <th>Browser</th> <th>Structured Cloning</th> <th><code>Transferable</code></th> </tr> </thead> <tbody> <tr> <td>Safari</td> <td>1168ms</td> <td>1ms</td> </tr> <tr> <td>Chrome</td> <td>604ms</td> <td>10ms</td> </tr> <tr> <td>Firefox</td> <td>690ms</td> <td>1ms</td> </tr> </tbody> </table> <p>Nhìn vào đây chúng ta cũng thấy rằng, sử dụng <code>Transferable</code> để truyền dữ liệu giữa worker và thread chính có tốc độ cao hơn hẳn (nhanh hơn hàng trăm lần, thậm chí với Safari là hơn nghìn lần). Đây có thể là một lựa chọn tốt để truyền những dữ liệu lớn nhưng không có nhu cầu tái sử dụng ở nguồn.</p> <h1 id=van-e-ve-hieu-nang-voi-transferable-phuc-tap>Vấn đề về hiệu năng với <code>Transferable</code> phức tạp<a class=headerlink href=#van-e-ve-hieu-nang-voi-transferable-phuc-tap title="Permanent link">&para;</a></h1> <p>Trong phần trước, chúng ta đã so sánh tốc độ truyền dữ liệu giữa cách thông thường và dùng <code>Transferable</code>. Và chúng ta đã thấy rằng, tốc độ khi sử dụng <code>Transferable</code> đã từng lên đáng kể. Thế nhưng, đó là trường hợp dữ liệu đơn giản, dữ liệu của message và của buffer tương ứng với nhau.</p> <p>Tuy nhiên, trong các trường hợp phức tạp hơn, mọi chuyện không còn như vậy nữa. Dưới đây là một đoạn code dùng để test tốc độ truyền tải dữ liệu giữa thread chính và worker bằng hai phương pháp đó. Điểm khác biệt ở đây là dữ liệu mà chúng ta truyền tải không phải dữ liệu đơn giản (chỉ là một mảng nữa) mà phức tạp hơn nhiều.</p> <p>Chúng ta sẽ truyền tải message là một mảng hai chiều, và một mảng buffer cũng là mảng hai chiều của các buffer. Trong thực tế, chúng ta có thể gặp các trường hợp dữ liệu phức tạp hơn nữa.</p> <div class=codehilite><pre><span></span><span class=kd>function</span> <span class=nx>transferByLine</span><span class=p>(</span><span class=nx>line</span><span class=p>,</span> <span class=nx>transferable</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>var</span> <span class=nx>arr</span> <span class=o>=</span> <span class=p>[];</span>
    <span class=kd>var</span> <span class=nx>bufferArr</span> <span class=o>=</span> <span class=p>[];</span>
    <span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>line</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>arr</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>transferable</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>bufferArr</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>arr</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>buffer</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Successfully created the array.&#39;</span><span class=p>);</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`The array has </span><span class=si>${</span><span class=nx>line</span><span class=si>}</span><span class=sb> items, each item size is 100 bytes`</span><span class=p>);</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Start transferring with transferable=</span><span class=si>${</span><span class=nx>transferable</span><span class=si>}</span><span class=sb>...`</span><span class=p>);</span>
    <span class=kd>var</span> <span class=nx>startTime</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>getTime</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>transferable</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>myWorker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=nx>arr</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=nx>myWorker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=nx>arr</span><span class=p>,</span> <span class=nx>bufferArr</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=kd>var</span> <span class=nx>timeTaken</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>getTime</span><span class=p>()</span> <span class=o>-</span> <span class=nx>startTime</span><span class=p>;</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Tranfer completed in </span><span class=si>${</span><span class=nx>timeTaken</span><span class=si>}</span><span class=sb>ms.`</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> <p>Dưới đây là kết quả kiểm tra với các kích thước khác nhau của dữ liệu:</p> <table> <thead> <tr> <th>Lines</th> <th>Safari (clone / <code>Transferable</code>)</th> <th>Chrome (clone / <code>Transferable</code>)</th> <th>Firefox (clone / <code>Transferable</code>)</th> </tr> </thead> <tbody> <tr> <td>2000</td> <td>6ms / 3ms</td> <td>3ms / 11ms</td> <td>7ms / 11ms</td> </tr> <tr> <td>4000</td> <td>21ms / 4ms</td> <td>1ms / 20ms</td> <td>37ms / 19ms</td> </tr> <tr> <td>6000</td> <td>17ms / 9ms</td> <td>2ms / 40ms</td> <td>22ms / 28ms</td> </tr> <tr> <td>8000</td> <td>19ms / 15ms</td> <td>19ms / 56ms</td> <td>57ms / 56ms</td> </tr> <tr> <td>10000</td> <td>33ms / 14ms</td> <td>10ms / 70ms</td> <td>78ms / 53ms</td> </tr> <tr> <td>20000</td> <td>63ms / 35ms</td> <td>28ms / 205ms</td> <td>84ms / 192ms</td> </tr> <tr> <td>40000</td> <td>106ms / 67ms</td> <td>67ms / 678ms</td> <td>187ms / 203ms</td> </tr> <tr> <td>60000</td> <td>137ms / 106ms</td> <td>92ms / 1417ms</td> <td>357ms / 552ms</td> </tr> <tr> <td>80000</td> <td>218ms / 146ms</td> <td>169ms / 2415ms</td> <td>595ms / 490ms</td> </tr> <tr> <td>100000</td> <td>266ms / 174ms</td> <td>170ms / 3796ms</td> <td>834ms / 717ms</td> </tr> <tr> <td>200000</td> <td>521ms / 391ms</td> <td>453ms / 15572ms</td> <td>866ms / 865ms</td> </tr> </tbody> </table> <p>Nhìn các con số hơi khô khan một chút, chúng ta hãy xem biểu đồ minh hoạ cho kết quả này như sau:</p> <p><img alt=chart src=https://i.imgur.com/qMuCgt5.png></p> <p>Trong số các trình duyệt được test, chỉ có Safari là giữ được phong độ khi tốc độ truyền tải bằng <code>Transferable</code> vẫn nhanh hơn cách truyền thống. Chrome và Firefox đều sa sút khi tốc độ truyền tải bằng cách truyền thống còn nhanh hơn. Tuy nhiên đó chưa phải là điều đáng nói ở đây.</p> <p>Nếu để ý, chúng ta sẽ thấy rằng, khi kích thước dữ liệu tăng lên,thời gian truyền tải của Safari hay Firefox tăng rất từ từ, cả cách truyền thống lẫn dùng <code>Transferable</code>.</p> <p>Thế nhưng, riêng với Chrome, thời gian truyền tải tăng theo hàm mũ khi sử dụng <code>Transferable</code>, trong khi cách truyền thống vẫn tăng tuyến tính giống Safari và Firefox. Nguyên nhân có thể là do Chrome mất nhiều thời gian để phân tích tham số thứ hai của hàm <code>postMessage</code> (một mảng các mảng buffer) và tìm cách map nó mới tham số thứ nhât. Rõ ràng Chrome không hề được tối ưu cho thao tác này.</p> <h1 id=ket-luan>Kết luận<a class=headerlink href=#ket-luan title="Permanent link">&para;</a></h1> <p>Web worker có hai phương thức khác nhau để truyền tải dữ liệu giữa thread chính và worker. Mỗi phương thức đều có những ưu điểm riêng. Nếu cần truyền tải dữ liệu với kích thước lớn, chúng ta có thể sử dụng <code>Transferable</code> nếu dữ liệu đó chỉ được lưu ở một vài biến. Trong trường hợp dữ liệu kích thước lớn có cấu trúc phức tạp, được lưu bằng một mảng nhiều phần tử, thì cách truyền thống dùng structured cloning lại tốt hơn.</p> </div> <div class=post-footer> <div class=tags> <i class="fa fa-tags"></i> <span>#JavaScript</span> <span>#Fundamental</span> <span>#Web worker</span> <span>#multithread</span> </div> </div> </div><div class=blog-pager> <span class=newer-link> <a href=/2018/Dec/31/the-year-in-review-2018.html> Newer Post </a> </span> <span class=older-link> <a href=/2018/Nov/25/markdown-editor-reviews.html> Older Post </a> </span> </div><div class=comments> <div class=finally> <p><em>I apologise for any typos. If you notice a problem, please let me know.</em> <p>Thank you all for your attention. </div> <div id=disqus_thread></div> <script src=/theme/js/disqus.min.js?81e8a5f5></script> <noscript> Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript> comments powered by Disqus. </a> </noscript> </div></div> </div> </div> <div class=sidebar-wrapper> <div class=widget> <h2>Welcome</h2> <div> <img src=/theme/images/banner.gif alt=Welcome> </div> </div><div class="widget recent-posts"> <h2>Recent Posts</h2> <ul> <li> <a href=/2019/May/20/elasticsearch-data-organization.html> <img alt="Elasticsearch: Data organization" src=https://i.imgur.com/JT4y7Qf.jpg> </a> <a href=/2019/May/20/elasticsearch-data-organization.html>Elasticsearch: Data organization</a> <li> <a href=/2019/May/20/elasticsearch-intro.html> <img alt="Elasticsearch: Intro" src=https://i.imgur.com/JT4y7Qf.jpg> </a> <a href=/2019/May/20/elasticsearch-intro.html>Elasticsearch: Intro</a> <li> <a href=/2019/Apr/20/javascript-popups.html> <img alt="JavaScript: Popups" src=https://i.imgur.com/FxmcwPy.png> </a> <a href=/2019/Apr/20/javascript-popups.html>JavaScript: Popups</a> <li> <a href=/2019/Mar/20/javascript-iterator-and-generator.html> <img alt="JavaScript: Iterator and generator" src=https://i.imgur.com/lev8iT9.jpg> </a> <a href=/2019/Mar/20/javascript-iterator-and-generator.html>JavaScript: Iterator and generator</a> <li> <a href=/2019/Feb/20/javascript-decorator.html> <img alt="JavaScript decorator" src=https://i.imgur.com/Sh3yLI0.png> </a> <a href=/2019/Feb/20/javascript-decorator.html>JavaScript decorator</a> </ul> </div><div class="widget labels"> <h2>Blog Archive</h2> <ul> <li> <a href=/2019/ > 2019 </a> <li> <a href=/2018/ > 2018 </a> <li> <a href=/2017/ > 2017 </a> <li> <a href=/2016/ > 2016 </a> <li> <a href=/2015/ > 2015 </a> <li> <a href=/2014/ > 2014 </a> <li> <a href=/2013/ > 2013 </a> <li> <a href=/2012/ > 2012 </a> <li> <a href=/2011/ > 2011 </a> <li> <a href=/2010/ > 2010 </a> </ul> </div><div class=widget> <h2>Twitter timeline</h2> <a class=twitter-timeline data-height=500 data-dnt=true data-theme=light href=https://twitter.com/_naa_4f data-chrome="noheader nofooter transparent noborders"> Tweets by manhhomienbienthuy </a> </div> </div> </div> <a href=# class="smooth-scroll back-to-top"> <i class="fa fa-arrow-circle-up fa-3x"></i> </a> </main> <footer> <div class=infos> <div class=wrapper> <div class=widget> <a href=/ title="manhhomienbienthuy's space" class=logo> <img alt="manhhomienbienthuy's space" src=/theme/images/logo_white.png> </a> <span class=right>I'm a hacker, enter my world...</span> </div><div class=widget> <p> Created with all my ♥ and soul, dedicated to my love, yunachan <p> Powered by <a href=http://blog.getpelican.com/ target=_blank>Pelican</a>, which takes great advantage of <a href=https://www.python.org/ target=_blank>Python</a> <p> This site content is licensed under a <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank> CC BY-NC-ND 4.0 </a> License. <p> Updated at <a target=_blank href="http://www.timeanddate.com/worldclock/fixedtime.html?iso=2019-06-20T02:42:55"> 2019-06-20 02:42:55 </a> </div><div class=widget> <p> Hosting by <a href=https://manhhomienbienthuy.bitbucket.io/ >Bitbucket</a> and <a href=https://manhhomienbienthuy.github.io/ >Github</a>, image hosting by <a href=https://manhhomienbienthuy.imgur.com/ target=_blank>imgur</a>, <a href=https://instagram.com/manhhomienbienthuy/ target=_blank>Instagram</a> and <a href=https://photos.google.com/ target=_blank>Google Photo</a> <p> Theme based on <a href=https://vanice-veethemes.blogspot.com/ target=_blank>Vanice theme</a>, icons from <a href=https://fontawesome.com/ target=_blank>Font Awesome</a>, comments powered by <a href=https://disqus.com/home/forums/manhhomienbienthuy/ target=_blank>Disqus</a> </div> </div> </div> <div class=credits> <div class=wrapper> <div class=left> <!--
          Regarding copyright, in general, standalone pages (as
          opposed to files generated as part of manuals) on the GNU
          web server should be under CC BY-ND 4.0.  Please do NOT
          change or remove this without talking with the webmasters or
          licensing team first.  Please make sure the copyright date
          is consistent with the document.  For web pages, it is ok to
          list just the latest year the document was modified, or
          published.

          If you wish to list earlier years, that is ok too.  Either
          "2001, 2002, 2003" or "2001-2003" are ok for specifying
          years, as long as each year in the range is in fact a
          copyrightable year, i.e., a year in which the document was
          published (including being publicly visible on the web or in
          a revision control system).
        --> Copyright © 2010-2019 <a href=/pages/about-me.html><strong>manhhomienbienthuy</strong></a>. All rights reserved. </div> <div class=right> <ul> <li><a href=/ >Home</a> <li><a href=/pages/about-me.html>About</a> <li><a href=# class=smooth-scroll>Top ↑</a> </ul> </div> </div> </div></footer> <script src=https://code.jquery.com/jquery-3.2.1.js></script> <script src=//cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js></script> <script src=//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.2/imagesloaded.pkgd.min.js></script> <script src=/theme/js/vpyeu.min.js?d72c87bd></script> <script id=dsq-count-scr src=https://manhhomienbienthuy.disqus.com/count.js async></script>