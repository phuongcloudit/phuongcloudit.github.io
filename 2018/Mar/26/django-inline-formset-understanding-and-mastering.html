<!DOCTYPE html><title>Django inline formset: understanding and mastering - manhhomienbienthuy's space</title> <meta charset=utf-8> <meta name=viewport content="width=device-width, initial-scale=1"> <link rel=apple-touch-icon href=/theme/images/icon-touch.png> <link rel=icon sizes=192x192 href=/theme/images/icon-touch.png> <link rel="shortcut icon" href=/theme/images/favicon.ico> <link rel=author href=/humans.txt> <meta name=msapplication-TileImage content=/theme/images/icon-tile.png> <meta name=twitter:dnt content=on> <meta name=Author content=manhhomienbienthuy> <meta name=rating content=general> <meta name=twitter:card content=product> <meta name=twitter:site content=@_naa_4f> <meta name=twitter:creator content=@_naa_4f> <link href=/feeds/all.atom.xml type=application/atom+xml rel=alternate title="manhhomienbienthuy's space Full Atom Feed"> <meta name=description content="Django đã cung cấp cho chúng ta model form và model formset giúp chúng ta làm việc với form của các model, cả số ít lẫn số nhiều. Trong bài viết này, chúng ta sẽ tìm hiểu một vấn đề có phần phức tạp hơn một chút, đó là inline …"> <meta name=keywords content="Python, Django, form, inline, formset, blog, naa, manhhomienbienthuy, pelican, static site generator"> <meta name=twitter:title content="Django inline formset: understanding and mastering - manhhomienbienthuy's space"> <meta name=twitter:description content="Django đã cung cấp cho chúng ta model form và model formset giúp chúng ta làm việc với form của các model, cả số ít lẫn số nhiều. Trong bài viết này, chúng ta sẽ tìm hiểu một vấn đề có phần phức tạp hơn một chút, đó là inline …"> <meta name=twitter:image content=/https://i.imgur.com/EWASS33.png> <link rel=stylesheet href=//cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css> <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.0.0/css/font-awesome.min.css> <link rel=stylesheet href=/theme/css/vpyeu.min.css?5d2c7d5e> <header> <div class=navbar> <div class=wrapper> <div class=nav-menu> <div class=menu-toggle> <i class="fa fa-reorder"></i> </div> <ul class=menus> <li><a href=/ >Home</a> <li><a href=/category/general.html> General <li><a href=/category/life.html> Life <li><a href=/category/programming.html class=current> Programming <li><a href=/category/travel.html> Travel </ul> </div><div class="right links"> <ul> <li> <a href=https://twitter.com/_naa_4f target=_blank> <i class="fa fa-twitter"></i> </a> <li> <a href=https://instagram.com/manhhomienbienthuy/ target=_blank> <i class="fa fa-instagram"></i> </a> <li> <a href=https://www.facebook.com/manhhomienbienthuy target=_blank> <i class="fa fa-facebook"></i> </a> <li> <a href=https://github.com/manhhomienbienthuy target=_blank> <i class="fa fa-github"></i> </a> <li> <a href=/feeds/all.atom.xml target=_blank> <i class="fa fa-rss"></i> </a> </ul> </div> </div> </div><noscript> <div class="warning head-warn"> <div class=wrapper> <p><strong>Notice:</strong> While JavaScript is not essential for this website, your interaction with the content will be limited. Please turn JavaScript on for the full experience. </div> </div> </noscript><div class=banner> <div class=wrapper> <a href=/ > <img alt="manhhomienbienthuy's space" src=/theme/images/logo.png> </a> </div> </div></header> <main> <div class=wrapper> <div class=main-wrapper> <div class=entry> <div class=entry-detail> <div class=post> <h1 class=title> Django inline formset: understanding and mastering </h1> <div class=meta> Posted in <a href=/category/programming.html>Programming</a> on March 26, 2018 by <a href=/pages/about-me.html>manhhomienbienthuy</a> <span class=right> <i class="fa fa-comments"></i> <a href=#disqus_thread data-disqus-identifier=/2018/Mar/26/django-inline-formset-understanding-and-mastering.html> Comments </a> </span> </div> <div class=post-body> <img src=https://i.imgur.com/EWASS33.png alt="Django inline formset: understanding and mastering"> <p>Django đã cung cấp cho chúng ta <a href=https://docs.djangoproject.com/en/2.0/topics/forms/modelforms/#modelform>model form</a> và <a href=https://docs.djangoproject.com/en/2.0/topics/forms/modelforms/#model-formsets>model formset</a> giúp chúng ta làm việc với form của các model, cả số ít lẫn số nhiều.</p> <p>Trong bài viết này, chúng ta sẽ tìm hiểu một vấn đề có phần phức tạp hơn một chút, đó là inline formset. Inline formset có thể giúp chúng ta thao tác với nhiều đối tượng (có phụ thuộc vào nhau) trong cùng một form.</p> <p>Thực ra, Django cũng có hướng dẫn về việc sử dụng <a href=https://docs.djangoproject.com/en/2.0/topics/forms/modelforms/#inline-formsets>inline formset</a>, nhưng đây là hướng dẫn cho trường hợp edit. Bài viết này sẽ trình bày chủ yếu cho trường hợp create. Trường hợp edit cũng tương tự.</p> <h1 id=model-trong-bai-toan>Model trong bài toán<a class=headerlink href=#model-trong-bai-toan title="Permanent link">&para;</a></h1> <p>Trước hết hãy xem các model trong bài toán của chúng ta như sau</p> <div class=codehilite><pre><span></span><span class=c1># models.py</span>
<span class=k>class</span> <span class=nc>Parent</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>name</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>_</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>),</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>255</span><span class=p>)</span>


<span class=k>class</span> <span class=nc>Child</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>parent</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ForeignKey</span><span class=p>(</span><span class=n>Parent</span><span class=p>,</span> <span class=n>on_delete</span><span class=o>=</span><span class=n>models</span><span class=o>.</span><span class=n>CASCADE</span><span class=p>)</span>
    <span class=n>name</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>_</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>),</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>255</span><span class=p>)</span>
</pre></div> <h1 id=su-dung-inline-formset-e-tao-du-lieu-cho-hai-bang-cung-luc>Sử dụng inline formset để tạo dữ liệu cho hai bảng cùng lúc<a class=headerlink href=#su-dung-inline-formset-e-tao-du-lieu-cho-hai-bang-cung-luc title="Permanent link">&para;</a></h1> <p>Bây giờ, giả sử chúng ta cần sử dụng một form để thao tác cùng lúc với các bản ghi lưu thông tin của cả bố mẹ và con cái, chúng ta cần làm thế nào? Inline formset sẽ giúp chúng ta trong trường hợp này.</p> <div class=codehilite><pre><span></span><span class=c1># forms.py</span>
<span class=kn>from</span> <span class=nn>django.forms</span> <span class=k>import</span> <span class=n>ModelForm</span><span class=p>,</span> <span class=n>inlineformset_factory</span>

<span class=kn>from</span> <span class=nn>.models</span> <span class=k>import</span> <span class=n>Child</span><span class=p>,</span> <span class=n>Parent</span>


<span class=n>ChildrenFormset</span> <span class=o>=</span> <span class=n>inlineformset_factory</span><span class=p>(</span><span class=n>Parent</span><span class=p>,</span> <span class=n>Child</span><span class=p>,</span> <span class=n>fields</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,))</span>
</pre></div> <p>Inline formset sẽ giúp chúng ta tạo form với rất ít code. Nếu muốn, chúng ta có thể thay đổi logic của những formset này, ví dụ validation chẳng hạn. Tuy nhiên, cài đặt mặc định của formset cũng đủ tốt rồi nên chúng ta cũng không cần phải thay đổi quá nhiều.</p> <p>Dưới đây là view để hiển thị form này:</p> <div class=codehilite><pre><span></span><span class=c1># views.py</span>
<span class=k>class</span> <span class=nc>ParentList</span><span class=p>(</span><span class=n>ListView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Parent</span>


<span class=k>class</span> <span class=nc>ParentCreate</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>Parent</span>
    <span class=n>fields</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span>
    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;formset:parents-list&#39;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>get_context_data</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>context</span> <span class=o>=</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>get_context_data</span><span class=p>()</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>POST</span><span class=p>:</span>
            <span class=n>context</span><span class=p>[</span><span class=s1>&#39;children&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>ChildrenFormset</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>POST</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>context</span><span class=p>[</span><span class=s1>&#39;children&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>ChildrenFormset</span><span class=p>()</span>
        <span class=k>return</span> <span class=n>context</span>
</pre></div> <p>Ở đây, chúng ta cần một chút xử lý. Django có thể cho chúng ta một view create rất đơn giản mà không cần phải chỉnh sửa gì nhiều. Ở đây, chúng ta chỉ đơn giản là thêm một đối tượng là inline formset vào context data mà thôi. Cuối cùng là hiển thị trên trình duyệt form mà chúng ta đã tạo ra. Hiển thị mặc định của Django cho inline form không được hay lắm, nên ở đây chúng ta phải customize lại một chút.</p> <div class=codehilite><pre><span></span><span class=c>{# parent_form.html #}</span>
<span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&quot;&quot;</span> <span class=na>method</span><span class=o>=</span><span class=s>&quot;post&quot;</span><span class=p>&gt;</span>
        <span class=cp>{%</span> <span class=k>csrf_token</span> <span class=cp>%}</span>
        <span class=cp>{{</span> <span class=nv>form.as_p</span> <span class=cp>}}</span>

        <span class=p>&lt;</span><span class=nt>table</span><span class=p>&gt;</span>
          <span class=p>&lt;</span><span class=nt>thead</span><span class=p>&gt;</span>
              <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
                  <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>Name<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
                  <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>Delete<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
              <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
          <span class=p>&lt;/</span><span class=nt>thead</span><span class=p>&gt;</span>

            <span class=cp>{{</span> <span class=nv>children.management_form</span> <span class=cp>}}</span>
            <span class=cp>{%</span> <span class=k>for</span> <span class=nv>child_form</span> <span class=k>in</span> <span class=nv>children.forms</span> <span class=cp>%}</span>
                <span class=cp>{%</span> <span class=k>for</span> <span class=nv>hidden</span> <span class=k>in</span> <span class=nv>child_form.hidden_fields</span> <span class=cp>%}</span>
                    <span class=cp>{{</span> <span class=nv>hidden</span> <span class=cp>}}</span>
                <span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span>
                <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
                    <span class=cp>{%</span> <span class=k>for</span> <span class=nv>field</span> <span class=k>in</span> <span class=nv>child_form.visible_fields</span> <span class=cp>%}</span>
                        <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>
                            <span class=cp>{{</span> <span class=nv>field.errors.as_ul</span> <span class=cp>}}</span>
                            <span class=cp>{{</span> <span class=nv>field</span> <span class=cp>}}</span>
                        <span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
                    <span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span>
                <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
            <span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span>
        <span class=p>&lt;/</span><span class=nt>table</span><span class=p>&gt;</span>

        <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;submit&quot;</span> <span class=na>value</span><span class=o>=</span><span class=s>&quot;Save&quot;</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;</span><span class=cp>{%</span> <span class=k>url</span> <span class=s1>&#39;formset:parents-list&#39;</span> <span class=cp>%}</span><span class=s>&quot;</span><span class=p>&gt;</span>back to the list<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</pre></div> <p>File template này đã customize hầu như toàn bộ form để có thể hiển thị form theo đúng định dạng mà chúng ta muốn. Có lẽ các bạn cũng biết rồi, chúng ta cần phải sử dụng <code>management_form</code> cũng các "hidden fields" trong template thì form mới có thể hoạt động đúng được.</p> <p>Vậy là tương đối đầy đủ để chúng ta có một form lồng nhau cho phép chúng ta có thể tạo cùng lúc cả parent và child. Việc bây giờ chúng ta cần làm làm lưu những gì người dùng submit lại. Mặc định thì Django CreateView không giúp chúng ta xử lý inline form, vì vậy chúng ta sẽ làm việc này bằng tay. Việc đó không phải là khó lắm, nó sẽ được thực hiện ở views bằng cách override hàm <code>form_valid</code> như sau:</p> <div class=codehilite><pre><span></span><span class=c1># views.py</span>
<span class=k>class</span> <span class=nc>ParentCreate</span><span class=p>(</span><span class=n>CreateView</span><span class=p>):</span>
    <span class=o>...</span>
    <span class=k>def</span> <span class=nf>form_valid</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>form</span><span class=p>):</span>
        <span class=n>context</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_context_data</span><span class=p>()</span>
        <span class=n>children</span> <span class=o>=</span> <span class=n>context</span><span class=p>[</span><span class=s1>&#39;children&#39;</span><span class=p>]</span>
        <span class=k>with</span> <span class=n>transaction</span><span class=o>.</span><span class=n>atomic</span><span class=p>():</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>object</span> <span class=o>=</span> <span class=n>form</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
            <span class=k>if</span> <span class=n>children</span><span class=o>.</span><span class=n>is_valid</span><span class=p>():</span>
                <span class=n>children</span><span class=o>.</span><span class=n>instance</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>object</span>
                <span class=n>children</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
        <span class=k>return</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>form_valid</span><span class=p>(</span><span class=n>form</span><span class=p>)</span>
</pre></div> <p>Mọi việc đã hoàn thành, form của chúng ta đã hoạt động hoàn hảo. Mời các bạn xem demo dưới đây.</p> <iframe width=100% height=315 src=https://www.youtube.com/embed/By6uPwWPRdE frameborder=0 allow="autoplay; encrypted-media" allowfullscreen></iframe> <p>Tuy nhiên, form ở đây của chúng ta là form tĩnh, tức là inline form hoàn toàn cố định, mà mặc định nó có 3 form con. Tất nhiên chúng ta có thể chỉnh sửa con số này nhưng nó vẫn cứ là cố định. Rất may là có người đã giúp chúng làm việc đó. Có một plugin cho jQuery là <a href=https://github.com/elo80ka/django-dynamic-formset>django-dynamic-formset</a> cực kỳ hữu ích trong trường hợp này.</p> <p>Sử dụng plugin rất đơn giản, chỉ cầm thêm vào trang html một chút code nữa là được</p> <div class=codehilite><pre><span></span><span class=cp>{%</span> <span class=k>load</span> <span class=nv>static</span> <span class=cp>%}</span>
<span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&quot;//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js&quot;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&quot;</span><span class=cp>{%</span> <span class=k>static</span> <span class=s1>&#39;jquery.formset.js&#39;</span> <span class=cp>%}</span><span class=s>&quot;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&quot;text/javascript&quot;</span><span class=p>&gt;</span>
    <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;.formset_row&#39;</span><span class=p>).</span><span class=nx>formset</span><span class=p>({</span>
        <span class=nx>addText</span><span class=o>:</span> <span class=s1>&#39;add child&#39;</span><span class=p>,</span>
        <span class=nx>deleteText</span><span class=o>:</span> <span class=s1>&#39;remove&#39;</span><span class=p>,</span>
        <span class=nx>prefix</span><span class=o>:</span> <span class=s1>&#39;child_set&#39;</span>
    <span class=p>});</span>
<span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</pre></div> <p>Chỉ đơn giản vậy thôi là trang web của chúng ta trông đã "cool" hơn rất nhiều</p> <iframe width=100% height=315 src=https://www.youtube.com/embed/3SbXyuzzmZY frameborder=0 allow="autoplay; encrypted-media" allowfullscreen></iframe> <p>Lưu ý rằng, sử dụng plugin này, chúng ta cần thêm class cho <code>tr</code> cho đúng, đồng thời phải cấu hình plugin một chút, đặc biệt là prefix (ở đây tôi sử dụng prefix mặc định Django đã tạo ra). Điều này rất quan trọng, nếu không khi submit form sẽ có một số lỗi.</p> <h1 id=su-dung-inline-form-tao-du-lieu-cho-3-model-cung-mot-luc>Sử dụng inline form tạo dữ liệu cho 3 model cùng một lúc<a class=headerlink href=#su-dung-inline-form-tao-du-lieu-cho-3-model-cung-mot-luc title="Permanent link">&para;</a></h1> <p>Giả sử bài toán của chúng ta mở rộng thêm một chút với model như sau:</p> <div class=codehilite><pre><span></span><span class=k>class</span> <span class=nc>Address</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>child</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ForeignKey</span><span class=p>(</span><span class=n>Child</span><span class=p>,</span> <span class=n>on_delete</span><span class=o>=</span><span class=n>models</span><span class=o>.</span><span class=n>CASCADE</span><span class=p>)</span>
    <span class=n>address</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>_</span><span class=p>(</span><span class=s1>&#39;address&#39;</span><span class=p>),</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>255</span><span class=p>)</span>
</pre></div> <p>Bây giờ, tôi muốn trong form vừa rồi, có thể điền trực tiếp luôn address cho các con mà không cần phải mở một trang khác. Tất nhiên rồi, mở một trang khác thì quá đơn giản, chúng ta chỉ cần dùng inline form một lần nữa tương tự như trên</p> <div class=codehilite><pre><span></span><span class=n>AddressFormset</span> <span class=o>=</span> <span class=n>inlineformset_factory</span><span class=p>(</span><span class=n>Child</span><span class=p>,</span> <span class=n>Address</span><span class=p>,</span>
                                       <span class=n>fields</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;address&#39;</span><span class=p>,),</span> <span class=n>extra</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</pre></div> <p>Tuy nhiên, như vậy thì quá bất tiện. Tôi muốn một form có thể làm được tất cả mọi việc. Việc này hoàn toàn có thể làm được, thậm chí đã được Django support rất tốt.</p> <h2 id=inh-nghia-mot-baseformset-e-de-dang-customize>Định nghĩa một BaseFormset để dễ dàng customize<a class=headerlink href=#inh-nghia-mot-baseformset-e-de-dang-customize title="Permanent link">&para;</a></h2> <p>Như chúng ta đã biết, để dễ dàng customize inline formset, chúng ta có thể định nghĩa một class gọi là "base" kế thừa từ <code>BaseInlineFormSet</code> sau đó override phương thức nào mà chúng ta muốn.</p> <p>Trong bài toán của chúng ta, khi tình hình có thể phức tạp, chúng ta nên sử dụng phương pháp này.</p> <div class=codehilite><pre><span></span><span class=k>class</span> <span class=nc>BaseChildrenFormset</span><span class=p>(</span><span class=n>BaseInlineFormSet</span><span class=p>):</span>
    <span class=k>pass</span>


<span class=n>ChildrenFormset</span> <span class=o>=</span> <span class=n>inlineformset_factory</span><span class=p>(</span><span class=n>Parent</span><span class=p>,</span> <span class=n>Child</span><span class=p>,</span> <span class=n>fields</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,),</span>
                                        <span class=n>formset</span><span class=o>=</span><span class=n>BaseChildrenFormset</span><span class=p>,</span> <span class=n>extra</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</pre></div> <h2 id=customize-baseformset-e-them-form-long-nhau>Customize BaseFormset để thêm form lồng nhau<a class=headerlink href=#customize-baseformset-e-them-form-long-nhau title="Permanent link">&para;</a></h2> <p>Chúng ta cần override phương thức <code>add_fields</code> của <code>BaseInlineFormSet</code>, điều này sẽ giúp chúng ta thêm form lồng nhau cho một form inline sẵn có.</p> <div class=codehilite><pre><span></span><span class=k>class</span> <span class=nc>BaseChildrenFormset</span><span class=p>(</span><span class=n>BaseInlineFormSet</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>add_fields</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>form</span><span class=p>,</span> <span class=n>index</span><span class=p>):</span>
        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>add_fields</span><span class=p>(</span><span class=n>form</span><span class=p>,</span> <span class=n>index</span><span class=p>)</span>
        <span class=n>form</span><span class=o>.</span><span class=n>nested</span> <span class=o>=</span> <span class=n>AddressFormset</span><span class=p>(</span>
            <span class=n>instance</span><span class=o>=</span><span class=n>form</span><span class=o>.</span><span class=n>instance</span><span class=p>,</span>
            <span class=n>data</span> <span class=o>=</span> <span class=n>form</span><span class=o>.</span><span class=n>data</span> <span class=k>if</span> <span class=n>form</span><span class=o>.</span><span class=n>is_bound</span> <span class=k>else</span> <span class=kc>None</span><span class=p>,</span>
            <span class=n>prefix</span><span class=o>=</span><span class=s1>&#39;address-</span><span class=si>%s</span><span class=s1>-</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span>
                <span class=n>form</span><span class=o>.</span><span class=n>prefix</span><span class=p>,</span>
                <span class=n>AddressFormset</span><span class=o>.</span><span class=n>get_default_prefix</span><span class=p>()</span>
            <span class=p>)</span>
        <span class=p>)</span>
</pre></div> <p>Ở đây, chúng ta định nghĩa thêm một thuộc tính <code>nested</code> cho inline form. Nhờ vậy mà chúng ta có thể gọi form này trên template rất dễ dàng, đồng thời không cần thay đổi views vì không cần thêm object nào trên views cả.</p> <h2 id=hien-thi-form-long-nhau-tren-template>Hiển thị form lồng nhau trên template<a class=headerlink href=#hien-thi-form-long-nhau-tren-template title="Permanent link">&para;</a></h2> <p>Views không cần thay đổi gì cả, chúng ta chỉ cần thay đổi template để hiển thị thêm form lồng nhau là được</p> <div class=codehilite><pre><span></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>child_form.nested</span> <span class=cp>%}</span>
    <span class=cp>{{</span> <span class=nv>child_form.nested.management_form</span> <span class=cp>}}</span>
    <span class=cp>{%</span> <span class=k>for</span> <span class=nv>hidden</span> <span class=k>in</span> <span class=nv>nested_form.hidden_fields</span> <span class=cp>%}</span>
        <span class=cp>{{</span> <span class=nv>hidden</span> <span class=cp>}}</span>
    <span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span>
    <span class=cp>{%</span> <span class=k>for</span> <span class=nv>nested_form</span> <span class=k>in</span> <span class=nv>child_form.nested</span> <span class=cp>%}</span>
        <span class=cp>{%</span> <span class=k>for</span> <span class=nv>field</span> <span class=k>in</span> <span class=nv>nested_form.visible_fields</span> <span class=cp>%}</span>
            <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>
                <span class=cp>{{</span> <span class=nv>field.errors.as_ul</span> <span class=cp>}}</span>
                <span class=cp>{{</span> <span class=nv>field</span> <span class=cp>}}</span>
            <span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
        <span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span>
    <span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span>
<span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span>
</pre></div> <h2 id=xu-ly-du-lieu-form-uoc-submit>Xử lý dữ liệu form được submit<a class=headerlink href=#xu-ly-du-lieu-form-uoc-submit title="Permanent link">&para;</a></h2> <p>Toàn bộ phần hiển thị đã xong, việc cuối cùng chúng ta cần làm là xử lý những dữ liệu form được người dùng submit. Ở đây chúng ta cần quan tâm 2 việc: validate và lưu dữ liệu.</p> <p>Để validate, chúng ta cần override hàm <code>is_valid</code> của BaseFormset</p> <div class=codehilite><pre><span></span><span class=k>class</span> <span class=nc>BaseChildrenFormset</span><span class=p>(</span><span class=n>BaseInlineFormSet</span><span class=p>):</span>
    <span class=o>...</span>
    <span class=k>def</span> <span class=nf>is_valid</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>result</span> <span class=o>=</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>is_valid</span><span class=p>()</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_bound</span><span class=p>:</span>
            <span class=k>for</span> <span class=n>form</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>forms</span><span class=p>:</span>
                <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>form</span><span class=p>,</span> <span class=s1>&#39;nested&#39;</span><span class=p>):</span>
                    <span class=n>result</span> <span class=o>=</span> <span class=n>result</span> <span class=ow>and</span> <span class=n>form</span><span class=o>.</span><span class=n>nested</span><span class=o>.</span><span class=n>is_valid</span><span class=p>()</span>
        <span class=k>return</span> <span class=n>result</span>
</pre></div> <p>Sau khi validate xong, chúng ta cần lưu những dữ liệu valid lại. Chúng ta sẽ override hàm <code>save</code> để làm việc này. Lưu ý một chút là khi lưu chúng ta cần lưu dử liệu của cả form inline mà form con lồng ở trong nó.</p> <div class=codehilite><pre><span></span><span class=k>class</span> <span class=nc>BaseChildrenFormset</span><span class=p>(</span><span class=n>BaseInlineFormSet</span><span class=p>):</span>
    <span class=o>...</span>
    <span class=k>def</span> <span class=nf>save</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>commit</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
    <span class=n>result</span> <span class=o>=</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>commit</span><span class=o>=</span><span class=n>commit</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>form</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>forms</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>form</span><span class=p>,</span> <span class=s1>&#39;nested&#39;</span><span class=p>):</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_should_delete_form</span><span class=p>(</span><span class=n>form</span><span class=p>):</span>
                <span class=n>form</span><span class=o>.</span><span class=n>nested</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>commit</span><span class=o>=</span><span class=n>commit</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>result</span>
</pre></div> <p>Vậy là xong, giờ là chúng ta tận hưởng thành quả của quá trình lao động miệt mài.</p> <iframe width=100% height=315 src=https://www.youtube.com/embed/AWH981yb96E frameborder=0 allow="autoplay; encrypted-media" allowfullscreen></iframe> <p>Hơi đáng tiếc là plugin chúng ta dùng trong phần trước không dùng được trong trường hợp phức tạp này. Để có tính năng "cool" đó, có lẽ chúng ta sẽ phải code JS để xử lý thêm thôi. Việc này xin dành cho bạn đọc, vì nó cũng không phải nội dung chính của bài viết này.</p> <h1 id=ket-luan>Kết luận<a class=headerlink href=#ket-luan title="Permanent link">&para;</a></h1> <p>Django inline formset thực sự là một công cụ rất khủng của Django. Biết vận dụng nó một cách linh hoạt sẽ giúp ích rất nhiều cho chúng ta trong công việc. Hy vọng bài viết phần nào giúp các bạn hiểu hơn về inline formset và cách sử dụng của nó trong thực tế.</p> </div> <div class=post-footer> <div class=tags> <i class="fa fa-tags"></i> <span>#Python</span> <span>#Django</span> <span>#form</span> <span>#inline</span> <span>#formset</span> </div> </div> </div><div class=blog-pager> <span class=newer-link> <a href=/2018/Apr/19/what-changes-in-http20.html> Newer Post </a> </span> <span class=older-link> <a href=/2018/Jan/12/algorithm-primality-test.html> Older Post </a> </span> </div><div class=comments> <div class=finally> <p><em>I apologise for any typos. If you notice a problem, please let me know.</em> <p>Thank you all for your attention. </div> <div id=disqus_thread></div> <script src=/theme/js/disqus.min.js?81e8a5f5></script> <noscript> Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript> comments powered by Disqus. </a> </noscript> </div></div> </div> </div> <div class=sidebar-wrapper> <div class=widget> <h2>Welcome</h2> <div> <img src=/theme/images/banner.gif alt=Welcome> </div> </div><div class="widget recent-posts"> <h2>Recent Posts</h2> <ul> <li> <a href=/2019/May/20/elasticsearch-data-organization.html> <img alt="Elasticsearch: Data organization" src=https://i.imgur.com/JT4y7Qf.jpg> </a> <a href=/2019/May/20/elasticsearch-data-organization.html>Elasticsearch: Data organization</a> <li> <a href=/2019/May/20/elasticsearch-intro.html> <img alt="Elasticsearch: Intro" src=https://i.imgur.com/JT4y7Qf.jpg> </a> <a href=/2019/May/20/elasticsearch-intro.html>Elasticsearch: Intro</a> <li> <a href=/2019/Apr/20/javascript-popups.html> <img alt="JavaScript: Popups" src=https://i.imgur.com/FxmcwPy.png> </a> <a href=/2019/Apr/20/javascript-popups.html>JavaScript: Popups</a> <li> <a href=/2019/Mar/20/javascript-iterator-and-generator.html> <img alt="JavaScript: Iterator and generator" src=https://i.imgur.com/lev8iT9.jpg> </a> <a href=/2019/Mar/20/javascript-iterator-and-generator.html>JavaScript: Iterator and generator</a> <li> <a href=/2019/Feb/20/javascript-decorator.html> <img alt="JavaScript decorator" src=https://i.imgur.com/Sh3yLI0.png> </a> <a href=/2019/Feb/20/javascript-decorator.html>JavaScript decorator</a> </ul> </div><div class="widget labels"> <h2>Blog Archive</h2> <ul> <li> <a href=/2019/ > 2019 </a> <li> <a href=/2018/ > 2018 </a> <li> <a href=/2017/ > 2017 </a> <li> <a href=/2016/ > 2016 </a> <li> <a href=/2015/ > 2015 </a> <li> <a href=/2014/ > 2014 </a> <li> <a href=/2013/ > 2013 </a> <li> <a href=/2012/ > 2012 </a> <li> <a href=/2011/ > 2011 </a> <li> <a href=/2010/ > 2010 </a> </ul> </div><div class=widget> <h2>Twitter timeline</h2> <a class=twitter-timeline data-height=500 data-dnt=true data-theme=light href=https://twitter.com/_naa_4f data-chrome="noheader nofooter transparent noborders"> Tweets by manhhomienbienthuy </a> </div> </div> </div> <a href=# class="smooth-scroll back-to-top"> <i class="fa fa-arrow-circle-up fa-3x"></i> </a> </main> <footer> <div class=infos> <div class=wrapper> <div class=widget> <a href=/ title="manhhomienbienthuy's space" class=logo> <img alt="manhhomienbienthuy's space" src=/theme/images/logo_white.png> </a> <span class=right>I'm a hacker, enter my world...</span> </div><div class=widget> <p> Created with all my ♥ and soul, dedicated to my love, yunachan <p> Powered by <a href=http://blog.getpelican.com/ target=_blank>Pelican</a>, which takes great advantage of <a href=https://www.python.org/ target=_blank>Python</a> <p> This site content is licensed under a <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank> CC BY-NC-ND 4.0 </a> License. <p> Updated at <a target=_blank href="http://www.timeanddate.com/worldclock/fixedtime.html?iso=2019-06-20T02:42:55"> 2019-06-20 02:42:55 </a> </div><div class=widget> <p> Hosting by <a href=https://manhhomienbienthuy.bitbucket.io/ >Bitbucket</a> and <a href=https://manhhomienbienthuy.github.io/ >Github</a>, image hosting by <a href=https://manhhomienbienthuy.imgur.com/ target=_blank>imgur</a>, <a href=https://instagram.com/manhhomienbienthuy/ target=_blank>Instagram</a> and <a href=https://photos.google.com/ target=_blank>Google Photo</a> <p> Theme based on <a href=https://vanice-veethemes.blogspot.com/ target=_blank>Vanice theme</a>, icons from <a href=https://fontawesome.com/ target=_blank>Font Awesome</a>, comments powered by <a href=https://disqus.com/home/forums/manhhomienbienthuy/ target=_blank>Disqus</a> </div> </div> </div> <div class=credits> <div class=wrapper> <div class=left> <!--
          Regarding copyright, in general, standalone pages (as
          opposed to files generated as part of manuals) on the GNU
          web server should be under CC BY-ND 4.0.  Please do NOT
          change or remove this without talking with the webmasters or
          licensing team first.  Please make sure the copyright date
          is consistent with the document.  For web pages, it is ok to
          list just the latest year the document was modified, or
          published.

          If you wish to list earlier years, that is ok too.  Either
          "2001, 2002, 2003" or "2001-2003" are ok for specifying
          years, as long as each year in the range is in fact a
          copyrightable year, i.e., a year in which the document was
          published (including being publicly visible on the web or in
          a revision control system).
        --> Copyright © 2010-2019 <a href=/pages/about-me.html><strong>manhhomienbienthuy</strong></a>. All rights reserved. </div> <div class=right> <ul> <li><a href=/ >Home</a> <li><a href=/pages/about-me.html>About</a> <li><a href=# class=smooth-scroll>Top ↑</a> </ul> </div> </div> </div></footer> <script src=https://code.jquery.com/jquery-3.2.1.js></script> <script src=//cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js></script> <script src=//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.2/imagesloaded.pkgd.min.js></script> <script src=/theme/js/vpyeu.min.js?d72c87bd></script> <script id=dsq-count-scr src=https://manhhomienbienthuy.disqus.com/count.js async></script>