<!DOCTYPE html><title>Cryptography: Untwisting Mersenne Twister - manhhomienbienthuy's space</title> <meta charset=utf-8> <meta name=viewport content="width=device-width, initial-scale=1"> <link rel=apple-touch-icon href=/theme/images/icon-touch.png> <link rel=icon sizes=192x192 href=/theme/images/icon-touch.png> <link rel="shortcut icon" href=/theme/images/favicon.ico> <link rel=author href=/humans.txt> <meta name=msapplication-TileImage content=/theme/images/icon-tile.png> <meta name=twitter:dnt content=on> <meta name=Author content=manhhomienbienthuy> <meta name=rating content=general> <meta name=twitter:card content=product> <meta name=twitter:site content=@_naa_4f> <meta name=twitter:creator content=@_naa_4f> <link href=/feeds/all.atom.xml type=application/atom+xml rel=alternate title="manhhomienbienthuy's space Full Atom Feed"> <meta name=description content="Cách mã hóa sử dụng one-time pad (OTP), hay còn được gọi là Vernam-cipher hoặc perfect cipher là cách mã hóa sử dụng khóa ngẫu nhiên. Đây là cách mã hóa duy nhất, về lý thuyết, là bảo mật và không thể bẻ khóa được. Tuy nhiên, cuộc đời thường …"> <meta name=keywords content="Security, Cryptography, CTF, PRNG, Mersenne Twister, crack, blog, naa, manhhomienbienthuy, pelican, static site generator"> <meta name=twitter:title content="Cryptography: Untwisting Mersenne Twister - manhhomienbienthuy's space"> <meta name=twitter:description content="Cách mã hóa sử dụng one-time pad (OTP), hay còn được gọi là Vernam-cipher hoặc perfect cipher là cách mã hóa sử dụng khóa ngẫu nhiên. Đây là cách mã hóa duy nhất, về lý thuyết, là bảo mật và không thể bẻ khóa được. Tuy nhiên, cuộc đời thường …"> <meta name=twitter:image content=/https://i.imgur.com/fRK5HZl.jpg> <link rel=stylesheet href=//cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css> <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.0.0/css/font-awesome.min.css> <link rel=stylesheet href=/theme/css/vpyeu.min.css?5d2c7d5e> <header> <div class=navbar> <div class=wrapper> <div class=nav-menu> <div class=menu-toggle> <i class="fa fa-reorder"></i> </div> <ul class=menus> <li><a href=/ >Home</a> <li><a href=/category/general.html class=current> General <li><a href=/category/life.html> Life <li><a href=/category/programming.html> Programming <li><a href=/category/travel.html> Travel </ul> </div><div class="right links"> <ul> <li> <a href=https://twitter.com/_naa_4f target=_blank> <i class="fa fa-twitter"></i> </a> <li> <a href=https://instagram.com/manhhomienbienthuy/ target=_blank> <i class="fa fa-instagram"></i> </a> <li> <a href=https://www.facebook.com/manhhomienbienthuy target=_blank> <i class="fa fa-facebook"></i> </a> <li> <a href=https://github.com/manhhomienbienthuy target=_blank> <i class="fa fa-github"></i> </a> <li> <a href=/feeds/all.atom.xml target=_blank> <i class="fa fa-rss"></i> </a> </ul> </div> </div> </div><noscript> <div class="warning head-warn"> <div class=wrapper> <p><strong>Notice:</strong> While JavaScript is not essential for this website, your interaction with the content will be limited. Please turn JavaScript on for the full experience. </div> </div> </noscript><div class=banner> <div class=wrapper> <a href=/ > <img alt="manhhomienbienthuy's space" src=/theme/images/logo.png> </a> </div> </div></header> <main> <div class=wrapper> <div class=main-wrapper> <div class=entry> <div class=entry-detail> <div class=post> <h1 class=title> Cryptography: Untwisting Mersenne Twister </h1> <div class=meta> Posted in <a href=/category/general.html>General</a> on July 04, 2016 by <a href=/pages/about-me.html>manhhomienbienthuy</a> <span class=right> <i class="fa fa-comments"></i> <a href=#disqus_thread data-disqus-identifier=/2016/Jul/04/cryptography-untwisting-mersenne-twister.html> Comments </a> </span> </div> <div class=post-body> <img src=https://i.imgur.com/fRK5HZl.jpg alt="Cryptography: Untwisting Mersenne Twister"> <p>Cách mã hóa sử dụng one-time pad (OTP), hay còn được gọi là Vernam-cipher hoặc perfect cipher là cách mã hóa sử dụng khóa ngẫu nhiên. Đây là cách mã hóa duy nhất, về lý thuyết, là bảo mật và không thể bẻ khóa được. Tuy nhiên, cuộc đời thường lắm trái ngang, thực tế lại chẳng được đẹp đẽ như lý thuyết. Trong bài viết này, tôi sẽ trình bày cách bẻ khóa một cách mã hóa như vậy.</p> <h1 id=bai-toan>Bài toán<a class=headerlink href=#bai-toan title="Permanent link">&para;</a></h1> <p>Để minh họa cho việc bẻ khóa này, chúng ta đến với bài toán sau. Đây là đề bài trong cuộc thi CTF của công ty. Đề bài của bài toán này có thể xem <a href=http://ctf.framgia.vn/task/14>ở đây</a> (hy vọng nó chưa bị xóa). Trong trường hợp nó bị xóa rồi thì tôi đã backup file <a href=http://web.sfc.wide.ad.jp/~naa/ctf/impossibru_encrypt.zip>ở đây</a>.</p> <p>Có thể hiểu bài toán này đơn giản như sau: file flag là một file ảnh, được mã hóa bằng one-time pad. Đề bài chỉ cho chúng ta file đã mã hóa và công việc của chúng ta là tìm cách khôi phục file flag ban đầu. Chúng ta được cho mã nguồn đã biết được quá trình mã hóa như thế nào. Nhưng không có khóa, chúng ta phải làm thế nào đây, khi mà nó hoàn toàn được sinh ngẫu nhiên.</p> <h2 id=cach-ma-hoa>Cách mã hóa<a class=headerlink href=#cach-ma-hoa title="Permanent link">&para;</a></h2> <p>Thực ra cách mã hóa rất đơn giản, file gốc được đọc theo từng khối 4 byte (32 bit) một, mỗi khối được coi như một số nguyên không dấu. Với mỗi khối như vậy, một khóa là một số nguyên không dấu 32bit được sinh ngẫu nhiên, và dữ liệu mã hóa là kết quả của phép XOR giữa hai số nguyên không dấu đó. Phép XOR có những tính chất sau:</p> <div class=codehilite><pre><span></span>A XOR B = B XOR A
A XOR B = C =&gt; A XOR C = B
</pre></div> <p>Vì những tính chất trên, chúng ta có thể dễ dàng giải mã ngược lại bằng cách XOR file mã hóa với khóa. Tuy nhiên, chúng ta cần phải biết khóa, trong trường hợp này nó được sinh ngẫu nhiên. Nên làm sao chúng ta biết được đây.</p> <p>Tôi nhớ Ada Lovelace, người được coi là lập trình viên đầu tiên, đã từng nói rằng: Máy tính rất ngu ngốc và chúng ta phải dạy nó mọi thứ. Sau bao nhiêu năm, máy tính đã thông minh hơn nhiều rồi, nhưng trong bài toán của chúng ta, nó vẫn đủ ngốc để chúng ta tìm cách bẻ khóa nó.</p> <p>Để bẻ được khóa, chúng ta cần biết khóa được sinh ra như thế nào.</p> <h2 id=mersenne-twister>Mersenne Twister<a class=headerlink href=#mersenne-twister title="Permanent link">&para;</a></h2> <p>Thực ra, với một cái máy tính không có gì là ngẫu nhiên cả. Việc sinh các số ngẫu nhiên thực ra cũng hoàn toàn là do con người dạy nó. Mà đã dạy được, thì có thể bẻ khóa được. Vì không thực sự là ngẫu nhiên, nên việc sinh số ngẫu nhiên của máy tính là giả ngẫu nhiên (pseudorandom), và các thuật toán sinh số ngẫu nhiên được gọi là pseudorandom number generator (pRNG). Trong số các thuật toán đã được phát minh thì Mersenne Twister là thuật toán được sử dụng rộng rãi nhất. Ngày nay nó vẫn được sử dụng, ví dụ Ruby có hàm <code>rand</code>, Python có hàm <code>random</code>, PHP có <code>mt_rand</code> chính là sử dụng thuật toán này.</p> <p>Mã nguồn của phiên bản 19937 được đưa ra trong đề bài của chúng ta. Ở đây, tôi không đi sâu vào chi tiết thuật toán mà sẽ chỉ giới thiệu sơ lược. Trước khi sinh giá trị ngẫu nhiên, bộ khởi tạo cần được gọi trước. Chương trình sẽ có một state là một mảng 624 phần tử, mỗi lần sinh số ngẫu nhiên, 1 phần tử từ state sẽ được lấy ra và biến đổi (tampering) để cho ra một số. Sau khi state đã được lấy hết, state mới sẽ được tính toán dựa vào state hiện tại.</p> <p>Với việc sinh số ngẫu nhiên như vậy, nếu chúng ta biết được bất cứ một state nào, thì các state tiếp theo, và cả các số "ngẫu nhiên" tiếp theo, chúng ta hoàn toàn có thể biết được. Tuy nhiên, đó là lý tưởng, khi thực hiện khó hơn rất nhiều, nhưng không phải là không thể. Và đề bài cũng đã cho chúng ta một gợi ý, đó là trước khi mã hóa, họ đã mã hóa một file khác trước. Và nhờ những thông tin này, chúng ta có thể tìm ra khóa cho file flag. Chúng ta sẽ tìm hiểu cách làm này trong phần tiếp theo.</p> <h1 id=untwisting>Untwisting<a class=headerlink href=#untwisting title="Permanent link">&para;</a></h1> <p>Vì mỗi state có 624 số, và sẽ sinh ra 624 số ngẫu nhiên. Nếu chúng ta có được 624 số ngẫu nhiên sinh ra từ 1 state, liệu chúng ta có thể tìm ra được state đó không?</p> <p>Trước hết, làm thế nào chúng ta lấy được 624 số từ 1 state. Rất đơn giản, gợi ý cho chúng ta đã có rồi. File gốc và file mã hóa đều có, chúng ta dễ dàng lấy ra khóa của nó bằng cách XOR hai file này với nhau. Và vì đây là một gợi ý nên nó đủ dài để chúng ta có thể lấy ra 624 số ngẫu nhiên của state đầu tiên. Việc bây giờ chúng ta cần làm là khôi phục lại state đó và tìm cách tính toán các state tiếp theo.</p> <p>Như vậy kể cả khi chúng ta không biết các state được khởi tạo như thế nào, chúng ta vẫn có thể giả ngẫu nhiên để tìm ra khóa của flag được.</p> <h2 id=tinh-toan-state-tiep-theo>Tính toán state tiếp theo<a class=headerlink href=#tinh-toan-state-tiep-theo title="Permanent link">&para;</a></h2> <p>Việc tính toán này không có chút nào. Nó hoàn toàn dựa vào tính toán dịch bit, XOR và AND. Ở đây tôi sẽ code bằng Python nên phép toán dịch bit sang phải sẽ hơi khác một chút. Ví dụ, Python khi dịch bit các số âm sẽ giữ nguyên dấu của chúng:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=o>-</span><span class=mi>1</span> <span class=o>&gt;&gt;</span> <span class=mi>3</span>
<span class=go>-1</span>
</pre></div> <p>Nhưng Mersenne Twister làm việc với các số không dấu nên chúng ta cần một phép toán khác, thực ra nó cũng không khó lắm:</p> <div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>rshift</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>shift</span><span class=p>):</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>value</span> <span class=o>%</span> <span class=mh>0x100000000</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=n>shift</span>
</pre></div> <p>Và chúng ta có thể mô phỏng quá trình sinh state mới:</p> <div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>next_state</span><span class=p>(</span><span class=n>mt</span><span class=p>):</span>
    <span class=n>mag01</span> <span class=o>=</span> <span class=p>[</span><span class=mh>0x0</span><span class=p>,</span> <span class=n>MATRIX_A</span><span class=p>]</span>

    <span class=k>for</span> <span class=n>kk</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>N</span> <span class=o>-</span> <span class=n>M</span><span class=p>):</span>
        <span class=n>y</span> <span class=o>=</span> <span class=p>(</span><span class=n>mt</span><span class=p>[</span><span class=n>kk</span><span class=p>]</span> <span class=o>&amp;</span> <span class=n>UPPER_MASK</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>mt</span><span class=p>[</span><span class=n>kk</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>&amp;</span> <span class=n>LOWER_MASK</span><span class=p>)</span>
        <span class=n>mt</span><span class=p>[</span><span class=n>kk</span><span class=p>]</span> <span class=o>=</span> <span class=n>mt</span><span class=p>[</span><span class=n>kk</span> <span class=o>+</span> <span class=n>M</span><span class=p>]</span> <span class=o>^</span> <span class=n>rshift</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>^</span> <span class=n>mag01</span><span class=p>[</span><span class=n>y</span> <span class=o>&amp;</span> <span class=mh>0x1</span><span class=p>]</span>
    <span class=k>for</span> <span class=n>kk</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>N</span> <span class=o>-</span> <span class=n>M</span><span class=p>,</span> <span class=n>N</span> <span class=o>-</span> <span class=mi>1</span><span class=p>):</span>
        <span class=n>y</span> <span class=o>=</span> <span class=p>(</span><span class=n>mt</span><span class=p>[</span><span class=n>kk</span><span class=p>]</span> <span class=o>&amp;</span> <span class=n>UPPER_MASK</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>mt</span><span class=p>[</span><span class=n>kk</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>&amp;</span> <span class=n>LOWER_MASK</span><span class=p>)</span>
        <span class=n>mt</span><span class=p>[</span><span class=n>kk</span><span class=p>]</span> <span class=o>=</span> <span class=n>mt</span><span class=p>[</span><span class=n>kk</span> <span class=o>+</span> <span class=p>(</span><span class=n>M</span> <span class=o>-</span> <span class=n>N</span><span class=p>)]</span> <span class=o>^</span> <span class=n>rshift</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>^</span> <span class=n>mag01</span><span class=p>[</span><span class=n>y</span> <span class=o>&amp;</span> <span class=mh>0x1</span><span class=p>]</span>
    <span class=n>y</span> <span class=o>=</span> <span class=p>(</span><span class=n>mt</span><span class=p>[</span><span class=n>N</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>&amp;</span> <span class=n>UPPER_MASK</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>mt</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&amp;</span> <span class=n>LOWER_MASK</span><span class=p>)</span>
    <span class=n>mt</span><span class=p>[</span><span class=n>N</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>mt</span><span class=p>[</span><span class=n>M</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>^</span> <span class=n>rshift</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>^</span> <span class=n>mag01</span><span class=p>[</span><span class=n>y</span> <span class=o>&amp;</span> <span class=mh>0x1</span><span class=p>]</span>
    <span class=k>return</span> <span class=n>mt</span>
</pre></div> <h2 id=sinh-so-ngau-nhien-tu-state>Sinh số ngẫu nhiên từ state<a class=headerlink href=#sinh-so-ngau-nhien-tu-state title="Permanent link">&para;</a></h2> <p>Mỗi số ngẫu nhiên sẽ được sinh ra từ một phần tử của state bằng các phép toán khá phức tạp như sau:</p> <div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>tampering</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
    <span class=n>y</span> <span class=o>=</span> <span class=n>value</span> <span class=o>^</span> <span class=n>rshift</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=mi>11</span><span class=p>)</span>
    <span class=n>y</span> <span class=o>^=</span> <span class=p>(</span><span class=n>y</span> <span class=o>&lt;&lt;</span> <span class=mi>7</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x9d2c5680</span>
    <span class=n>y</span> <span class=o>^=</span> <span class=p>(</span><span class=n>y</span> <span class=o>&lt;&lt;</span> <span class=mi>15</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xefc60000</span>
    <span class=n>y</span> <span class=o>^=</span> <span class=n>rshift</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=mi>18</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>y</span>
</pre></div> <h2 id=khoi-phuc-state>Khôi phục state<a class=headerlink href=#khoi-phuc-state title="Permanent link">&para;</a></h2> <p>Bây giờ là công việc khó khăn nhất, cũng là chìa khóa để giải bài toán này. Tìm state từ số ngẫu nhiên đã biết. Thông thường, công việc có hai chiều như thế này thì một chiều lúc nào cũng dễ, chiều còn lại sẽ có hơn nhiều. Có state lấy ra số ngẫu nhiên thì dễ, chứ có số rồi tìm ra state thật là khó như lên trời vậy. Thực ra, cách làm ngu si nhất ở đây là brute force. Mỗi số trong state là 32 bit nên chỉ có <code>2 ^ 32 = 4294967296</code> số khác nhau thôi, nên nếu không có cách nào khác thì đành thử hết tất cả các trường hợp vậy.</p> <p>Tuy nhiên, chúng ta có cách làm khác. Ví dụ với phép toán cuối cùng:</p> <div class=codehilite><pre><span></span>y ^= rshift(y, 18)
</pre></div> <p>Chúng ta sẽ nhìn kỹ hơn vào các bit:</p> <div class=codehilite><pre><span></span>101101110101111001 11111001110010                    y
000000000000000000 10110111010111100111111001110010  rshift(y, 18)
101101110101111001 01001110100101                    y ^ rshift(y, 18)
</pre></div> <p>Ở ví dụ trên, tôi đã ngăn cách 18 ký tự đầu với phần còn lại. Chúng ta dễ dàng nhận ra rằng, 18 bit đầu tiên của <code>y</code> vẫn còn nguyên sau phép toán đó. Chúng ta có thể dễ dàng lấy ra 18 bit này. Và 18 bit này lại được dịch sang phần tiếp theo, và chúng ta có thể dễ dàng XOR nó với kết quả để lấy ra giá trị ban đầu. Một thuật toán tổng quát để dịch ngược quá trình này như sau:</p> <div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>unshift_right</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>shift</span><span class=p>):</span>
    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>while</span> <span class=n>i</span> <span class=o>*</span> <span class=n>shift</span> <span class=o>&lt;</span> <span class=mi>32</span><span class=p>:</span>
        <span class=n>part_mask</span> <span class=o>=</span> <span class=n>rshift</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=mi>32</span> <span class=o>-</span> <span class=n>shift</span><span class=p>),</span> <span class=n>shift</span> <span class=o>*</span> <span class=n>i</span><span class=p>)</span>
        <span class=n>part</span> <span class=o>=</span> <span class=n>value</span> <span class=o>&amp;</span> <span class=n>part_mask</span>
        <span class=n>value</span> <span class=o>^=</span> <span class=n>part</span> <span class=o>&gt;&gt;</span> <span class=n>shift</span>
        <span class=n>result</span> <span class=o>|=</span> <span class=n>part</span>
        <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
    <span class=k>return</span> <span class=n>result</span>
</pre></div> <p>Phương pháp tương tự cũng có thể được sử dụng với phép dịch bit sang trái trong phép tampering ở trên:</p> <div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>unshift_left</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>shift</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>while</span> <span class=n>i</span> <span class=o>*</span> <span class=n>shift</span> <span class=o>&lt;</span> <span class=mi>32</span><span class=p>:</span>
        <span class=n>part_mask</span> <span class=o>=</span> <span class=n>rshift</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>(</span><span class=mi>32</span> <span class=o>-</span> <span class=n>shift</span><span class=p>))</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>shift</span> <span class=o>*</span> <span class=n>i</span><span class=p>)</span>
        <span class=n>part</span> <span class=o>=</span> <span class=n>value</span> <span class=o>&amp;</span> <span class=n>part_mask</span>
        <span class=n>value</span> <span class=o>^=</span> <span class=p>(</span><span class=n>part</span> <span class=o>&lt;&lt;</span> <span class=n>shift</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask</span>
        <span class=n>result</span> <span class=o>|=</span> <span class=n>part</span>
        <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
    <span class=k>return</span> <span class=n>result</span>
</pre></div> <p>Và cả quá trình khôi phục state sẽ như sau:</p> <div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>untampering</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
    <span class=n>x</span> <span class=o>=</span> <span class=n>unshift_right</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=mi>18</span><span class=p>)</span>
    <span class=n>x</span> <span class=o>=</span> <span class=n>unshift_left</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mh>0xefc60000</span><span class=p>)</span>
    <span class=n>x</span> <span class=o>=</span> <span class=n>unshift_left</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mh>0x9d2c5680</span><span class=p>)</span>
    <span class=n>x</span> <span class=o>=</span> <span class=n>unshift_right</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=mi>11</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>x</span>
</pre></div> <p>Công việc khó khăn nhất đã có lời giải, quay trở lại bài toán của chúng ta, chúng ta cần lấy ra state 624 số ban đầu sau khi được khởi tạo.</p> <h1 id=tim-flag-cho-bai-toan-ua-ra>Tìm flag cho bài toán đưa ra<a class=headerlink href=#tim-flag-cho-bai-toan-ua-ra title="Permanent link">&para;</a></h1> <p>Quay lại bài CTF của chúng ta. Bây giờ, chúng ta cần lấy ra 624 số được sinh ngẫu nhiên đầu tiên.</p> <div class=codehilite><pre><span></span><span class=n>firsts</span> <span class=o>=</span> <span class=p>[]</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;impossibru.png&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>fp</span><span class=p>,</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;impossibru.enc&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>fc</span><span class=p>:</span>
    <span class=n>fc</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>624</span><span class=p>):</span>
        <span class=n>x</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;I&#39;</span><span class=p>,</span> <span class=n>fp</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>4</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>y</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;I&#39;</span><span class=p>,</span> <span class=n>fc</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>4</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>firsts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>x</span> <span class=o>^</span> <span class=n>y</span><span class=p>)</span>
</pre></div> <p>Sau đó là khôi phục state từ các số này:</p> <div class=codehilite><pre><span></span><span class=n>mt</span> <span class=o>=</span> <span class=p>[</span><span class=n>untampering</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>firsts</span><span class=p>]</span>
</pre></div> <p>Bây giờ đã có state đầu tiên, công việc của chúng ta chỉ còn là sinh các số ngẫu nhiên cho 2 file gợi ý và flag nữa thôi, chúng ta chỉ cần lưu lại các số được sinh ra flag là đủ:</p> <div class=codehilite><pre><span></span><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;impossibru.enc&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>fhint</span><span class=p>,</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;flag.enc&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>fflag</span><span class=p>:</span>
    <span class=n>hint_length_in_bytes</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;I&#39;</span><span class=p>,</span> <span class=n>fhint</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>4</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span>
    <span class=n>flag_length_in_bytes</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;I&#39;</span><span class=p>,</span> <span class=n>fflag</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>4</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span>
<span class=n>hint_length</span> <span class=o>=</span> <span class=p>(</span><span class=n>hint_length_in_bytes</span> <span class=o>+</span> <span class=mi>3</span><span class=p>)</span> <span class=o>//</span> <span class=mi>4</span>
<span class=n>flag_length</span> <span class=o>=</span> <span class=p>(</span><span class=n>flag_length_in_bytes</span> <span class=o>+</span> <span class=mi>3</span><span class=p>)</span> <span class=o>//</span> <span class=mi>4</span>

<span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>hint_length</span> <span class=o>//</span> <span class=n>N</span> <span class=o>-</span> <span class=mi>1</span><span class=p>):</span>
    <span class=n>mt</span> <span class=o>=</span> <span class=n>next_state</span><span class=p>(</span><span class=n>mt</span><span class=p>)</span>
<span class=n>mt</span> <span class=o>=</span> <span class=n>next_state</span><span class=p>(</span><span class=n>mt</span><span class=p>)</span>
<span class=n>keys</span> <span class=o>=</span> <span class=p>[</span><span class=n>tampering</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>mt</span><span class=p>[</span><span class=n>hint_length</span> <span class=o>%</span> <span class=n>N</span><span class=p>:]]</span>
<span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>flag_length</span> <span class=o>//</span> <span class=n>N</span><span class=p>):</span>
    <span class=n>mt</span> <span class=o>=</span> <span class=n>next_state</span><span class=p>(</span><span class=n>mt</span><span class=p>)</span>
    <span class=n>keys</span> <span class=o>+=</span> <span class=p>[</span><span class=n>tampering</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>mt</span><span class=p>]</span>
</pre></div> <p>Với key thu được, chúng ta có thể ghi ra file rồi lợi dùng hàm decrypt đề bài cung cấp để giải mã. Tuy nhiên, ở đây đang tiện code Python nên chúng ta có thể tiếp tục:</p> <div class=codehilite><pre><span></span><span class=n>ciphers</span> <span class=o>=</span> <span class=p>[]</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;flag.enc&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
    <span class=n>buffer</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
    <span class=k>while</span> <span class=n>buffer</span> <span class=o>!=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>:</span>
        <span class=n>buffer</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>4</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>buffer</span><span class=p>))</span> <span class=o>+</span> <span class=n>buffer</span>
        <span class=n>ciphers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;I&#39;</span><span class=p>,</span> <span class=n>buffer</span><span class=p>)[</span><span class=mi>0</span><span class=p>])</span>
        <span class=n>buffer</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;flag.jpg&#39;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=k>for</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>ciphers</span><span class=p>,</span> <span class=n>keys</span><span class=p>):</span>
        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;I&#39;</span><span class=p>,</span> <span class=n>x</span> <span class=o>^</span> <span class=n>y</span><span class=p>))</span>
</pre></div> <p>Và cuối cùng là thành quả của chúng ta:</p> <p><img alt=flag src=https://i.imgur.com/qiOtnNE.jpg></p> <h1 id=ket-luan>Kết luận<a class=headerlink href=#ket-luan title="Permanent link">&para;</a></h1> <p>Thực sự việc sinh số ngẫu nhiên là có thể đoán trước được, và kể cả mã hóa one-time pad cũng không thực sự là an toàn. Tuy nhiên, việc này hoàn toàn là do sự bất cẩn của lập trình viên chứ bản thân thuật toán không có vấn đề gì. Trong bài toán của chúng ta, vì đây là một bài CTF nên có gợi ý chứ bình thường, không dễ dàng gì chúng ta có thể lấy ra được các số ngẫu nhiên để khôi phục state. Vì vậy, cũng không nên quá lo lắng về khả năng bị giải mã của cách mã hóa này.</p> <p>P.S. Mời các bạn thử sức với <a href=http://ksnctf.sweetduet.info/problem/21>một bài CTF tương tự</a>.</p> </div> <div class=post-footer> <div class=tags> <i class="fa fa-tags"></i> <span>#Security</span> <span>#Cryptography</span> <span>#CTF</span> <span>#PRNG</span> <span>#Mersenne Twister</span> <span>#crack</span> </div> </div> </div><div class=blog-pager> <span class=newer-link> <a href=/2016/Jul/14/keep-gulp-running-with-gulp-plumber.html> Newer Post </a> </span> <span class=older-link> <a href=/2016/May/12/using-amd-and-requirejs-to-modularize-large-javascript-project.html> Older Post </a> </span> </div><div class=comments> <div class=finally> <p><em>I apologise for any typos. If you notice a problem, please let me know.</em> <p>Thank you all for your attention. </div> <div id=disqus_thread></div> <script src=/theme/js/disqus.min.js?81e8a5f5></script> <noscript> Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript> comments powered by Disqus. </a> </noscript> </div></div> </div> </div> <div class=sidebar-wrapper> <div class=widget> <h2>Welcome</h2> <div> <img src=/theme/images/banner.gif alt=Welcome> </div> </div><div class="widget recent-posts"> <h2>Recent Posts</h2> <ul> <li> <a href=/2019/May/20/elasticsearch-data-organization.html> <img alt="Elasticsearch: Data organization" src=https://i.imgur.com/JT4y7Qf.jpg> </a> <a href=/2019/May/20/elasticsearch-data-organization.html>Elasticsearch: Data organization</a> <li> <a href=/2019/May/20/elasticsearch-intro.html> <img alt="Elasticsearch: Intro" src=https://i.imgur.com/JT4y7Qf.jpg> </a> <a href=/2019/May/20/elasticsearch-intro.html>Elasticsearch: Intro</a> <li> <a href=/2019/Apr/20/javascript-popups.html> <img alt="JavaScript: Popups" src=https://i.imgur.com/FxmcwPy.png> </a> <a href=/2019/Apr/20/javascript-popups.html>JavaScript: Popups</a> <li> <a href=/2019/Mar/20/javascript-iterator-and-generator.html> <img alt="JavaScript: Iterator and generator" src=https://i.imgur.com/lev8iT9.jpg> </a> <a href=/2019/Mar/20/javascript-iterator-and-generator.html>JavaScript: Iterator and generator</a> <li> <a href=/2019/Feb/20/javascript-decorator.html> <img alt="JavaScript decorator" src=https://i.imgur.com/Sh3yLI0.png> </a> <a href=/2019/Feb/20/javascript-decorator.html>JavaScript decorator</a> </ul> </div><div class="widget labels"> <h2>Blog Archive</h2> <ul> <li> <a href=/2019/ > 2019 </a> <li> <a href=/2018/ > 2018 </a> <li> <a href=/2017/ > 2017 </a> <li> <a href=/2016/ > 2016 </a> <li> <a href=/2015/ > 2015 </a> <li> <a href=/2014/ > 2014 </a> <li> <a href=/2013/ > 2013 </a> <li> <a href=/2012/ > 2012 </a> <li> <a href=/2011/ > 2011 </a> <li> <a href=/2010/ > 2010 </a> </ul> </div><div class=widget> <h2>Twitter timeline</h2> <a class=twitter-timeline data-height=500 data-dnt=true data-theme=light href=https://twitter.com/_naa_4f data-chrome="noheader nofooter transparent noborders"> Tweets by manhhomienbienthuy </a> </div> </div> </div> <a href=# class="smooth-scroll back-to-top"> <i class="fa fa-arrow-circle-up fa-3x"></i> </a> </main> <footer> <div class=infos> <div class=wrapper> <div class=widget> <a href=/ title="manhhomienbienthuy's space" class=logo> <img alt="manhhomienbienthuy's space" src=/theme/images/logo_white.png> </a> <span class=right>I'm a hacker, enter my world...</span> </div><div class=widget> <p> Created with all my ♥ and soul, dedicated to my love, yunachan <p> Powered by <a href=http://blog.getpelican.com/ target=_blank>Pelican</a>, which takes great advantage of <a href=https://www.python.org/ target=_blank>Python</a> <p> This site content is licensed under a <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank> CC BY-NC-ND 4.0 </a> License. <p> Updated at <a target=_blank href="http://www.timeanddate.com/worldclock/fixedtime.html?iso=2019-06-20T02:42:55"> 2019-06-20 02:42:55 </a> </div><div class=widget> <p> Hosting by <a href=https://manhhomienbienthuy.bitbucket.io/ >Bitbucket</a> and <a href=https://manhhomienbienthuy.github.io/ >Github</a>, image hosting by <a href=https://manhhomienbienthuy.imgur.com/ target=_blank>imgur</a>, <a href=https://instagram.com/manhhomienbienthuy/ target=_blank>Instagram</a> and <a href=https://photos.google.com/ target=_blank>Google Photo</a> <p> Theme based on <a href=https://vanice-veethemes.blogspot.com/ target=_blank>Vanice theme</a>, icons from <a href=https://fontawesome.com/ target=_blank>Font Awesome</a>, comments powered by <a href=https://disqus.com/home/forums/manhhomienbienthuy/ target=_blank>Disqus</a> </div> </div> </div> <div class=credits> <div class=wrapper> <div class=left> <!--
          Regarding copyright, in general, standalone pages (as
          opposed to files generated as part of manuals) on the GNU
          web server should be under CC BY-ND 4.0.  Please do NOT
          change or remove this without talking with the webmasters or
          licensing team first.  Please make sure the copyright date
          is consistent with the document.  For web pages, it is ok to
          list just the latest year the document was modified, or
          published.

          If you wish to list earlier years, that is ok too.  Either
          "2001, 2002, 2003" or "2001-2003" are ok for specifying
          years, as long as each year in the range is in fact a
          copyrightable year, i.e., a year in which the document was
          published (including being publicly visible on the web or in
          a revision control system).
        --> Copyright © 2010-2019 <a href=/pages/about-me.html><strong>manhhomienbienthuy</strong></a>. All rights reserved. </div> <div class=right> <ul> <li><a href=/ >Home</a> <li><a href=/pages/about-me.html>About</a> <li><a href=# class=smooth-scroll>Top ↑</a> </ul> </div> </div> </div></footer> <script src=https://code.jquery.com/jquery-3.2.1.js></script> <script src=//cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js></script> <script src=//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.2/imagesloaded.pkgd.min.js></script> <script src=/theme/js/vpyeu.min.js?d72c87bd></script> <script id=dsq-count-scr src=https://manhhomienbienthuy.disqus.com/count.js async></script>