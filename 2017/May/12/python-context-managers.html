<!DOCTYPE html><title>Python context managers - manhhomienbienthuy's space</title> <meta charset=utf-8> <meta name=viewport content="width=device-width, initial-scale=1"> <link rel=apple-touch-icon href=/theme/images/icon-touch.png> <link rel=icon sizes=192x192 href=/theme/images/icon-touch.png> <link rel="shortcut icon" href=/theme/images/favicon.ico> <link rel=author href=/humans.txt> <meta name=msapplication-TileImage content=/theme/images/icon-tile.png> <meta name=twitter:dnt content=on> <meta name=Author content=manhhomienbienthuy> <meta name=rating content=general> <meta name=twitter:card content=product> <meta name=twitter:site content=@_naa_4f> <meta name=twitter:creator content=@_naa_4f> <link href=/feeds/all.atom.xml type=application/atom+xml rel=alternate title="manhhomienbienthuy's space Full Atom Feed"> <meta name=description content="Trong Python, context manager là một phương thức cho phép bạn cấp phát và sử dụng tài nguyên một cách hiệu quả. Context manager được sử dụng rộng rãi thông qua câu lệnh with. Ví dụ: with open('foo', 'w') as f: f.write('Hora! We opened this file') Đoạn …"> <meta name=keywords content="Python, context manager, fundamental, programming, blog, naa, manhhomienbienthuy, pelican, static site generator"> <meta name=twitter:title content="Python context managers - manhhomienbienthuy's space"> <meta name=twitter:description content="Trong Python, context manager là một phương thức cho phép bạn cấp phát và sử dụng tài nguyên một cách hiệu quả. Context manager được sử dụng rộng rãi thông qua câu lệnh with. Ví dụ: with open('foo', 'w') as f: f.write('Hora! We opened this file') Đoạn …"> <meta name=twitter:image content=/https://i.imgur.com/nI0FtXN.png> <link rel=stylesheet href=//cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css> <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.0.0/css/font-awesome.min.css> <link rel=stylesheet href=/theme/css/vpyeu.min.css?5d2c7d5e> <header> <div class=navbar> <div class=wrapper> <div class=nav-menu> <div class=menu-toggle> <i class="fa fa-reorder"></i> </div> <ul class=menus> <li><a href=/ >Home</a> <li><a href=/category/general.html> General <li><a href=/category/life.html> Life <li><a href=/category/programming.html class=current> Programming <li><a href=/category/travel.html> Travel </ul> </div><div class="right links"> <ul> <li> <a href=https://twitter.com/_naa_4f target=_blank> <i class="fa fa-twitter"></i> </a> <li> <a href=https://instagram.com/manhhomienbienthuy/ target=_blank> <i class="fa fa-instagram"></i> </a> <li> <a href=https://www.facebook.com/manhhomienbienthuy target=_blank> <i class="fa fa-facebook"></i> </a> <li> <a href=https://github.com/manhhomienbienthuy target=_blank> <i class="fa fa-github"></i> </a> <li> <a href=/feeds/all.atom.xml target=_blank> <i class="fa fa-rss"></i> </a> </ul> </div> </div> </div><noscript> <div class="warning head-warn"> <div class=wrapper> <p><strong>Notice:</strong> While JavaScript is not essential for this website, your interaction with the content will be limited. Please turn JavaScript on for the full experience. </div> </div> </noscript><div class=banner> <div class=wrapper> <a href=/ > <img alt="manhhomienbienthuy's space" src=/theme/images/logo.png> </a> </div> </div></header> <main> <div class=wrapper> <div class=main-wrapper> <div class=entry> <div class=entry-detail> <div class=post> <h1 class=title> Python context managers </h1> <div class=meta> Posted in <a href=/category/programming.html>Programming</a> on May 12, 2017 by <a href=/pages/about-me.html>manhhomienbienthuy</a> <span class=right> <i class="fa fa-comments"></i> <a href=#disqus_thread data-disqus-identifier=/2017/May/12/python-context-managers.html> Comments </a> </span> </div> <div class=post-body> <img src=https://i.imgur.com/nI0FtXN.png alt="Python context managers"> <p>Trong Python, context manager là một phương thức cho phép bạn cấp phát và sử dụng tài nguyên một cách hiệu quả. Context manager được sử dụng rộng rãi thông qua câu lệnh <code>with</code>. Ví dụ:</p> <div class=codehilite><pre><span></span><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;Hora! We opened this file&#39;</span><span class=p>)</span>
</pre></div> <p>Đoạn code trên mở một file, ghi dữ liệu và đóng file lại. Nếu có bất kỳ lỗi gì xảy ra, thì file cũng luôn luôn được đảm bảo là đã đóng. Đoạn code trên nếu viết mà không sử dụng context manager thì sẽ trông như dưới đây:</p> <div class=codehilite><pre><span></span><span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span>
<span class=k>try</span><span class=p>:</span>
    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;Hora! We opened this file&#39;</span><span class=p>)</span>
<span class=k>finally</span><span class=p>:</span>
    <span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</pre></div> <p>So sánh hai cách viết này thì chúng ta đã thấy rất rõ ràng rằng, context manager cho chúng ta cách viết code ngắn gọn hơn hẳn. Lệnh <code>with</code> cho chúng ta bảo đảm rằng file luôn luôn được đóng mà không cần biết những logic xử lý bên trong.</p> <p>Hẳn là các bạn đã rất quen thuộc với những đoạn code trên, đặc biệt khi bạn đã từng nghe nói đến "<a href=https://jeffknupp.com/writing-idiomatic-python-ebook/ >Idiomatic Python</a>". Nhưng liệu bạn đã chắc chắn hiểu được cách làm việc chính xác với file và lý do tại sao đó lại là cách đúng không? Hoặc đơn giản hơn, bạn có biết khi nào thì mình đã thao tác sai không.</p> <p>Nếu câu trả lời là <strong>không</strong>, thì bài viết này chính là dành cho bạn.</p> <p>Context manager thường được sử dụng để lock các tài nguyên (trường hợp mở và đóng file là một ví dụ kinh điển cho việc này).</p> <h1 id=quan-ly-tai-nguyen>Quản lý tài nguyên<a class=headerlink href=#quan-ly-tai-nguyen title="Permanent link">&para;</a></h1> <p>Tính năng quan trọng nhất và cũng là phổ biến nhất của context manager là để <a href=https://en.wikipedia.org/wiki/Resource_management_(computing)>quản lý tài nguyên</a> một cách chính xác. Quay lại với việc đọc và ghi file ở ví dụ trên, tại sao chúng ta phải sử dụng context manager. Mỗi khi mở một file để đọc hoặc ghi, một tài nguyên của hệ thống, trong trường hợp này là <a href=https://en.wikipedia.org/wiki/File_descriptor>file descriptor</a> sẽ đã bị tiêu tốn để chúng ta có thể thao tác. Thật không may là tài nguyên này lại là hữu hạn. Mỗi hệ điều hành đều có giới hạn nhất định cho số lượng file có thể mở cùng một lúc.</p> <p>Không tin ư, bạn hãy xem ví dụ sau:</p> <div class=codehilite><pre><span></span><span class=o>&gt;&gt;&gt;</span> <span class=n>files</span> <span class=o>=</span> <span class=p>[]</span>
<span class=o>&gt;&gt;&gt;</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10000</span><span class=p>):</span>
<span class=o>...</span>     <span class=n>files</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>))</span>
<span class=o>...</span>
<span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
  <span class=n>File</span> <span class=s2>&quot;&lt;stdin&gt;&quot;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>2</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
<span class=ne>OSError</span><span class=p>:</span> <span class=p>[</span><span class=n>Errno</span> <span class=mi>24</span><span class=p>]</span> <span class=n>Too</span> <span class=n>many</span> <span class=nb>open</span> <span class=n>files</span><span class=p>:</span> <span class=s1>&#39;foo&#39;</span>
</pre></div> <p>Ngoài lề một chút, file descriptor thực chất là một số nguyên. Khi bạn mở một file, hệ điều hành sẽ tạo ra một entry (có thể ở kernel) lưu trữ những thông tin liên quan đến file được mở. Mỗi entry sẽ được gán với 1 số nguyên (và số này sẽ là duy nhất), cho phép người dùng thông qua đó để thao tác với file.</p> <p>Thực chất người dùng đang thao tác một cách gián tiếp thông qua file descriptor (và thông qua entry của kernel) với các dữ liệu thật sự được ghi ở bộ nhớ ngoài. Việc này mang lại nhiều lợi ích như có thể chia sẻ file cho nhiều tiến trình khác nhau cũng như duy trì bảo mật cho các file đó.</p> <p>Thực ra, hằng ngày bạn đều đang làm việc với file descriptor mà có thể bạn cũng không nhận ra. Hệ điều hành đã gán sẵn một số file descriptor như <code>0</code> cho <a href=http://www.linfo.org/standard_input.html>bàn phím</a>, <code>1</code> cho <a href=http://www.linfo.org/standard_output.html>màn hình</a>, v.v... Và mọi thao tác chúng ta làm với máy tính đều thông qua các file descriptor này. Bạn nghĩ sao về việc <a href=http://linuxcommand.org/lts0060.php>chuyển hướng</a> của câu lệnh Linux như thế này:</p> <div class=codehilite><pre><span></span><span class=gp>$</span> sort &lt; file_list &gt; sorted_file_list <span class=m>2</span>&gt;<span class=p>&amp;</span><span class=m>1</span>
</pre></div> <p>Tương tự như vậy, khi bạn mở một socket, một socket descriptor cũng sẽ được sử dụng.</p> <p>Quay trở lại với nội dung của bài viết. Vậy điều gì xảy khi code Python của bạn mở file mà không đóng nó lại. Rất hiển nhiên, chúng ta đã mất một file descriptor mà chúng ta sẽ không bao giờ cần đến nó nữa. Điều này đồng nghĩa với việc, số file chúng ta có thể thao tác sẽ ít dần đi, do số lượng của chúng bị giới hạn. Mà việc "quên" không đóng file nhiều khi xảy ra khá thường xuyên, và tích tiểu thành đại, đến một lúc nào đó bạn không thể mở thêm file nào nữa.</p> <blockquote> <p>Bạn có thể dùng lệnh <code>ulimit -n</code> để kiểm tra xem hệ thống của mình cho phép mở tối đa bao nhiêu file cùng lúc.</p> </blockquote> <p>Tất nhiên là mọi vấn đề đều có thể giải quyết được. Vẫn với ví dụ trên, chúng ta có thể xử lý bằng cách đóng từng file một như sau:</p> <div class=codehilite><pre><span></span><span class=o>&gt;&gt;&gt;</span> <span class=n>files</span> <span class=o>=</span> <span class=p>[]</span>
<span class=o>&gt;&gt;&gt;</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10000</span><span class=p>):</span>
<span class=o>...</span>     <span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span>
<span class=o>...</span>     <span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<span class=o>...</span>     <span class=n>files</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
<span class=o>...</span>
<span class=o>&gt;&gt;&gt;</span>
</pre></div> <h1 id=quan-ly-tai-nguyen-hieu-qua-hon>Quản lý tài nguyên hiệu quả hơn<a class=headerlink href=#quan-ly-tai-nguyen-hieu-qua-hon title="Permanent link">&para;</a></h1> <p>Trên đây là một cách giải quyết tuy vẫn hoạt động tốt nhưng không được thông minh cho lắm. Trong những hệ thống phức tạp hơn, rất khó để đảm bảo rằng tất cả các file đã được đóng lại khi không dùng đến nữa.</p> <p>Giả sử trong quá trình thao tác, chúng ta gặp phải một <a href=https://docs.python.org/3/tutorial/errors.html>exception</a> nào đó thì phải làm thế nào đây. Bắt exception và xử lý riêng sao? Phải bắt những exception nào mới thì gọi là đủ?</p> <p>Hoặc kể cả không có exception nhưng hàm đã <code>return</code> trước khi file kịp close thì sao? Trong những trường hợp phức tạp như vậy, làm thế nào để chúng ta "nhớ" phải đóng file lại. Câu trả lời là khó tới gần như không thể (thật phũ phàng).</p> <p>Trong nhiều ngôn ngữ, lập trình viên cần phải sử dụng cấu trúc kiểu như <code>try ... except ... finally ...</code> để đảm bảo rằng file sẽ được đóng. Rất may mắn, Python đã nghĩ đến những khó khăn này của chúng ta và đưa cho chúng ta một phương thức dễ dàng để làm những việc đó - context manager.</p> <p>Nói một cách ngắn gọn, chúng ta cần một phương thức càng đơn giản càng tốt để đảm bảo các tài nguyên được dọn dẹp cẩn thận dù có xảy ra bất cứ chuyện gì đi chăng nữa. Và context manager sẽ cung cấp cho chúng ta tính năng này:</p> <div class=codehilite><pre><span></span><span class=k>with</span> <span class=n>something_that_returns_a_context_manager</span><span class=p>()</span> <span class=k>as</span> <span class=n>my_resource</span><span class=p>:</span>
    <span class=n>do_something</span><span class=p>(</span><span class=n>my_resource</span><span class=p>)</span>
    <span class=o>...</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;done using my_resource&#39;</span><span class=p>)</span>
</pre></div> <p>Đơn giản vậy đó. Bằng cách sử dụng <a href=https://www.python.org/dev/peps/pep-0343/ ><code>with</code></a>, chúng ta sẽ đưa mọi thứ vào trong một context manager. Chúng ta gán context manager này cho một biến, và biến đó chỉ tồn tại khi block sau đó được thực thi. Điều này giống như chúng ta tạo một hàm, nó sẽ gọi một số thao tác và khi kết thúc, nó sẽ tự dọn dẹp những gì nó tạo ra.</p> <h1 id=mot-so-context-manager-huu-ich-khac>Một số context manager hữu ích khác<a class=headerlink href=#mot-so-context-manager-huu-ich-khac title="Permanent link">&para;</a></h1> <p>Context manager thực sự rất cần thiết trong Python, và nó đã có mặt trong thư việc chuẩn. Một số context manager có thể bạn đã từng làm việc là <a href=https://docs.python.org/3/library/zipfile.html#zipfile-objects><code>zipfile.ZipFiles</code></a>, <a href=https://docs.python.org/3/library/subprocess.html#subprocess.Popen><code>subprocess.Popen</code></a>, <a href=https://docs.python.org/3/library/tarfile.html#tarfile.TarFile><code>tarfile.TarFile</code></a>, <a href=https://docs.python.org/3/library/telnetlib.html#telnetlib.Telnet><code>telnetlib.Telnet</code></a>, <a href=https://docs.python.org/3/library/pathlib.html><code>pathlib.Path</code></a>, v.v... Thậm chí, <a href=https://docs.python.org/3/library/threading.html#lock-objects><code>Lock</code></a> của <a href=https://docs.python.org/3/library/threading.html><code>threading</code></a> cũng là context manager. Trên thực tế, tất cả những tài nguyên mà chúng ta cần <code>close</code> sau khi sử dụng đều (và rất nên) là context manager.</p> <p>Việc sử dụng <code>Lock</code> tương đối đặc biệt một chút. Trong trường hợp này, tài nguyên là một <a href=https://en.wikipedia.org/wiki/Mutual_exclusion>mutex</a>. Sử dụng context manager sẽ phòng tránh được <a href=http://wiki.c2.com/?DeadLock>deadlock</a> trong lập trình <a href=https://en.wikipedia.org/wiki/Multithreading_(computer_architecture)>multithread</a> nếu chúng ta sử dụng khóa mà không bao giờ mở nó. Hãy xem xét ví dụ sau:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>threading</span> <span class=kn>import</span> <span class=n>Lock</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>lock</span> <span class=o>=</span> <span class=n>Lock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>do_something_dangerous</span><span class=p>():</span>
<span class=gp>... </span>    <span class=n>lock</span><span class=o>.</span><span class=n>acquire</span><span class=p>()</span>
<span class=gp>... </span>    <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;OOPS! I forgot this code could raise exceptions&#39;</span><span class=p>)</span>
<span class=gp>... </span>    <span class=n>lock</span><span class=o>.</span><span class=n>release</span><span class=p>()</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>try</span><span class=p>:</span>
<span class=gp>... </span>    <span class=n>do_something_dangerous</span><span class=p>()</span>
<span class=gp>... </span><span class=k>except</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>print</span><span class=p>(</span><span class=s1>&#39;Got an exception&#39;</span><span class=p>)</span>
<span class=gp>...</span>
<span class=go>Got an exception</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>lock</span><span class=o>.</span><span class=n>acquire</span><span class=p>()</span>
</pre></div> <p>Với code trên, rõ ràng là <code>lock.release()</code> sẽ không bao giờ được gọi, và do đó, mọi tiến trình sẽ gặp deadlock và chết cứng ở đó (<code>lock.acquire()</code> sẽ không bao giờ kết thúc). Rất may mắn, với context manager, điều này có thể sửa chữa được:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>threading</span> <span class=kn>import</span> <span class=n>Lock</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>lock</span> <span class=o>=</span> <span class=n>Lock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>do_something_dangerous</span><span class=p>():</span>
<span class=gp>... </span>    <span class=k>with</span> <span class=n>lock</span><span class=p>:</span>
<span class=gp>... </span>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;oops I forgot this code could raise exceptions&#39;</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>try</span><span class=p>:</span>
<span class=gp>... </span>    <span class=n>do_something_dangerous</span><span class=p>()</span>
<span class=gp>... </span><span class=k>except</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>print</span><span class=p>(</span><span class=s1>&#39;Got an exception&#39;</span><span class=p>)</span>
<span class=gp>...</span>
<span class=go>Got an exception</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>lock</span><span class=o>.</span><span class=n>acquire</span><span class=p>()</span>
<span class=go>True</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>print</span><span class=p>(</span><span class=s1>&#39;We can get here&#39;</span><span class=p>)</span>
<span class=go>We can get here</span>
<span class=go>&gt;&gt;&gt;</span>
</pre></div> <p>Trên thực tế, không có cách nào để gây ra deadlock nếu sử dụng context manager. Và đây là điều chúng ta đang cần.</p> <p>Trong phần tiếp theo, chúng ta sẽ tìm hiểu cách cài đặt một context manager, và qua đó, chúng ta sẽ hiểu hơn về cách thức một context manager hoạt động.</p> <h1 id=cai-at-context-manager-nhu-mot-class>Cài đặt context manager như một class<a class=headerlink href=#cai-at-context-manager-nhu-mot-class title="Permanent link">&para;</a></h1> <p>Có nhiều cách khác nhau để cài đặt một context manager. Cách đơn giản nhất là cài đặt một class với hai phương thức vô cùng đặc biệt: <code>__enter__</code> và <code>__exit__</code>. Phương thức <code>__enter__</code> sẽ trả về tài nguyên cần quản lý (ví dụ như file đang được mở) và <code>__exit__</code> sẽ làm việc dọn dẹp hệ thống.</p> <p>Hãy xem xét ví dụ sau về một context manager khi làm việc với file:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>File</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_name</span><span class=p>,</span> <span class=n>method</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>file_obj</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_name</span><span class=p>,</span> <span class=n>method</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>file_obj</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=nb>type</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>traceback</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>file_obj</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<span class=gp>...</span>
<span class=go>&gt;&gt;&gt;</span>
</pre></div> <p>Class trên cũng như nhiều class khác, phương thức <code>__init__</code> để để khởi tạo đối tượng, trong trường hợp này là khởi tạo tên file cần mở cùng với mode (đọc/ghi) của nó. Phương thức <code>__enter__</code> mở file và trả về đối tượng file để thao tác với file đó trong khi <code>__exit__</code> chỉ đơn giản là đóng file lại.</p> <p>Với hai phương thức <code>__enter__</code> và <code>__exit__</code>, chúng ta có thể sử dụng class này cùng với <code>with</code>:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>File</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
<span class=gp>... </span>    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;Hora! We opened this file&#39;</span><span class=p>)</span>
<span class=gp>...</span>
<span class=go>25</span>
</pre></div> <p>Phương thức <code>__exit__</code> bắt buộc phải có 3 tham số. Dưới đây là những gì thực sự xảy ra khi chúng ta gọi context manager:</p> <ul> <li>Câu lệnh <code>with</code> lưu phương thức <code>__exit__</code> của class <code>File</code></li> <li>Câu lệnh này gọi phương thức <code>__enter__</code> của class <code>File</code></li> <li>Phương thức <code>__enter__</code> mở file và trả về object để thao tác với file đó</li> <li>Object được trả về được truyền cho biến <code>f</code></li> <li>Chúng ta thao tác với file bằng cách ghi dữ liệu <code>f.write</code></li> <li>Khi kết thúc block, câu lệnh <code>with</code> gọi phương thức <code>__exit__</code></li> <li>Phương thức <code>__exit__</code> đóng file cho chúng ta</li> </ul> <h1 id=xu-ly-exception>Xử lý exception<a class=headerlink href=#xu-ly-exception title="Permanent link">&para;</a></h1> <p>Trong cài đặt đơn giản trên, chúng ta đã bỏ qua 3 tham số <code>type</code>, <code>value</code>, <code>traceback</code> của phương thức <code>__exit__</code>. Tuy nhiên, trong quá trình thực thi block lệnh ở trên, nếu xảy ra một exception, Python sẽ chuyển những thông tin <code>type</code>, <code>value</code> và <code>traceback</code> của exception này tới phương thức <code>__exit__</code>. Điều đó giúp chúng ta có thể tùy biến phương thức <code>__exit__</code> để xử lý những vấn đề có thể xảy ra trong quá trình thực thi. Trong trường hợp của chúng ta, chúng ta chỉ cần đóng file và không cần quan tâm đến exception này.</p> <p>Nhưng chuyện gì sẽ xảy ra nếu bản thân file object gặp phải một exception? Ví dụ, khi chúng ta thử gọi một phương thức không tồn tại:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>File</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
<span class=gp>... </span>    <span class=n>f</span><span class=o>.</span><span class=n>undefined_function</span><span class=p>(</span><span class=s1>&#39;Oops! I called an unknown method&#39;</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gt>Traceback (most recent call last):</span>
  File <span class=nb>&quot;&lt;stdin&gt;&quot;</span>, line <span class=m>2</span>, in <span class=n>&lt;module&gt;</span>
<span class=gr>AttributeError</span>: <span class=n>&#39;_io.TextIOWrapper&#39; object has no attribute &#39;undefined_function&#39;</span>
</pre></div> <p>Dưới đây là quy trình những gì đã xảy ra khi có lỗi xảy ra:</p> <ul> <li><code>type</code>, <code>value</code>, <code>traceback</code> của lỗi đó được truyền cho <code>__exit__</code></li> <li>Trong phương thức <code>__exit__</code>, chúng ta có thể tùy ý xử lý exception đó</li> <li>Nếu <code>__exit__</code> trả về <code>True</code> thì exception đã được xử lý hoàn toàn.</li> <li>Nếu không, exception sẽ tiếp tục được raise bởi lệnh <code>with</code></li> </ul> <p>Trong trường hợp của chúng ta, phương thức <code>__exit__</code> không trả về bất cứ thứ gì, do đó, lệnh <code>with</code> sẽ raise exception.</p> <p>Chúng ta có thể tạm xử lý exception như sau:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>File</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_name</span><span class=p>,</span> <span class=n>method</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>file_obj</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_name</span><span class=p>,</span> <span class=n>method</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>file_obj</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=nb>type</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>traceback</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>print</span><span class=p>(</span><span class=s2>&quot;Exception has been handled&quot;</span><span class=p>)</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>file_obj</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=bp>True</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>File</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
<span class=gp>... </span>    <span class=n>f</span><span class=o>.</span><span class=n>undefined_function</span><span class=p>()</span>
<span class=gp>...</span>
<span class=go>Exception has been handled</span>
<span class=go>&gt;&gt;&gt;</span>
</pre></div> <p>Phương thức <code>__exit__</code> trả về <code>True</code>, do đó, không có exception nào được raise bởi lệnh <code>with</code>.</p> <p>Có nhiều cách để cài đặt context manager. Trên đây là một cách đơn giản và dễ hiểu nhất. Trong phần tiếp theo, chúng ta sẽ tìm hiểu thêm một số phương pháp cài đặt nữa.</p> <h1 id=su-dung-contextlib-cai-at-context-manager>Sử dụng <code>contextlib</code> cài đặt context manager<a class=headerlink href=#su-dung-contextlib-cai-at-context-manager title="Permanent link">&para;</a></h1> <p>Context manager quả là tiện lợi và hữu ích vô cùng. Do đó, trong thư viện chuẩn của Python có hẳn module <a href=https://docs.python.org/3/library/contextlib.html><code>contextlib</code></a> với rất nhiều công cụ để tạo và làm việc với context manager.</p> <p>Chúng ta có thể cài đặt context manager bằng cách sử dụng <a href=../../../2015/Dec/22/exploring-python-decorators.html>decorator</a> và <a href=../../../2016/Jan/05/python-iterator-generator.html>generator</a>. <code>contextlib</code> cung cấp cho chúng ta decorator <code>@contextmanager</code> để decorate các hàm generator chỉ gọi <a href=https://www.python.org/dev/peps/pep-0255/ ><code>yield</code></a> đúng một lần duy nhất. Với decorator này, tất cả những gì diễn ra trước <code>yield</code> đều được coi là thao tác của phương thức <code>__enter__</code>. Những gì dễn ra sau đó được coi là của phương thức <code>__exit__</code>.</p> <p>Hãy xem xét ví dụ của chúng ta về quản lý file khi dùng <code>contextlib</code>:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
<span class=gp>&gt;&gt;&gt; </span><span class=nd>@contextmanager</span>
<span class=gp>... </span><span class=k>def</span> <span class=nf>open_file</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>mode</span><span class=p>):</span>
<span class=gp>... </span>    <span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>mode</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>yield</span> <span class=n>f</span>
<span class=gp>... </span>    <span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>files</span> <span class=o>=</span> <span class=p>[]</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10000</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>with</span> <span class=n>open_file</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
<span class=gp>... </span>        <span class=n>files</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>files</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>if</span> <span class=ow>not</span> <span class=n>f</span><span class=o>.</span><span class=n>closed</span><span class=p>:</span>
<span class=gp>... </span>        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;not closed&#39;</span><span class=p>)</span>
<span class=gp>...</span>
<span class=go>&gt;&gt;&gt;</span>
</pre></div> <p>Như chúng ta đã thấy, việc cài đặt context manager đã ngắn gọn hơn rất nhiều. Chúng ta chỉ cần mở file, <code>yield</code> đối tượng đó và đóng nó lại. Mọi việc còn lại sẽ do decorator <code>@contextmanager</code> đảm nhiệm.</p> <p>Và ví dụ thực tế cho thấy rằng các file của chúng ta đã được quản lý tốt, tất cả chúng đã được đóng lại đầy đủ. Tuy nhiên, cách thức cài đặt tiện lợi này yêu cầu chúng ta phải có chút hiểu biết về decorator, generator cũng như lệnh <code>yield</code>. Có thể tóm tắt quá trình tạo context manager trên như sau:</p> <ul> <li>Python tìm thấy <code>yield</code>, hàm này là một generator chứ không phải hàm thông thường.</li> <li>Với decorator <code>@contextmanager</code>, hàm <code>open_file</code> sẽ được truyền là tham số cho hàm <code>contextmanager</code>.</li> <li>Hàm <code>contextmanager</code> trả về generator được bọc trong object của <code>GeneratorContextManager</code>.</li> <li>Object <code>GeneratorContextManager</code> được gán cho hàm <code>open_file</code>. Do đó, khi chúng ta gọi hàm này, thực ra chúng ta đang làm việc với object <code>GeneratorContextManager</code>.</li> </ul> <p>Python docs còn <a href=https://docs.python.org/3/library/contextlib.html#contextlib.contextmanager>một ví dụ khác</a> thú vị hơn:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
<span class=gp>&gt;&gt;&gt; </span><span class=nd>@contextmanager</span>
<span class=gp>... </span><span class=k>def</span> <span class=nf>tag</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>print</span><span class=p>(</span><span class=s2>&quot;&lt;</span><span class=si>%s</span><span class=s2>&gt;&quot;</span> <span class=o>%</span> <span class=n>name</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>yield</span>
<span class=gp>... </span>    <span class=k>print</span><span class=p>(</span><span class=s2>&quot;&lt;/</span><span class=si>%s</span><span class=s2>&gt;&quot;</span> <span class=o>%</span> <span class=n>name</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>tag</span><span class=p>(</span><span class=s1>&#39;h1&#39;</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>print</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>)</span>
<span class=gp>...</span>
<span class=go>&lt;h1&gt;</span>
<span class=go>foo</span>
<span class=go>&lt;/h1&gt;</span>
</pre></div> <p>Trong tất cả các trường hợp trên, chúng ta cũng không hề xử lý exception, vì vậy, context manager của chúng ta sẽ hoạt động giống như code đầu tiên.</p> <p>Một công cụ tiện lợi khác của <code>contextlib</code> là <code>ContextDecorator</code>. Nó cho phép chúng ta cài đặt các context manager theo kiểu class. Nhưng với việc kế thừa từ class <code>ContextDecorator</code>, bạn có thể sử dụng context manager với lệnh <code>with</code> thông thường, hoặc sử dụng nó như một decorator dùng để decorate các hàm khác. Chúng ta có thể xem xét ví dụ sau (tương tự như ví dụ tag HTML ở trên):</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>ContextDecorator</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>tag</span><span class=p>(</span><span class=n>ContextDecorator</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;&lt;</span><span class=si>%s</span><span class=s1>&gt;&#39;</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=bp>self</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>exc</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;&lt;/</span><span class=si>%s</span><span class=s1>&gt;&#39;</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=bp>False</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>tag</span><span class=p>(</span><span class=s1>&#39;h1&#39;</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>print</span><span class=p>(</span><span class=s1>&#39;this is not html&#39;</span><span class=p>)</span>
<span class=gp>...</span>
<span class=go>&lt;h1&gt;</span>
<span class=go>this is not html</span>
<span class=go>&lt;/h1&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=nd>@tag</span><span class=p>(</span><span class=s1>&#39;h1&#39;</span><span class=p>)</span>
<span class=gp>... </span><span class=k>def</span> <span class=nf>content</span><span class=p>():</span>
<span class=gp>... </span>    <span class=k>print</span><span class=p>(</span><span class=s1>&#39;this is another non-html content&#39;</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>content</span><span class=p>()</span>
<span class=go>&lt;h1&gt;</span>
<span class=go>this is another non-html content</span>
<span class=go>&lt;/h1&gt;</span>
<span class=go>&gt;&gt;&gt;</span>
</pre></div> <h1 id=ket-luan>Kết luận<a class=headerlink href=#ket-luan title="Permanent link">&para;</a></h1> <p>Bài viết trình bày những hiểu biết của tôi về context manager của Python, cách nó hoạt động và hỗ trợ cho chúng ta trong công việc lập trình. Như các bạn đã thấy, chúng ta có thể làm rất nhiều thứ với context manager. Mục đích cao nhất của nó thì không bao giờ thay đổi: quản lý hiệu quả các tài nguyên.</p> <p>Chúng ta không chỉ có thể dùng context manager mà còn có thể tự cài đặt context manager cho riêng mình. Hãy sử dụng context manager và làm cho cuộc sống dễ chịu hơn.</p> </div> <div class=post-footer> <div class=tags> <i class="fa fa-tags"></i> <span>#Python</span> <span>#context manager</span> <span>#fundamental</span> <span>#programming</span> </div> </div> </div><div class=blog-pager> <span class=newer-link> <a href=/2017/Jun/12/web-developer-security-checklist.html> Newer Post </a> </span> <span class=older-link> <a href=/2017/May/02/algorithm-sprague-grundy-theorem.html> Older Post </a> </span> </div><div class=comments> <div class=finally> <p><em>I apologise for any typos. If you notice a problem, please let me know.</em> <p>Thank you all for your attention. </div> <div id=disqus_thread></div> <script src=/theme/js/disqus.min.js?81e8a5f5></script> <noscript> Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript> comments powered by Disqus. </a> </noscript> </div></div> </div> </div> <div class=sidebar-wrapper> <div class=widget> <h2>Welcome</h2> <div> <img src=/theme/images/banner.gif alt=Welcome> </div> </div><div class="widget recent-posts"> <h2>Recent Posts</h2> <ul> <li> <a href=/2019/May/20/elasticsearch-data-organization.html> <img alt="Elasticsearch: Data organization" src=https://i.imgur.com/JT4y7Qf.jpg> </a> <a href=/2019/May/20/elasticsearch-data-organization.html>Elasticsearch: Data organization</a> <li> <a href=/2019/May/20/elasticsearch-intro.html> <img alt="Elasticsearch: Intro" src=https://i.imgur.com/JT4y7Qf.jpg> </a> <a href=/2019/May/20/elasticsearch-intro.html>Elasticsearch: Intro</a> <li> <a href=/2019/Apr/20/javascript-popups.html> <img alt="JavaScript: Popups" src=https://i.imgur.com/FxmcwPy.png> </a> <a href=/2019/Apr/20/javascript-popups.html>JavaScript: Popups</a> <li> <a href=/2019/Mar/20/javascript-iterator-and-generator.html> <img alt="JavaScript: Iterator and generator" src=https://i.imgur.com/lev8iT9.jpg> </a> <a href=/2019/Mar/20/javascript-iterator-and-generator.html>JavaScript: Iterator and generator</a> <li> <a href=/2019/Feb/20/javascript-decorator.html> <img alt="JavaScript decorator" src=https://i.imgur.com/Sh3yLI0.png> </a> <a href=/2019/Feb/20/javascript-decorator.html>JavaScript decorator</a> </ul> </div><div class="widget labels"> <h2>Blog Archive</h2> <ul> <li> <a href=/2019/ > 2019 </a> <li> <a href=/2018/ > 2018 </a> <li> <a href=/2017/ > 2017 </a> <li> <a href=/2016/ > 2016 </a> <li> <a href=/2015/ > 2015 </a> <li> <a href=/2014/ > 2014 </a> <li> <a href=/2013/ > 2013 </a> <li> <a href=/2012/ > 2012 </a> <li> <a href=/2011/ > 2011 </a> <li> <a href=/2010/ > 2010 </a> </ul> </div><div class=widget> <h2>Twitter timeline</h2> <a class=twitter-timeline data-height=500 data-dnt=true data-theme=light href=https://twitter.com/_naa_4f data-chrome="noheader nofooter transparent noborders"> Tweets by manhhomienbienthuy </a> </div> </div> </div> <a href=# class="smooth-scroll back-to-top"> <i class="fa fa-arrow-circle-up fa-3x"></i> </a> </main> <footer> <div class=infos> <div class=wrapper> <div class=widget> <a href=/ title="manhhomienbienthuy's space" class=logo> <img alt="manhhomienbienthuy's space" src=/theme/images/logo_white.png> </a> <span class=right>I'm a hacker, enter my world...</span> </div><div class=widget> <p> Created with all my ♥ and soul, dedicated to my love, yunachan <p> Powered by <a href=http://blog.getpelican.com/ target=_blank>Pelican</a>, which takes great advantage of <a href=https://www.python.org/ target=_blank>Python</a> <p> This site content is licensed under a <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank> CC BY-NC-ND 4.0 </a> License. <p> Updated at <a target=_blank href="http://www.timeanddate.com/worldclock/fixedtime.html?iso=2019-06-20T02:42:55"> 2019-06-20 02:42:55 </a> </div><div class=widget> <p> Hosting by <a href=https://manhhomienbienthuy.bitbucket.io/ >Bitbucket</a> and <a href=https://manhhomienbienthuy.github.io/ >Github</a>, image hosting by <a href=https://manhhomienbienthuy.imgur.com/ target=_blank>imgur</a>, <a href=https://instagram.com/manhhomienbienthuy/ target=_blank>Instagram</a> and <a href=https://photos.google.com/ target=_blank>Google Photo</a> <p> Theme based on <a href=https://vanice-veethemes.blogspot.com/ target=_blank>Vanice theme</a>, icons from <a href=https://fontawesome.com/ target=_blank>Font Awesome</a>, comments powered by <a href=https://disqus.com/home/forums/manhhomienbienthuy/ target=_blank>Disqus</a> </div> </div> </div> <div class=credits> <div class=wrapper> <div class=left> <!--
          Regarding copyright, in general, standalone pages (as
          opposed to files generated as part of manuals) on the GNU
          web server should be under CC BY-ND 4.0.  Please do NOT
          change or remove this without talking with the webmasters or
          licensing team first.  Please make sure the copyright date
          is consistent with the document.  For web pages, it is ok to
          list just the latest year the document was modified, or
          published.

          If you wish to list earlier years, that is ok too.  Either
          "2001, 2002, 2003" or "2001-2003" are ok for specifying
          years, as long as each year in the range is in fact a
          copyrightable year, i.e., a year in which the document was
          published (including being publicly visible on the web or in
          a revision control system).
        --> Copyright © 2010-2019 <a href=/pages/about-me.html><strong>manhhomienbienthuy</strong></a>. All rights reserved. </div> <div class=right> <ul> <li><a href=/ >Home</a> <li><a href=/pages/about-me.html>About</a> <li><a href=# class=smooth-scroll>Top ↑</a> </ul> </div> </div> </div></footer> <script src=https://code.jquery.com/jquery-3.2.1.js></script> <script src=//cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js></script> <script src=//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.2/imagesloaded.pkgd.min.js></script> <script src=/theme/js/vpyeu.min.js?d72c87bd></script> <script id=dsq-count-scr src=https://manhhomienbienthuy.disqus.com/count.js async></script>