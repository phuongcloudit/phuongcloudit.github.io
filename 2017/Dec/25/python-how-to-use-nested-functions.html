<!DOCTYPE html><title>Python: How to use nested functions - manhhomienbienthuy's space</title> <meta charset=utf-8> <meta name=viewport content="width=device-width, initial-scale=1"> <link rel=apple-touch-icon href=/theme/images/icon-touch.png> <link rel=icon sizes=192x192 href=/theme/images/icon-touch.png> <link rel="shortcut icon" href=/theme/images/favicon.ico> <link rel=author href=/humans.txt> <meta name=msapplication-TileImage content=/theme/images/icon-tile.png> <meta name=twitter:dnt content=on> <meta name=Author content=manhhomienbienthuy> <meta name=rating content=general> <meta name=twitter:card content=product> <meta name=twitter:site content=@_naa_4f> <meta name=twitter:creator content=@_naa_4f> <link href=/feeds/all.atom.xml type=application/atom+xml rel=alternate title="manhhomienbienthuy's space Full Atom Feed"> <meta name=description content="Như chúng ta đã biết, trong Python, hàm cũng là đối tượng, hơn nữa, nó còn là đối tượng first-class. Nhờ đó, chúng ta có thể thao tác với hàm như mọi đối tượng khác. Chúng ta có thể tạo ra hàm, xoá bỏ nó, gán cho biến, truyền làm …"> <meta name=keywords content="Python, fundamentals, function, nested, how-to, blog, naa, manhhomienbienthuy, pelican, static site generator"> <meta name=twitter:title content="Python: How to use nested functions - manhhomienbienthuy's space"> <meta name=twitter:description content="Như chúng ta đã biết, trong Python, hàm cũng là đối tượng, hơn nữa, nó còn là đối tượng first-class. Nhờ đó, chúng ta có thể thao tác với hàm như mọi đối tượng khác. Chúng ta có thể tạo ra hàm, xoá bỏ nó, gán cho biến, truyền làm …"> <meta name=twitter:image content=/https://i.imgur.com/gfjxCe2.png> <link rel=stylesheet href=//cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css> <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.0.0/css/font-awesome.min.css> <link rel=stylesheet href=/theme/css/vpyeu.min.css?5d2c7d5e> <header> <div class=navbar> <div class=wrapper> <div class=nav-menu> <div class=menu-toggle> <i class="fa fa-reorder"></i> </div> <ul class=menus> <li><a href=/ >Home</a> <li><a href=/category/general.html> General <li><a href=/category/life.html> Life <li><a href=/category/programming.html class=current> Programming <li><a href=/category/travel.html> Travel </ul> </div><div class="right links"> <ul> <li> <a href=https://twitter.com/_naa_4f target=_blank> <i class="fa fa-twitter"></i> </a> <li> <a href=https://instagram.com/manhhomienbienthuy/ target=_blank> <i class="fa fa-instagram"></i> </a> <li> <a href=https://www.facebook.com/manhhomienbienthuy target=_blank> <i class="fa fa-facebook"></i> </a> <li> <a href=https://github.com/manhhomienbienthuy target=_blank> <i class="fa fa-github"></i> </a> <li> <a href=/feeds/all.atom.xml target=_blank> <i class="fa fa-rss"></i> </a> </ul> </div> </div> </div><noscript> <div class="warning head-warn"> <div class=wrapper> <p><strong>Notice:</strong> While JavaScript is not essential for this website, your interaction with the content will be limited. Please turn JavaScript on for the full experience. </div> </div> </noscript><div class=banner> <div class=wrapper> <a href=/ > <img alt="manhhomienbienthuy's space" src=/theme/images/logo.png> </a> </div> </div></header> <main> <div class=wrapper> <div class=main-wrapper> <div class=entry> <div class=entry-detail> <div class=post> <h1 class=title> Python: How to use nested functions </h1> <div class=meta> Posted in <a href=/category/programming.html>Programming</a> on December 25, 2017 by <a href=/pages/about-me.html>manhhomienbienthuy</a> <span class=right> <i class="fa fa-comments"></i> <a href=#disqus_thread data-disqus-identifier=/2017/Dec/25/python-how-to-use-nested-functions.html> Comments </a> </span> </div> <div class=post-body> <img src=https://i.imgur.com/gfjxCe2.png alt="Python: How to use nested functions"> <p>Như chúng ta đã biết, trong Python, hàm cũng là đối tượng, hơn nữa, nó còn là đối tượng <a href=http://python-history.blogspot.com/2009/02/first-class-everything.html>first-class</a>. Nhờ đó, chúng ta có thể thao tác với hàm như mọi đối tượng khác. Chúng ta có thể tạo ra hàm, xoá bỏ nó, gán cho biến, truyền làm tham số, v.v...</p> <p>Cũng vì hàm là đối tượng first-class, nên nó có thể được định nghĩa bên trong một hàm khác (hàm lồng nhau). Một ứng dụng của việc này là sử dụng hàm lồng nhau để tạo ra các <a href=../../../2015/Dec/22/exploring-python-decorators.html>decorator</a>.</p> <p>Trong bài viết này, chúng ta sẽ tìm hiểu những ứng dụng khác nữa của việc sử dụng hàm lồng nhau trong Python.</p> <h1 id=on-gian-hoa-thuat-toan>Đơn giản hoá thuật toán<a class=headerlink href=#on-gian-hoa-thuat-toan title="Permanent link">&para;</a></h1> <p>Đây là một trong những ứng dụng quan trọng nhất của chương trình con, và hàm chính là một chương trình con như vậy. Chương trình con nói chung là hàm nói riêng giúp chúng ta lập trình có cấu trúc.</p> <p>Thuật toán để giải các bài toán sẽ trở nên đơn giản hơn do bài toán lớn được chia thành các bài toán con, mỗi bài toán con được giải trong một hàm. Mỗi bài toán con lại có thể chia nhỏ hơn nữa tuỳ độ phức tạp, quá trình "làm mịn" này diễn ra đến mức nào thì tuỳ vào lập trình viên.</p> <p>Ngoài ra, những bài toán con này lại có thể tái sử dụng ở những bài toán lớn hơn. Không như ngôn ngữ C, các hàm hoàn toàn ngang hàng với nhau, hàm trong Python có thể lồng nhau, giúp chúng ta làm mịn bài toán dễ dàng hơn rất nhiều.</p> <p>Dưới đây là một ví dụ "minh hoạ" cho việc sử dụng hàm lồng nhau để đơn giản hoá thuật toán.</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
<span class=gp>... </span>    <span class=n>l</span> <span class=o>=</span> <span class=mi>0</span>
<span class=gp>... </span>    <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>a</span><span class=p>:</span>
<span class=gp>... </span>        <span class=n>l</span> <span class=o>+=</span> <span class=n>x</span>
<span class=gp>... </span>    <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>b</span><span class=p>:</span>
<span class=gp>... </span>        <span class=n>l</span> <span class=o>+=</span> <span class=mi>2</span><span class=o>*</span><span class=n>x</span>
<span class=gp>... </span>    <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>c</span><span class=p>:</span>
<span class=gp>... </span>        <span class=n>l</span> <span class=o>+=</span> <span class=mi>3</span><span class=o>*</span><span class=n>x</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>l</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>f</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
<span class=go>270</span>
</pre></div> <p>Đây là một ví khá đơn giản. Hàm <code>f</code> nhận vào 3 list, sau đó tính một tổng theo quy luật cho trước. Quy luật đã được thể hiện trong code rồi, cũng không có gì khó hiểu cả.</p> <p>Code trên đây chạy tốt, tuy nhiên nó rất xấu. Dưới đây là một phiên bản đẹp hơn, sử dụng hàm lồng nhau.</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>a</span> <span class=p>,</span><span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
<span class=gp>... </span>    <span class=n>l</span> <span class=o>=</span> <span class=mi>0</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>inner</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>m</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=nb>sum</span><span class=p>(</span><span class=n>x</span><span class=o>*</span><span class=n>m</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>l</span><span class=p>)</span>
<span class=gp>... </span>    <span class=n>l</span> <span class=o>+=</span> <span class=n>inner</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
<span class=gp>... </span>    <span class=n>l</span> <span class=o>+=</span> <span class=n>inner</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
<span class=gp>... </span>    <span class=n>l</span> <span class=o>+=</span> <span class=n>inner</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>l</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>f</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
<span class=go>270</span>
</pre></div> <p>Rất dễ nhận ra, bằng cách sử dụng một hàm con <code>inner</code>, chúng ta đã gom những công việc tương tự nhau vào một chỗ. Code không ngắn đi nhiều lắm, nhưng rõ ràng là mạch lạc hơn rất nhiều. Sử dụng hàm lồng nhau trong trường hợp này rõ ràng là phát huy tác dụng rất đúng lúc.</p> <p>Không sử dụng hàm lồng nhau có được không? Câu trả lời là được, chúng ta có thể định nghĩa một hàm khác ngang hàng với hàm <code>f</code>, tuy nhiên trong trường hợp này, hàm con bên trong sẽ tốt hơn. Còn tại sao nó tốt hơn, chúng ta sẽ tìm hiểu tiếp ở những phần tiếp theo.</p> <p>Chúng ta có thể rút ngắn code hơn nữa bằng cách sử dụng lambda như dưới đây.</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>a</span> <span class=p>,</span><span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
<span class=gp>... </span>    <span class=n>l</span> <span class=o>=</span> <span class=mi>0</span>
<span class=gp>... </span>    <span class=n>inner</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>l</span><span class=p>,</span> <span class=n>m</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>x</span><span class=o>*</span><span class=n>m</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>l</span><span class=p>)</span>
<span class=gp>... </span>    <span class=n>l</span> <span class=o>+=</span> <span class=n>inner</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
<span class=gp>... </span>    <span class=n>l</span> <span class=o>+=</span> <span class=n>inner</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
<span class=gp>... </span>    <span class=n>l</span> <span class=o>+=</span> <span class=n>inner</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>l</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>f</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
<span class=go>270</span>
</pre></div> <p>Trong trường hợp này, lambda cũng là một hàm, hàm đó trả về giá trị thông qua một biểu thức duy nhất. Ví dụ, hai đoạn code dưới đây cho chúng ta cùng một kết quả:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>f</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>f</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=go>2</span>
</pre></div> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>f</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=go>2</span>
</pre></div> <p>Thực ra dùng lambda cho chúng ta kết quả không đáng kể lắm (code chỉ ngắn hơn có 1 dòng). Hơn nữa, trong trường hợp phức tạp, dùng hàm vẫn tốt hơn.</p> <h1 id=truyen-ham-lam-tham-so>Truyền hàm làm tham số<a class=headerlink href=#truyen-ham-lam-tham-so title="Permanent link">&para;</a></h1> <p>Việc truyền hàm vào một hàm khác nhiều khi rất quan trọng, đặc biệt là khi bạn lập trình kiểu generic, cho phép hàm hoạt động theo nhiều cách khác nhau, tuỳ vào tham số được truyền.</p> <p>Một ví dụ kinh điển cho trường hợp này là bài toán sắp xếp. Sắp xếp là một công việc thường xuyên trong lập trình, và nếu có thể lập trình generic các hàm sắp xếp thì còn gì bằng.</p> <p>Ứng dụng của việc truyền hàm làm tham số trong trường hợp này là, chúng ta có thể nhận tham số là một hàm so sánh, hàm sẽ trả về <code>-1, 0, 1</code> khi so sánh hai phần tử với nhau. Bằng cách này, hàm sắp xếp không cần quan tâm đến cách so sánh dữ liệu, còn người lập trình, chỉ cần tuỳ biến nó là có thể nhận được kết quả sắp xếp theo nhiều cách khác nhau, với nhiều kiểu dữ liệu khác nhau.</p> <p>Ví dụ, chúng ta cần sắp xếp dữ liệu nhân sự dựa trên tên của họ. Chúng ta có thể sắp xếp theo tên như sau:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>employees</span> <span class=o>=</span> <span class=p>[</span>
<span class=gp>... </span>    <span class=p>{</span><span class=s1>&#39;firstname&#39;</span><span class=p>:</span> <span class=s1>&#39;John&#39;</span><span class=p>,</span> <span class=s1>&#39;lastname&#39;</span><span class=p>:</span> <span class=s1>&#39;Joseph&#39;</span><span class=p>},</span>
<span class=gp>... </span>    <span class=p>{</span><span class=s1>&#39;firstname&#39;</span><span class=p>:</span> <span class=s1>&#39;Celine&#39;</span><span class=p>,</span> <span class=s1>&#39;lastname&#39;</span><span class=p>:</span> <span class=s1>&#39;Adams&#39;</span><span class=p>},</span>
<span class=gp>... </span>    <span class=p>{</span><span class=s1>&#39;firstname&#39;</span><span class=p>:</span> <span class=s1>&#39;Paul&#39;</span><span class=p>,</span> <span class=s1>&#39;lastname&#39;</span><span class=p>:</span> <span class=s1>&#39;Johnson&#39;</span><span class=p>},</span>
<span class=gp>... </span>    <span class=p>{</span><span class=s1>&#39;firstname&#39;</span><span class=p>:</span> <span class=s1>&#39;Aswathy&#39;</span><span class=p>,</span> <span class=s1>&#39;lastname&#39;</span><span class=p>:</span> <span class=s1>&#39;Govind&#39;</span><span class=p>},</span>
<span class=gp>... </span><span class=p>]</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>order</span><span class=p>(</span><span class=n>names</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>inner</span><span class=p>(</span><span class=n>item</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;firstname&#39;</span><span class=p>]</span>
<span class=gp>... </span>    <span class=n>sl</span> <span class=o>=</span> <span class=nb>zip</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>10</span><span class=p>),</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>names</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=n>inner</span><span class=p>))</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=nb>list</span><span class=p>(</span><span class=n>sl</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>order</span><span class=p>(</span><span class=n>employees</span><span class=p>)</span>
<span class=go>[(1, {&#39;firstname&#39;: &#39;Aswathy&#39;, &#39;lastname&#39;: &#39;Govind&#39;}),</span>
<span class=go> (2, {&#39;firstname&#39;: &#39;Celine&#39;, &#39;lastname&#39;: &#39;Adams&#39;}),</span>
<span class=go> (3, {&#39;firstname&#39;: &#39;John&#39;, &#39;lastname&#39;: &#39;Joseph&#39;}),</span>
<span class=go> (4, {&#39;firstname&#39;: &#39;Paul&#39;, &#39;lastname&#39;: &#39;Johnson&#39;})]</span>
<span class=go>&gt;&gt;&gt;</span>
</pre></div> <p>Bây giờ, giả sử yêu cầu thay đổi, chúng ta cần sắp xếp theo họ chứ không phải tên, rất đơn giản, chỉ cần thay đổi một chút hàm con truyền vào <code>sorted</code> là xong:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>order</span><span class=p>(</span><span class=n>employees</span><span class=p>)</span>
<span class=go>[(1, {&#39;firstname&#39;: &#39;Celine&#39;, &#39;lastname&#39;: &#39;Adams&#39;}),</span>
<span class=go> (2, {&#39;firstname&#39;: &#39;Aswathy&#39;, &#39;lastname&#39;: &#39;Govind&#39;}),</span>
<span class=go> (3, {&#39;firstname&#39;: &#39;Paul&#39;, &#39;lastname&#39;: &#39;Johnson&#39;}),</span>
<span class=go> (4, {&#39;firstname&#39;: &#39;John&#39;, &#39;lastname&#39;: &#39;Joseph&#39;})]</span>
</pre></div> <p>Chúng ta đã vận dụng hàm lồng nhau để thay đổi phương pháp sắp xếp, tuỳ theo yêu cầu (theo firstname hay lastname). Sau này, khi bài toán mở rộng, chúng ta cũng không cần phải thay đổi quá nhiều code.</p> <p>Tương tự như trường hợp trên, trong trường hợp này, chúng ta vẫn nên sử dụng hàm lồng nhau thay vì dùng các hàm độc lập.</p> <h1 id=tao-ham-ong>Tạo hàm động<a class=headerlink href=#tao-ham-ong title="Permanent link">&para;</a></h1> <p>Bởi vì hàm là đối tượng first-class, chúng ta có thể tạo ra hàm mới và trả về hàm trong một hàm khác. Bằng cách này, chúng ta có thể tạo ra các hàm real time theo nhu cầu.</p> <p>Trong ví dụ dưới đây, chúng ta có thể sử dụng hàm lồng nhau để tạo ra các hàm luỹ thừa theo nhu cầu. Thay vì phải định nghĩa các hàm như thế này</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>square</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>x</span> <span class=o>**</span> <span class=mi>2</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>cube</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>x</span> <span class=o>**</span> <span class=mi>3</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>square</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
<span class=go>4</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>cube</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
<span class=go>27</span>
</pre></div> <p>Chúng ta có thể dùng cách tạo hàm động như sau, trông "thông minh" hơn rất nhiều:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>fpower</span><span class=p>(</span><span class=n>exp</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>inner</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=n>x</span> <span class=o>**</span> <span class=n>exp</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>inner</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>square</span> <span class=o>=</span> <span class=n>fpower</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>square</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
<span class=go>4</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>cube</span> <span class=o>=</span> <span class=n>fpower</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>cube</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
<span class=go>27</span>
</pre></div> <p>Một lợi ích khác của việc này là chúng ta có thể dễ dàng tạo ra các hàm luỹ thừa bao nhiêu tuỳ ý</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>quartic</span> <span class=o>=</span> <span class=n>fpower</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>quartic</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
<span class=go>256</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>quintic</span> <span class=o>=</span> <span class=n>fpower</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>quintic</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
<span class=go>3125</span>
</pre></div> <h1 id=ong-goi>Đóng gói<a class=headerlink href=#ong-goi title="Permanent link">&para;</a></h1> <p>Hàm lồng nhau có một kết quả rất hay là chúng được bảo vệ khỏi sự ảnh hưởng từ bên ngoài. Hàm con bên trong một hàm khác là vô hình với thế giới. Chúng ta hãy xem xét ví dụ sau:</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>outer</span><span class=p>(</span><span class=n>num1</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>inner</span><span class=p>(</span><span class=n>num1</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=n>num1</span> <span class=o>+</span> <span class=mi>1</span>
<span class=gp>... </span>    <span class=n>num2</span> <span class=o>=</span> <span class=n>inner</span><span class=p>(</span><span class=n>num1</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>print</span><span class=p>(</span><span class=n>num1</span><span class=p>,</span> <span class=n>num2</span><span class=p>)</span>
<span class=gp>...</span>
</pre></div> <p>Nếu chúng ta gọi hàm <code>inner</code> thì sẽ nhận được kết quả thế này</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>inner</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=gt>Traceback (most recent call last):</span>
  File <span class=nb>&quot;&lt;stdin&gt;&quot;</span>, line <span class=m>1</span>, in <span class=n>&lt;module&gt;</span>
<span class=gr>NameError</span>: <span class=n>name &#39;inner&#39; is not defined</span>
</pre></div> <p>Ở đây, chúng ta chỉ có thể gọi hàm <code>outer</code> được định nghĩa bên ngoài mà thôi.</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>outer</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=go>1 2</span>
</pre></div> <p>Như vậy, hàm con được định nghĩa trong một hàm khác hoàn toàn cách ly với bên ngoài. Tính chất này là tốt hay xấu hoàn toàn phụ thuộc vào cách chúng ta dùng nó như thế nào. Trong ví dụ dưới đây, chúng ta sẽ lợi dụng tính chất này một cách hữu ích.</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>factorial</span><span class=p>(</span><span class=n>number</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>number</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>raise</span> <span class=ne>TypeError</span><span class=p>(</span><span class=s2>&quot;Sorry. &#39;number&#39; must be an integer.&quot;</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>if</span> <span class=n>number</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
<span class=gp>... </span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Sorry. &#39;number&#39; must be zero or positive.&quot;</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>inner</span><span class=p>(</span><span class=n>number</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>if</span> <span class=n>number</span> <span class=o>&lt;=</span> <span class=mi>1</span><span class=p>:</span>
<span class=gp>... </span>            <span class=k>return</span> <span class=mi>1</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=n>number</span> <span class=o>*</span> <span class=n>inner</span><span class=p>(</span><span class=n>number</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>inner</span><span class=p>(</span><span class=n>number</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>factorial</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
<span class=go>3628800</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>factorial</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
<span class=gt>Traceback (most recent call last):</span>
  File <span class=nb>&quot;&lt;stdin&gt;&quot;</span>, line <span class=m>1</span>, in <span class=n>&lt;module&gt;</span>
  File <span class=nb>&quot;&lt;stdin&gt;&quot;</span>, line <span class=m>5</span>, in <span class=n>factorial</span>
<span class=gr>ValueError</span>: <span class=n>Sorry. &#39;number&#39; must be zero or positive.</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>factorial</span><span class=p>(</span><span class=mi>1</span><span class=o>/</span><span class=mi>5</span><span class=p>)</span>
<span class=gt>Traceback (most recent call last):</span>
  File <span class=nb>&quot;&lt;stdin&gt;&quot;</span>, line <span class=m>1</span>, in <span class=n>&lt;module&gt;</span>
  File <span class=nb>&quot;&lt;stdin&gt;&quot;</span>, line <span class=m>3</span>, in <span class=n>factorial</span>
<span class=gr>TypeError</span>: <span class=n>Sorry. &#39;number&#39; must be an integer.</span>
</pre></div> <p>Bằng cách sử dụng hàm lồng nhau, chúng ta có thể định nghĩa một hàm nhận bất cứ đầu vào nào, việc kiểm tra đầu vào này hoàn toàn thực hiện bên trong hàm. Chúng ta không cần phải kiểm tra đầu vào trước khi gọi hàm <code>factorial</code>. Việc sử dụng hàm lồng nhau cho mục đích này đặc biệt phát huy tác dụng của nó khi chúng ta cần đến đệ quy, khi đó chúng ta cần thực hiện một số kiểm tra tham số trước khi thực sự gọi đệ quy.</p> <h1 id=tranh-lap-code-dry>Tránh lặp code (DRY)<a class=headerlink href=#tranh-lap-code-dry title="Permanent link">&para;</a></h1> <p>Nhiều khi có những phần code được lặp đi lặp lại và chúng ta nên định nghĩa hàm cho nó để có thể gọi được nhiều lần. Khác với phần trước, việc định nghĩa hàm này không giúp ích gì được thuật toán hay cấu trúc chương trình, nó chỉ đơn giản là tránh lặp code mà thôi.</p> <p>Ví dụ, trong trường hợp dưới đây, chúng ta cần thao tác xử lý với dữ liệu được ghi trong file. Hàm có thể nhận đầu vào là tên file hoặc một đối tượng <code>File</code> đã được mở.</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=nb>file</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>do_something</span><span class=p>(</span><span class=n>processing_file</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>processing_file</span><span class=p>:</span>
<span class=gp>... </span>            <span class=k>print</span><span class=p>(</span><span class=n>line</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>file</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=nb>file</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
<span class=gp>... </span>            <span class=n>do_something</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>else</span><span class=p>:</span>
<span class=gp>... </span>        <span class=n>do_something</span><span class=p>(</span><span class=nb>file</span><span class=p>)</span>
<span class=gp>...</span>
</pre></div> <p>Tất nhiên, trong trường hợp này chúng ta có thể định nghĩa hàm <code>do_something</code> ở bên ngoài, ngang hàng với hàm <code>process</code> cũng không vấn đề gì. Tuy nhiên, chúng ta nên sử dụng hàm lồng nhau bởi vì tính đóng gói của nó. Chương trình bên ngoài không cần biết đến sự tồn tại của <code>do_something</code>.</p> <h1 id=closures>Closures<a class=headerlink href=#closures title="Permanent link">&para;</a></h1> <p>Closure chính là ứng dụng quan trọng nhất của hàm lồng nhau. Xem lại những ứng dụng trên đây, chúng ta thấy rằng, dùng hàm lồng nhau cho kết quả tốt hơn nhưng điều đó là không bắt buộc. Chúng ta vẫn có thể định nghĩa các hàm ngang hàng với nhau mà chương trình cũng không thay đổi gì nhiều.</p> <p>Nhưng với closure, chúng ta bắt buộc phải sử dụng đến hàm lồng nhau.</p> <h2 id=closure-la-gi>Closure là gì<a class=headerlink href=#closure-la-gi title="Permanent link">&para;</a></h2> <p>Closure có thể hiểu là những hàm ghi nhớ "môi trường" nơi mà nó tạo ra. Môi trường được ghi nhớ này sẽ được sử dụng khi hàm được gọi. Thông thường, closure được tạo ra bởi hàm lồng nhau.</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>make_printer</span><span class=p>(</span><span class=n>msg</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>printer</span><span class=p>():</span>
<span class=gp>... </span>        <span class=k>print</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>printer</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>printer</span> <span class=o>=</span> <span class=n>make_printer</span><span class=p>(</span><span class=s1>&#39;Foo!&#39;</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>printer</span><span class=p>()</span>
<span class=go>Foo!</span>
</pre></div> <p>Cần chú ý rằng, closure được tạo ra bởi hàm lồng nhau nhưng không phải hàm lồng nhau nào cũng là closure. Closure chỉ được tạo ra khi hàm con truy cập đến những biến cục bộ trong scope được đóng bởi hàm cha.</p> <p>Trong ví dụ trên, khi <code>make_printer</code> được gọi, hàm con <code>printer</code> sẽ được định nghĩa cùng với giá trị của <code>msg</code> cục bộ. Sau đó, hàm <code>printer</code> này được trả về. Khi chúng ta thực thi hàm, bởi vì <code>printer</code> tham chiếu đến <code>msg</code> nên giá trị này sẽ được "ghi nhớ" ngay cả khi hàm <code>make_printer</code> đã kết thúc từ lâu.</p> <p>Vì vậy, nếu một hàm lồng trong hàm khác không thực hiện một trong những điều sau thì không phải là closure</p> <ul> <li>Truy cập đến các biến cục bộ được đóng trong scope, nơi mà nó được định nghĩa</li> <li>Truy cập đến các biến này khi nó được gọi thực thi từ bên ngoài.</li> </ul> <p>Dưới đây là một cách định nghĩa hàm lồng nhau mà không phát sinh closure.</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>make_printer</span><span class=p>(</span><span class=n>msg</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>printer</span><span class=p>(</span><span class=n>msg</span><span class=o>=</span><span class=n>msg</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>print</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>printer</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>printer</span> <span class=o>=</span> <span class=n>make_printer</span><span class=p>(</span><span class=s2>&quot;Foo!&quot;</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>printer</span><span class=p>()</span>
<span class=go>Foo!</span>
</pre></div> <p>Ở đây, chúng ta sử dụng <code>msg</code> cục bộ làm giá trị mặc định của tham số trong hàm con. Vì vậy, không có việc tham chiếu đến giá trị cục bộ này nữa sau khi <code>make_printer</code> kết thúc. Giá trị <code>msg</code> giờ đây chỉ đơn giản là một giá trị được gán khi <code>printer</code> được định nghĩa mà thôi, mà rõ ràng hàm không hề "ghi nhớ" bất cứ điều gì về môi trường của nó cả.</p> <h2 id=closure-co-tac-dung-gi>Closure có tác dụng gì<a class=headerlink href=#closure-co-tac-dung-gi title="Permanent link">&para;</a></h2> <p>Closure có thể phòng tránh được việc sử dụng biến cục bộ mà có thể đóng gói các hàm. Điều này giúp chúng ta lập trình thủ tục nhưng có thể tạo ra các hàm có nhiều tính chất của lập trình hướng đối tượng.</p> <p>Khi chúng ta cần định nghĩa một class với chỉ vài phương thức, closure có thể được sử dụng như một giải pháp thay thế và thường là closure sẽ nhẹ nhàng hơn lập trình hướng đối tượng. Tuy nhiên là khi các thuộc tính và phương thức nhiều nên, chúng ta nên sử dụng lập trình hướng đối tượng thì hơn.</p> <p>Một ví dụ về sử dụng closure đã được đưa ra ở trên, chúng ta sử dụng closure để định nghĩa các hàm động. Trong trường hợp này, sử dụng phương pháp lập trình hướng đối tượng có vẻ không phải là một giải pháp hay cho lắm.</p> <div class=codehilite><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>fpower</span><span class=p>(</span><span class=n>exp</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>inner</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=n>x</span> <span class=o>**</span> <span class=n>exp</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>inner</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>square</span> <span class=o>=</span> <span class=n>fpower</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>square</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
<span class=go>4</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>cube</span> <span class=o>=</span> <span class=n>fpower</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>cube</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
<span class=go>27</span>
</pre></div> <h2 id=vi-du-thuc-te>Ví dụ thực tế<a class=headerlink href=#vi-du-thuc-te title="Permanent link">&para;</a></h2> <p>Trong thực tế, closure nói riêng mà hàm lồng nhau nói chung của Python được sử dụng rất phổ biến. Dưới đây là một ứng dụng của closure trong việc login/logout cũng như authorize cho một ứng dụng Web viết bằng CherryPy.</p> <div class=codehilite><pre><span></span><span class=ch>#!python</span>
<span class=c1># -*- encoding: UTF-8 -*-</span>
<span class=c1>#</span>
<span class=c1># Form based authentication for CherryPy. Requires the</span>
<span class=c1># Session tool to be loaded.</span>
<span class=c1>#</span>

<span class=kn>import</span> <span class=nn>cherrypy</span>

<span class=n>SESSION_KEY</span> <span class=o>=</span> <span class=s1>&#39;_cp_username&#39;</span>

<span class=k>def</span> <span class=nf>check_credentials</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;Verifies credentials for username and password.</span>
<span class=sd>    Returns None on success or a string describing the error on failure&quot;&quot;&quot;</span>
    <span class=c1># Adapt to your needs</span>
    <span class=k>if</span> <span class=n>username</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;joe&#39;</span><span class=p>,</span> <span class=s1>&#39;steve&#39;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>password</span> <span class=o>==</span> <span class=s1>&#39;secret&#39;</span><span class=p>:</span>
        <span class=k>return</span> <span class=bp>None</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=sa>u</span><span class=s2>&quot;Incorrect username or password.&quot;</span>

    <span class=c1># An example implementation which uses an ORM could be:</span>
    <span class=c1># u = User.get(username)</span>
    <span class=c1># if u is None:</span>
    <span class=c1>#     return u&quot;Username %s is unknown to me.&quot; % username</span>
    <span class=c1># if u.password != md5.new(password).hexdigest():</span>
    <span class=c1>#     return u&quot;Incorrect password&quot;</span>

<span class=k>def</span> <span class=nf>check_auth</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;A tool that looks in config for &#39;auth.require&#39;. If found and it</span>
<span class=sd>    is not None, a login is required and the entry is evaluated as a list of</span>
<span class=sd>    conditions that the user must fulfill&quot;&quot;&quot;</span>
    <span class=n>conditions</span> <span class=o>=</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;auth.require&#39;</span><span class=p>,</span> <span class=bp>None</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>conditions</span> <span class=ow>is</span> <span class=ow>not</span> <span class=bp>None</span><span class=p>:</span>
        <span class=n>username</span> <span class=o>=</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>SESSION_KEY</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>username</span><span class=p>:</span>
            <span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>login</span> <span class=o>=</span> <span class=n>username</span>
            <span class=k>for</span> <span class=n>condition</span> <span class=ow>in</span> <span class=n>conditions</span><span class=p>:</span>
                <span class=c1># A condition is just a callable that returns true or false</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=n>condition</span><span class=p>():</span>
                    <span class=k>raise</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>HTTPRedirect</span><span class=p>(</span><span class=s2>&quot;/auth/login&quot;</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>raise</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>HTTPRedirect</span><span class=p>(</span><span class=s2>&quot;/auth/login&quot;</span><span class=p>)</span>

<span class=n>cherrypy</span><span class=o>.</span><span class=n>tools</span><span class=o>.</span><span class=n>auth</span> <span class=o>=</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>Tool</span><span class=p>(</span><span class=s1>&#39;before_handler&#39;</span><span class=p>,</span> <span class=n>check_auth</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>require</span><span class=p>(</span><span class=o>*</span><span class=n>conditions</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;A decorator that appends conditions to the auth.require config</span>
<span class=sd>    variable.&quot;&quot;&quot;</span>
    <span class=k>def</span> <span class=nf>decorate</span><span class=p>(</span><span class=n>f</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=s1>&#39;_cp_config&#39;</span><span class=p>):</span>
            <span class=n>f</span><span class=o>.</span><span class=n>_cp_config</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
        <span class=k>if</span> <span class=s1>&#39;auth.require&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>f</span><span class=o>.</span><span class=n>_cp_config</span><span class=p>:</span>
            <span class=n>f</span><span class=o>.</span><span class=n>_cp_config</span><span class=p>[</span><span class=s1>&#39;auth.require&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>f</span><span class=o>.</span><span class=n>_cp_config</span><span class=p>[</span><span class=s1>&#39;auth.require&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>conditions</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>f</span>
    <span class=k>return</span> <span class=n>decorate</span>


<span class=c1># Conditions are callables that return True</span>
<span class=c1># if the user fulfills the conditions they define, False otherwise</span>
<span class=c1>#</span>
<span class=c1># They can access the current username as cherrypy.request.login</span>
<span class=c1>#</span>
<span class=c1># Define those at will however suits the application.</span>

<span class=k>def</span> <span class=nf>member_of</span><span class=p>(</span><span class=n>groupname</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>check</span><span class=p>():</span>
        <span class=c1># replace with actual check if &lt;username&gt; is in &lt;groupname&gt;</span>
        <span class=k>return</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>login</span> <span class=o>==</span> <span class=s1>&#39;joe&#39;</span> <span class=ow>and</span> <span class=n>groupname</span> <span class=o>==</span> <span class=s1>&#39;admin&#39;</span>
    <span class=k>return</span> <span class=n>check</span>

<span class=k>def</span> <span class=nf>name_is</span><span class=p>(</span><span class=n>reqd_username</span><span class=p>):</span>
    <span class=k>return</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>reqd_username</span> <span class=o>==</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>login</span>

<span class=c1># These might be handy</span>

<span class=k>def</span> <span class=nf>any_of</span><span class=p>(</span><span class=o>*</span><span class=n>conditions</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;Returns True if any of the conditions match&quot;&quot;&quot;</span>
    <span class=k>def</span> <span class=nf>check</span><span class=p>():</span>
        <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>conditions</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>c</span><span class=p>():</span>
                <span class=k>return</span> <span class=bp>True</span>
        <span class=k>return</span> <span class=bp>False</span>
    <span class=k>return</span> <span class=n>check</span>

<span class=c1># By default all conditions are required, but this might still be</span>
<span class=c1># needed if you want to use it inside of an any_of(...) condition</span>
<span class=k>def</span> <span class=nf>all_of</span><span class=p>(</span><span class=o>*</span><span class=n>conditions</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;Returns True if all of the conditions match&quot;&quot;&quot;</span>
    <span class=k>def</span> <span class=nf>check</span><span class=p>():</span>
        <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>conditions</span><span class=p>:</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>c</span><span class=p>():</span>
                <span class=k>return</span> <span class=bp>False</span>
        <span class=k>return</span> <span class=bp>True</span>
    <span class=k>return</span> <span class=n>check</span>


<span class=c1># Controller to provide login and logout actions</span>

<span class=k>class</span> <span class=nc>AuthController</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>

    <span class=k>def</span> <span class=nf>on_login</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;Called on successful login&quot;&quot;&quot;</span>

    <span class=k>def</span> <span class=nf>on_logout</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;Called on logout&quot;&quot;&quot;</span>

    <span class=k>def</span> <span class=nf>get_loginform</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>msg</span><span class=o>=</span><span class=s2>&quot;Enter login information&quot;</span><span class=p>,</span> <span class=n>from_page</span><span class=o>=</span><span class=s2>&quot;/&quot;</span><span class=p>):</span>
        <span class=k>return</span> <span class=s2>&quot;&quot;&quot;&lt;html&gt;&lt;body&gt;</span>
<span class=s2>            &lt;form method=&quot;post&quot; action=&quot;/auth/login&quot;&gt;</span>
<span class=s2>            &lt;input type=&quot;hidden&quot; name=&quot;from_page&quot; value=&quot;</span><span class=si>%(from_page)s</span><span class=s2>&quot; /&gt;</span>
<span class=s2>            </span><span class=si>%(msg)s</span><span class=s2>&lt;br /&gt;</span>
<span class=s2>            Username: &lt;input type=&quot;text&quot; name=&quot;username&quot; value=&quot;</span><span class=si>%(username)s</span><span class=s2>&quot; /&gt;&lt;br /&gt;</span>
<span class=s2>            Password: &lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt;&lt;br /&gt;</span>
<span class=s2>            &lt;input type=&quot;submit&quot; value=&quot;Log in&quot; /&gt;</span>
<span class=s2>        &lt;/body&gt;&lt;/html&gt;&quot;&quot;&quot;</span> <span class=o>%</span> <span class=nb>locals</span><span class=p>()</span>

    <span class=nd>@cherrypy.expose</span>
    <span class=k>def</span> <span class=nf>login</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span> <span class=n>from_page</span><span class=o>=</span><span class=s2>&quot;/&quot;</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>username</span> <span class=ow>is</span> <span class=bp>None</span> <span class=ow>or</span> <span class=n>password</span> <span class=ow>is</span> <span class=bp>None</span><span class=p>:</span>
            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_loginform</span><span class=p>(</span><span class=s2>&quot;&quot;</span><span class=p>,</span> <span class=n>from_page</span><span class=o>=</span><span class=n>from_page</span><span class=p>)</span>

        <span class=n>error_msg</span> <span class=o>=</span> <span class=n>check_credentials</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>error_msg</span><span class=p>:</span>
            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_loginform</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>error_msg</span><span class=p>,</span> <span class=n>from_page</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>cherrypy</span><span class=o>.</span><span class=n>session</span><span class=p>[</span><span class=n>SESSION_KEY</span><span class=p>]</span> <span class=o>=</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>login</span> <span class=o>=</span> <span class=n>username</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>on_login</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>
            <span class=k>raise</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>HTTPRedirect</span><span class=p>(</span><span class=n>from_page</span> <span class=ow>or</span> <span class=s2>&quot;/&quot;</span><span class=p>)</span>

    <span class=nd>@cherrypy.expose</span>
    <span class=k>def</span> <span class=nf>logout</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>from_page</span><span class=o>=</span><span class=s2>&quot;/&quot;</span><span class=p>):</span>
        <span class=n>sess</span> <span class=o>=</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>session</span>
        <span class=n>username</span> <span class=o>=</span> <span class=n>sess</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>SESSION_KEY</span><span class=p>,</span> <span class=bp>None</span><span class=p>)</span>
        <span class=n>sess</span><span class=p>[</span><span class=n>SESSION_KEY</span><span class=p>]</span> <span class=o>=</span> <span class=bp>None</span>
        <span class=k>if</span> <span class=n>username</span><span class=p>:</span>
            <span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>login</span> <span class=o>=</span> <span class=bp>None</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>on_logout</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>
        <span class=k>raise</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>HTTPRedirect</span><span class=p>(</span><span class=n>from_page</span> <span class=ow>or</span> <span class=s2>&quot;/&quot;</span><span class=p>)</span>
</pre></div> <p>Bạn thấy đó, closure được sử dụng rất thường xuyên.</p> <h1 id=ket-luan>Kết luận<a class=headerlink href=#ket-luan title="Permanent link">&para;</a></h1> <p>Hàm lồng nhau trong Python là rất quan trọng, và nếu biết sử dụng nó đúng cách, chúng ta sẽ viết được những đoạn code đẹp, hiệu suất cao và dễ bảo trì. Trong những ứng dụng của hàm lồng nhau, closure chính là ứng dụng quan trọng nhất. Thực ra, nếu bạn sử dụng decorator trong Python, bạn đã sử dụng closure rồi đó.</p> <p>Hy vọng bài viết có ích, các bạn code Python ngày càng bá hơn!!</p> </div> <div class=post-footer> <div class=tags> <i class="fa fa-tags"></i> <span>#Python</span> <span>#fundamentals</span> <span>#function</span> <span>#nested</span> <span>#how-to</span> </div> </div> </div><div class=blog-pager> <span class=newer-link> <a href=/2018/Jan/12/algorithm-primality-test.html> Newer Post </a> </span> <span class=older-link> <a href=/2017/Nov/07/delivery-in-hanoi-obstetrics-gynecology-hospital.html> Older Post </a> </span> </div><div class=comments> <div class=finally> <p><em>I apologise for any typos. If you notice a problem, please let me know.</em> <p>Thank you all for your attention. </div> <div id=disqus_thread></div> <script src=/theme/js/disqus.min.js?81e8a5f5></script> <noscript> Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript> comments powered by Disqus. </a> </noscript> </div></div> </div> </div> <div class=sidebar-wrapper> <div class=widget> <h2>Welcome</h2> <div> <img src=/theme/images/banner.gif alt=Welcome> </div> </div><div class="widget recent-posts"> <h2>Recent Posts</h2> <ul> <li> <a href=/2019/May/20/elasticsearch-data-organization.html> <img alt="Elasticsearch: Data organization" src=https://i.imgur.com/JT4y7Qf.jpg> </a> <a href=/2019/May/20/elasticsearch-data-organization.html>Elasticsearch: Data organization</a> <li> <a href=/2019/May/20/elasticsearch-intro.html> <img alt="Elasticsearch: Intro" src=https://i.imgur.com/JT4y7Qf.jpg> </a> <a href=/2019/May/20/elasticsearch-intro.html>Elasticsearch: Intro</a> <li> <a href=/2019/Apr/20/javascript-popups.html> <img alt="JavaScript: Popups" src=https://i.imgur.com/FxmcwPy.png> </a> <a href=/2019/Apr/20/javascript-popups.html>JavaScript: Popups</a> <li> <a href=/2019/Mar/20/javascript-iterator-and-generator.html> <img alt="JavaScript: Iterator and generator" src=https://i.imgur.com/lev8iT9.jpg> </a> <a href=/2019/Mar/20/javascript-iterator-and-generator.html>JavaScript: Iterator and generator</a> <li> <a href=/2019/Feb/20/javascript-decorator.html> <img alt="JavaScript decorator" src=https://i.imgur.com/Sh3yLI0.png> </a> <a href=/2019/Feb/20/javascript-decorator.html>JavaScript decorator</a> </ul> </div><div class="widget labels"> <h2>Blog Archive</h2> <ul> <li> <a href=/2019/ > 2019 </a> <li> <a href=/2018/ > 2018 </a> <li> <a href=/2017/ > 2017 </a> <li> <a href=/2016/ > 2016 </a> <li> <a href=/2015/ > 2015 </a> <li> <a href=/2014/ > 2014 </a> <li> <a href=/2013/ > 2013 </a> <li> <a href=/2012/ > 2012 </a> <li> <a href=/2011/ > 2011 </a> <li> <a href=/2010/ > 2010 </a> </ul> </div><div class=widget> <h2>Twitter timeline</h2> <a class=twitter-timeline data-height=500 data-dnt=true data-theme=light href=https://twitter.com/_naa_4f data-chrome="noheader nofooter transparent noborders"> Tweets by manhhomienbienthuy </a> </div> </div> </div> <a href=# class="smooth-scroll back-to-top"> <i class="fa fa-arrow-circle-up fa-3x"></i> </a> </main> <footer> <div class=infos> <div class=wrapper> <div class=widget> <a href=/ title="manhhomienbienthuy's space" class=logo> <img alt="manhhomienbienthuy's space" src=/theme/images/logo_white.png> </a> <span class=right>I'm a hacker, enter my world...</span> </div><div class=widget> <p> Created with all my ♥ and soul, dedicated to my love, yunachan <p> Powered by <a href=http://blog.getpelican.com/ target=_blank>Pelican</a>, which takes great advantage of <a href=https://www.python.org/ target=_blank>Python</a> <p> This site content is licensed under a <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank> CC BY-NC-ND 4.0 </a> License. <p> Updated at <a target=_blank href="http://www.timeanddate.com/worldclock/fixedtime.html?iso=2019-06-20T02:42:55"> 2019-06-20 02:42:55 </a> </div><div class=widget> <p> Hosting by <a href=https://manhhomienbienthuy.bitbucket.io/ >Bitbucket</a> and <a href=https://manhhomienbienthuy.github.io/ >Github</a>, image hosting by <a href=https://manhhomienbienthuy.imgur.com/ target=_blank>imgur</a>, <a href=https://instagram.com/manhhomienbienthuy/ target=_blank>Instagram</a> and <a href=https://photos.google.com/ target=_blank>Google Photo</a> <p> Theme based on <a href=https://vanice-veethemes.blogspot.com/ target=_blank>Vanice theme</a>, icons from <a href=https://fontawesome.com/ target=_blank>Font Awesome</a>, comments powered by <a href=https://disqus.com/home/forums/manhhomienbienthuy/ target=_blank>Disqus</a> </div> </div> </div> <div class=credits> <div class=wrapper> <div class=left> <!--
          Regarding copyright, in general, standalone pages (as
          opposed to files generated as part of manuals) on the GNU
          web server should be under CC BY-ND 4.0.  Please do NOT
          change or remove this without talking with the webmasters or
          licensing team first.  Please make sure the copyright date
          is consistent with the document.  For web pages, it is ok to
          list just the latest year the document was modified, or
          published.

          If you wish to list earlier years, that is ok too.  Either
          "2001, 2002, 2003" or "2001-2003" are ok for specifying
          years, as long as each year in the range is in fact a
          copyrightable year, i.e., a year in which the document was
          published (including being publicly visible on the web or in
          a revision control system).
        --> Copyright © 2010-2019 <a href=/pages/about-me.html><strong>manhhomienbienthuy</strong></a>. All rights reserved. </div> <div class=right> <ul> <li><a href=/ >Home</a> <li><a href=/pages/about-me.html>About</a> <li><a href=# class=smooth-scroll>Top ↑</a> </ul> </div> </div> </div></footer> <script src=https://code.jquery.com/jquery-3.2.1.js></script> <script src=//cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js></script> <script src=//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.2/imagesloaded.pkgd.min.js></script> <script src=/theme/js/vpyeu.min.js?d72c87bd></script> <script id=dsq-count-scr src=https://manhhomienbienthuy.disqus.com/count.js async></script>