<!DOCTYPE html><title>Web development with Cherrypy and Jinja2 - manhhomienbienthuy's space</title> <meta charset=utf-8> <meta name=viewport content="width=device-width, initial-scale=1"> <link rel=apple-touch-icon href=/theme/images/icon-touch.png> <link rel=icon sizes=192x192 href=/theme/images/icon-touch.png> <link rel="shortcut icon" href=/theme/images/favicon.ico> <link rel=author href=/humans.txt> <meta name=msapplication-TileImage content=/theme/images/icon-tile.png> <meta name=twitter:dnt content=on> <meta name=Author content=manhhomienbienthuy> <meta name=rating content=general> <meta name=twitter:card content=product> <meta name=twitter:site content=@_naa_4f> <meta name=twitter:creator content=@_naa_4f> <link href=/feeds/all.atom.xml type=application/atom+xml rel=alternate title="manhhomienbienthuy's space Full Atom Feed"> <meta name=description content="Trong bài viết này, tôi sẽ giới thiệu một framework để phát triển Web - CherryPy - một framework được viết cho Python. Tôi sẽ không đi sâu vào phân tích và so sánh với các framework khác và các ngôn ngữ khác và tại sao bạn nên sử dụng framework này …"> <meta name=keywords content="Python, Cherrypy, Jinja2, SQLAlchemy, Web, blog, naa, manhhomienbienthuy, pelican, static site generator"> <meta name=twitter:title content="Web development with Cherrypy and Jinja2 - manhhomienbienthuy's space"> <meta name=twitter:description content="Trong bài viết này, tôi sẽ giới thiệu một framework để phát triển Web - CherryPy - một framework được viết cho Python. Tôi sẽ không đi sâu vào phân tích và so sánh với các framework khác và các ngôn ngữ khác và tại sao bạn nên sử dụng framework này …"> <meta name=twitter:image content=/https://i.imgur.com/c5Upm7q.png> <link rel=stylesheet href=//cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css> <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.0.0/css/font-awesome.min.css> <link rel=stylesheet href=/theme/css/vpyeu.min.css?5d2c7d5e> <header> <div class=navbar> <div class=wrapper> <div class=nav-menu> <div class=menu-toggle> <i class="fa fa-reorder"></i> </div> <ul class=menus> <li><a href=/ >Home</a> <li><a href=/category/general.html> General <li><a href=/category/life.html> Life <li><a href=/category/programming.html class=current> Programming <li><a href=/category/travel.html> Travel </ul> </div><div class="right links"> <ul> <li> <a href=https://twitter.com/_naa_4f target=_blank> <i class="fa fa-twitter"></i> </a> <li> <a href=https://instagram.com/manhhomienbienthuy/ target=_blank> <i class="fa fa-instagram"></i> </a> <li> <a href=https://www.facebook.com/manhhomienbienthuy target=_blank> <i class="fa fa-facebook"></i> </a> <li> <a href=https://github.com/manhhomienbienthuy target=_blank> <i class="fa fa-github"></i> </a> <li> <a href=/feeds/all.atom.xml target=_blank> <i class="fa fa-rss"></i> </a> </ul> </div> </div> </div><noscript> <div class="warning head-warn"> <div class=wrapper> <p><strong>Notice:</strong> While JavaScript is not essential for this website, your interaction with the content will be limited. Please turn JavaScript on for the full experience. </div> </div> </noscript><div class=banner> <div class=wrapper> <a href=/ > <img alt="manhhomienbienthuy's space" src=/theme/images/logo.png> </a> </div> </div></header> <main> <div class=wrapper> <div class=main-wrapper> <div class=entry> <div class=entry-detail> <div class=post> <h1 class=title> Web development with Cherrypy and Jinja2 </h1> <div class=meta> Posted in <a href=/category/programming.html>Programming</a> on August 30, 2015 by <a href=/pages/about-me.html>manhhomienbienthuy</a> <span class=right> <i class="fa fa-comments"></i> <a href=#disqus_thread data-disqus-identifier=/2015/Aug/30/web-development-with-cherrypy-and-jinja2.html> Comments </a> </span> </div> <div class=post-body> <img src=https://i.imgur.com/c5Upm7q.png alt="Web development with Cherrypy and Jinja2"> <p>Trong bài viết này, tôi sẽ giới thiệu một framework để phát triển Web - CherryPy - một framework được viết cho Python. Tôi sẽ không đi sâu vào phân tích và so sánh với các framework khác và các ngôn ngữ khác và tại sao bạn nên sử dụng framework này. Bởi vì mỗi framework đều có những điểm mạnh điểm yếu riêng, không có framework nào là hoàn hảo cả. Mục đích lớn nhất của bài viết là học hỏi và giới thiệu một framework mới, từ đó chúng ta có thêm nhiều lựa chọn hơn khi muốn phát triển Web. Và tất nhiên, tùy vào mục đích của trang Web mà bọn có thể chọn được framework thích hợp nhất cho mình.</p> <h1 id=gioi-thieu-cherrypy-va-jinja2>Giới thiệu CherryPy và Jinja2<a class=headerlink href=#gioi-thieu-cherrypy-va-jinja2 title="Permanent link">&para;</a></h1> <h2 id=cherrypy>CherryPy<a class=headerlink href=#cherrypy title="Permanent link">&para;</a></h2> <p>CherryPy là một framework phát triển Web hướng đối tượng theo phong cách Pythonic. CherryPy cho phép những người phát triển xây dựng các ứng dụng Web với cách thức hoàn toàn giống như xây dựng các ứng dụng Python hướng đối tượng khác. Điều này sẽ giúp giảm kích thước mã nguồn và thời gian phát triển, nếu như bạn đã có kinh nghiệm với Python.</p> <p>Những thông tin về CherryPy bạn có thể tìm thấy trên trang chủ <a href=http://cherrypy.org/ >http://cherrypy.org/</a>, những tài liệu và nhiều thông tin khác được đưa ra ở trong <a href=http://docs.cherrypy.org/en/latest/index.html>http://docs.cherrypy.org/en/latest/index.html</a>. Ở những trang đó, bạn có thể thấy những ưu điểm nổi bật của CherryPy và lý do tại sao bạn nên dùng nó. Ở nội dung bài viết này, tôi sẽ không đi sâu vào phân tích những điều này.</p> <p>Có một đặc điểm của CherryPy khác với rất nhiều các framework khác. CherryPy được xây dựng đơn giản gọn nhẹ, và công việc của nó cũng hết sức đơn giản, đó là nhận request từ người dùng (cụ thể là các trình duyệt Web) và gửi phản hồi. CherryPy không cung cấp bất kỳ một template engine nào để xây dựng các trang HTML. Và CherryPy cũng không cung cấp bất kỳ một ORM (Object Relation Mapper) nào để tương tác với cơ sở dữ liệu. Điều đó có nghĩa là bạn có thể tự do lựa chọn bất cứ một template engine nào, và bất cứ ORM nào được viết cho Python.</p> <p>Có rất nhiều template engine khác nhau có thể sử dụng với CherryPy, bạn có thể tham khảo ở <a href=http://en.wikipedia.org/wiki/CherryPy#Templating_languages>đây</a>. Với nội dung bài viết này, tôi sẽ sử dụng Jinja2.</p> <h2 id=jinja2>Jinja2<a class=headerlink href=#jinja2 title="Permanent link">&para;</a></h2> <p>Jinja2 là một template engine cho Python với đầy đủ tính năng mà một template engine cần phải có với khả năng hỗ trợ Unicode, I18n, và cả khă năng chạy môi trường sandbox.</p> <p>Dưới đây là một vài tính năng nổi bật của Jinja2</p> <ul> <li>chạy sandbox</li> <li>Có hệ thống escape HTML mạnh mẽ để phòng chống XSS</li> <li>Có thể kế thừa, module hóa template</li> <li>Được xây dựng để tối ưu hóa code Python</li> <li>Tùy chọn cho phép dịch template head-in-time</li> <li>Dễ dàng debug.</li> <li>Cú phát cho phép dễ dàng config</li> </ul> <h2 id=cai-at>Cài đặt<a class=headerlink href=#cai-at title="Permanent link">&para;</a></h2> <p>Để phát triển Web, trước hết bạn phải cài đặt các package cần thiết, cụ thể ở đây là CherryPy và Jinja2. Tôi nghĩ, tốt nhất chúng ta nên thiết lập môi trường ảo cho python ở trên máy của chúng ta, điều đó sẽ giúp những cài đặt sau đây không ảnh hưởng gì đến hệ thống.</p> <p><strong>Lưu ý</strong>, trong bài viết này, tôi sẽ sử dụng Python 3. Với Python 2, việc cấu hình và mã nguồn sẽ khác đi một chút.</p> <ul> <li>Khởi tạo môi trường ảo cho Python</li> </ul> <div class=codehilite><pre><span></span><span class=gp>$</span> pyvenv venv
</pre></div> <p>Nếu bạn sử dụng Ubuntu 14.04 thì Ubuntu cài đặt sẵn một bản <code>pyvenv</code> không đầy đủ, nên bạn không thể dùng lệnh trên được. Tham khảo cách làm ở <a href=http://askubuntu.com/questions/488529/pyvenv-3-4-error-returned-non-zero-exit-status-1>đây</a> để fix lỗi này.</p> <ul> <li>Activate Python trong môi trường ảo</li> </ul> <div class=codehilite><pre><span></span><span class=gp>$</span> <span class=nb>source</span> venv/bin/activate
</pre></div> <ul> <li>Cài đặt các package cần thiết</li> </ul> <div class=codehilite><pre><span></span><span class=gp>$</span> pip install CheryPy
<span class=gp>$</span> pip install Jinja2
</pre></div> <p>Vậy là đủ cho một ứng dụng Web đơn giản. Sau đây chúng ta sẽ đi vào cụ thể việc phát triển Web với CherryPy và Jinja2.</p> <h1 id=phat-trien-web>Phát triển Web<a class=headerlink href=#phat-trien-web title="Permanent link">&para;</a></h1> <h2 id=cau-truc-file-va-thu-muc>Cấu trúc file và thư mục<a class=headerlink href=#cau-truc-file-va-thu-muc title="Permanent link">&para;</a></h2> <p>Bởi vì CherryPy được xây dựng để việc phát triển Web giống như phát triển một app Python bình thường, nên không có một quy định cụ thể nào về việc sắp xếp và tổ chức các thư mục. Tuy nhiên, tôi đã tham khảo một <a href=https://bitbucket.org/Lawouach/twiseless/src>project trên bitbucket</a> và thấy đây là một cấu trúc tốt, rất dễ hiểu. Nhiều người phát triển Web bằng CherryPy cũng tham khảo cách tổ chức này. Về cơ bản một project sẽ có các file và thư mục sau:</p> <ul> <li><code>conf</code>: thư mục chứa các file config của app.</li> <li><code>lib</code>: thư mục chứa các thư viện, tools và cả các models dùng cho app, một phần của nó giống như M trong MVC</li> <li><code>public</code>: thư mục chứa các tệp tĩnh như css, js, ...</li> <li><code>template</code>: thư mục chứa các file template, nó chính là phần V trong MVC.</li> <li><code>webapp</code>: thư mục chưa file chính của app, nó đóng vai trò là phần C trong MVC.</li> <li><code>server.py</code>: file được gọi chính để khởi tạo server Web.</li> </ul> <p>Nội dung của file <code>server.py</code> như sau:</p> <div class=codehilite><pre><span></span><span class=ch>#!/usr/bin/env python3</span>
<span class=c1># -*- coding: utf-8 -*-</span>

<span class=kn>import</span> <span class=nn>os</span>
<span class=kn>import</span> <span class=nn>cherrypy</span>
<span class=kn>import</span> <span class=nn>tempfile</span>

<span class=kn>import</span> <span class=nn>webapp.app</span>


<span class=k>class</span> <span class=nc>Server</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>

    <span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_set_basic_config</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_setup</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_add_app</span><span class=p>()</span>

    <span class=k>def</span> <span class=nf>_set_basic_config</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>base_dir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=vm>__file__</span><span class=p>))</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>conf_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base_dir</span><span class=p>,</span> <span class=s2>&quot;conf&quot;</span><span class=p>)</span>
        <span class=n>log_dir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base_dir</span><span class=p>,</span> <span class=s2>&quot;logs&quot;</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>log_dir</span><span class=p>):</span>
            <span class=n>os</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>log_dir</span><span class=p>)</span>
        <span class=n>session_dir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>tempfile</span><span class=o>.</span><span class=n>gettempdir</span><span class=p>(),</span> <span class=s2>&quot;sessions&quot;</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>session_dir</span><span class=p>):</span>
            <span class=n>os</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>session_dir</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>_setup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=c1># Update the global settings for the HTTP server and engine</span>
        <span class=n>cherrypy</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conf_path</span><span class=p>,</span> <span class=s2>&quot;server.conf&quot;</span><span class=p>))</span>

    <span class=k>def</span> <span class=nf>_add_app</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>cherrypy</span><span class=o>.</span><span class=n>tree</span><span class=o>.</span><span class=n>mount</span><span class=p>(</span>
            <span class=n>webapp</span><span class=o>.</span><span class=n>app</span><span class=o>.</span><span class=n>VpyeuBank</span><span class=p>(),</span>
            <span class=s2>&quot;/&quot;</span><span class=p>,</span>
            <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conf_path</span><span class=p>,</span> <span class=s2>&quot;app.conf&quot;</span><span class=p>)</span>
        <span class=p>)</span>

    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>engine</span> <span class=o>=</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>engine</span>
        <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>engine</span><span class=p>,</span> <span class=s2>&quot;signal_handler&quot;</span><span class=p>):</span>
            <span class=n>engine</span><span class=o>.</span><span class=n>signal_handler</span><span class=o>.</span><span class=n>subscribe</span><span class=p>()</span>

        <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>engine</span><span class=p>,</span> <span class=s2>&quot;console_control_handler&quot;</span><span class=p>):</span>
            <span class=n>engine</span><span class=o>.</span><span class=n>console_control_handler</span><span class=o>.</span><span class=n>subscribe</span><span class=p>()</span>

        <span class=n>engine</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
        <span class=n>engine</span><span class=o>.</span><span class=n>block</span><span class=p>()</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
    <span class=n>Server</span><span class=p>()</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</pre></div> <p><code>server.py</code> sẽ là file chính được gọi khi khởi tạo server Web. Nhiệm vụ của nó là khởi tạo các cấu hình cần thiết của hệ thống để app có thể chạy được. Cụ thể trong trường hợp trên là khởi tạo các thư mục lưu sessions, logs, gọi các app. Các giá trị khởi tạo này hoàn toàn có thể cấu hình được. Và các file cấu hình được lưu trong thư mục <code>conf</code>. Trong ví dụ này, tôi lưu 2 file <code>server.conf</code> để lưu cấu hình hệ thống và <code>app.conf</code> để lưu các cấu hình riêng cho app.</p> <p>Nội dung file <code>server.conf</code> như sau:</p> <div class=codehilite><pre><span></span><span class=p>[</span><span class=k>global</span><span class=p>]</span>
<span class=n>server</span><span class=o>.</span><span class=n>socket_host</span><span class=p>:</span> <span class=s2>&quot;0.0.0.0&quot;</span>
<span class=n>server</span><span class=o>.</span><span class=n>socket_port</span><span class=p>:</span> <span class=mi>8080</span>
<span class=n>server</span><span class=o>.</span><span class=n>thread_pool</span><span class=p>:</span> <span class=mi>10</span>
<span class=n>engine</span><span class=o>.</span><span class=n>autoreload</span><span class=o>.</span><span class=n>on</span><span class=p>:</span> <span class=kc>False</span>
<span class=n>log</span><span class=o>.</span><span class=n>error_file</span><span class=p>:</span> <span class=s2>&quot;./logs/error.log&quot;</span>
<span class=n>log</span><span class=o>.</span><span class=n>access_file</span><span class=p>:</span> <span class=s2>&quot;./logs/access.log&quot;</span>
</pre></div> <p>File config này được viết theo cú pháp của CherryPy, bạn có thể tham khảo cú pháp đó trong trong Web của CherryPy. Ở đây, tôi đã cấu hình một vài thông số cơ bản như Web server sẽ chạy ở cổng <code>8080</code> và các giá trị về thread pool, các file log, ...</p> <p>Dưới đây là nội dung file <code>app.conf</code></p> <div class=codehilite><pre><span></span><span class=p>[</span><span class=o>/</span><span class=p>]</span>
<span class=n>tools</span><span class=o>.</span><span class=n>staticdir</span><span class=o>.</span><span class=n>root</span><span class=p>:</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>normpath</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>curdir</span><span class=p>))</span>
<span class=n>tools</span><span class=o>.</span><span class=n>staticfile</span><span class=o>.</span><span class=n>root</span><span class=p>:</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>normpath</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>curdir</span><span class=p>))</span>
<span class=n>tools</span><span class=o>.</span><span class=n>encode</span><span class=o>.</span><span class=n>on</span><span class=p>:</span> <span class=kc>True</span>
<span class=n>tools</span><span class=o>.</span><span class=n>gzip</span><span class=o>.</span><span class=n>on</span><span class=p>:</span> <span class=kc>True</span>
<span class=n>tools</span><span class=o>.</span><span class=n>gzip</span><span class=o>.</span><span class=n>mime_types</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;text/html&#39;</span><span class=p>,</span> <span class=s1>&#39;text/plain&#39;</span><span class=p>,</span> <span class=s1>&#39;application/json&#39;</span><span class=p>,</span> <span class=s1>&#39;text/javascript&#39;</span><span class=p>,</span> <span class=s1>&#39;application/javascript&#39;</span><span class=p>]</span>
<span class=n>tools</span><span class=o>.</span><span class=n>sessions</span><span class=o>.</span><span class=n>on</span><span class=p>:</span> <span class=kc>True</span>
<span class=n>tools</span><span class=o>.</span><span class=n>sessions</span><span class=o>.</span><span class=n>timeout</span><span class=p>:</span> <span class=mi>60</span>
<span class=n>tools</span><span class=o>.</span><span class=n>sessions</span><span class=o>.</span><span class=n>storage_type</span><span class=p>:</span> <span class=s2>&quot;file&quot;</span>
<span class=n>tools</span><span class=o>.</span><span class=n>sessions</span><span class=o>.</span><span class=n>storage_path</span><span class=p>:</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>tempfile</span><span class=o>.</span><span class=n>gettempdir</span><span class=p>(),</span> <span class=s2>&quot;sessions&quot;</span><span class=p>)</span>

<span class=p>[</span><span class=o>/</span><span class=n>static</span><span class=p>]</span>
<span class=n>tools</span><span class=o>.</span><span class=n>etags</span><span class=o>.</span><span class=n>on</span><span class=p>:</span> <span class=kc>True</span>
<span class=n>tools</span><span class=o>.</span><span class=n>staticdir</span><span class=o>.</span><span class=n>on</span><span class=p>:</span> <span class=kc>True</span>
<span class=n>tools</span><span class=o>.</span><span class=n>staticdir</span><span class=o>.</span><span class=n>dir</span><span class=p>:</span> <span class=s2>&quot;public&quot;</span>
</pre></div> <p>Những nội dung cụ thể của file này, tôi sẽ lần lượt giới thiệu sau đây.</p> <h2 id=cac-file-tinh-css-javascript>Các file tĩnh (CSS, JavaScript,...)<a class=headerlink href=#cac-file-tinh-css-javascript title="Permanent link">&para;</a></h2> <p>Các file CSS, JavaScript, và file ảnh, ... là các file tĩnh với một ứng dụng Web. Nó sẽ được load cùng với trang Web và không thay đổi nội dung trong suốt quá trình thao tác với trang Web đó. CherryPy cung cấp công cụ riêng để load các file này. Với ví dụ của chúng ta, các file tĩnh đặt trong thư mục <code>public</code>, và tôi muốn CherryPy sẽ load các file này với path tương tự như <code>/static/app.js</code>. Để làm được điều này, chỉ cần cấu hình trong file <code>app.conf</code> là đủ:</p> <div class=codehilite><pre><span></span><span class=p>[</span><span class=o>/</span><span class=p>]</span>
<span class=n>tools</span><span class=o>.</span><span class=n>staticdir</span><span class=o>.</span><span class=n>root</span><span class=p>:</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>normpath</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>curdir</span><span class=p>))</span>
<span class=n>tools</span><span class=o>.</span><span class=n>staticfile</span><span class=o>.</span><span class=n>root</span><span class=p>:</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>normpath</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>curdir</span><span class=p>))</span>

<span class=p>[</span><span class=o>/</span><span class=n>static</span><span class=p>]</span>
<span class=n>tools</span><span class=o>.</span><span class=n>etags</span><span class=o>.</span><span class=n>on</span><span class=p>:</span> <span class=kc>True</span>
<span class=n>tools</span><span class=o>.</span><span class=n>staticdir</span><span class=o>.</span><span class=n>on</span><span class=p>:</span> <span class=kc>True</span>
<span class=n>tools</span><span class=o>.</span><span class=n>staticdir</span><span class=o>.</span><span class=n>dir</span><span class=p>:</span> <span class=s2>&quot;public&quot;</span>
</pre></div> <p>Với cấu hình trên, mỗi khi Web server muốn load một file tĩnh, ví dụ <code>/static/app.js</code> thì CherryPy sẽ tìm file tương ứng là <code>public/app.js</code> để load ra. Tương tự với các file CSS và file ảnh.</p> <h2 id=khoi-tao-app>Khởi tạo app<a class=headerlink href=#khoi-tao-app title="Permanent link">&para;</a></h2> <p>Trong ví dụ của tôi, app controller sẽ được lập trình trong file <code>webapp/app.py</code>. Trước hết, cần khởi tạo app với việc import các package cần thiết và khởi tạo template engine</p> <div class=codehilite><pre><span></span><span class=c1># -*- coding: utf-8 -*-</span>

<span class=kn>import</span> <span class=nn>cherrypy</span>
<span class=kn>import</span> <span class=nn>jinja2</span>

<span class=n>__all__</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;VpyeuBank&quot;</span><span class=p>]</span>


<span class=k>class</span> <span class=nc>VpyeuBank</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>

    <span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>_tmp_loader</span> <span class=o>=</span> <span class=n>jinja2</span><span class=o>.</span><span class=n>FileSystemLoader</span><span class=p>(</span><span class=n>searchpath</span><span class=o>=</span><span class=s2>&quot;template&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>tmp_env</span> <span class=o>=</span> <span class=n>jinja2</span><span class=o>.</span><span class=n>Environment</span><span class=p>(</span><span class=n>loader</span><span class=o>=</span><span class=n>_tmp_loader</span><span class=p>)</span>
</pre></div> <p>Như vậy template engine đã được khởi tạo, nó sẽ tìm các file trong thư mục <code>template</code> khi render.</p> <h2 id=viet-app>Viết app<a class=headerlink href=#viet-app title="Permanent link">&para;</a></h2> <div class=codehilite><pre><span></span><span class=nd>@cherrypy</span><span class=o>.</span><span class=n>expose</span>
<span class=k>def</span> <span class=nf>index</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
    <span class=n>template</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tmp_env</span><span class=o>.</span><span class=n>get_template</span><span class=p>(</span><span class=s2>&quot;index.jinja&quot;</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>template</span><span class=o>.</span><span class=n>render</span><span class=p>()</span>
</pre></div> <p>Đây là hàm <code>index</code>, nó sẽ nhận request khi truy cập vào địa URL <code>http://locahost:8080/</code> và trả về là nội dung đã được render của file <code>index.jinja</code></p> <p>Jinja2 không yêu cầu tên file có chứa phần mở rộng như thế nào, nên ở đây tôi sử dụng tên file là <code>*.jinja</code>. Jinja2 cho phép kế thừa và module hóa các template, nên bạn có thể chia các file template thành các file nhỏ và thư mục giống như các template engine khác. Ở ứng dụng của tôi, tôi sẽ sử dụng 1 file <code>layout.jinja</code> để xây dựng nên layout chính của trang Web, và các file khác ứng với các route khác, sẽ kế thừa file layout này và điền nội dung vào phần còn thiếu. Nội dung file <code>layout.jinja</code> như sau:</p> <div class=codehilite><pre><span></span><span class=cp>&lt;!DOCTYPE html&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&quot;viewport&quot;</span> <span class=na>content</span><span class=o>=</span><span class=s>&quot;width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no&quot;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&quot;content-type&quot;</span> <span class=na>content</span><span class=o>=</span><span class=s>&quot;text/html; charset=UTF-8&quot;</span><span class=p>&gt;</span>
    <span class=c>&lt;!-- phần này sẽ load các file icon, js, css, và cá thẻ meta khác --&gt;</span>

    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span><span class=cp>{%</span> <span class=k>block</span> <span class=nv>title</span> <span class=cp>%}{%</span> <span class=k>endblock</span> <span class=cp>%}</span>
      - yunachan yeu
    <span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>

  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>nav</span><span class=p>&gt;</span>
      <span class=c>&lt;!-- phần này sẽ là navbar --&gt;</span>
    <span class=p>&lt;/</span><span class=nt>nav</span><span class=p>&gt;</span>

    <span class=cp>{%</span> <span class=k>block</span> <span class=nv>content</span> <span class=cp>%}{%</span> <span class=k>endblock</span> <span class=cp>%}</span>

    <span class=p>&lt;</span><span class=nt>footer</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;page-footer&quot;</span><span class=p>&gt;</span>
      <span class=c>&lt;!-- phần này là footer --&gt;</span>
    <span class=p>&lt;/</span><span class=nt>footer</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</pre></div> <p>Trên đây là nội dung của file layout. File này đã định nghĩa trước các block, ví dụ <code>{% block content %}{% endblock %}</code> sẽ là phần nội dung chính của trang Web. Sau này khi kế thừa, các file khác sẽ điền nội dung vào block này. Tương tụ với các block khác. Nếu bạn sử dụng layout khác, bạn hoàn toàn có thể viết lại layout này, và define nhiều block hơn nếu bạn cần.</p> <p>Nội dung file <code>index.jinja</code> như sau. File này sẽ kế thừa layout và điền nội dung vào content.</p> <div class=codehilite><pre><span></span><span class=cp>{%</span> <span class=k>extends</span> <span class=s2>&quot;layout.jinja&quot;</span> <span class=cp>%}</span>

<span class=cp>{%</span> <span class=k>block</span> <span class=nv>title</span> <span class=cp>%}</span>Top page<span class=cp>{%</span> <span class=k>endblock</span> <span class=cp>%}</span>

<span class=cp>{%</span> <span class=k>block</span> <span class=nv>content</span> <span class=cp>%}</span>
<span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&quot;container&quot;</span><span class=p>&gt;</span>
  <span class=c>&lt;!-- phần này là nội dung cần điền --&gt;</span>
<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
<span class=cp>{%</span> <span class=k>endblock</span> <span class=cp>%}</span>
</pre></div> <p>Cú pháp của Jinja2 được giới thiệu rất cụ thể <a href=http://jinja.pocoo.org/docs/dev/templates/ >ở đây</a>. Bạn có thể đọc và tham khảo để sau này sử dụng cho project của bạn.</p> <p>Và với trang Web này, bạn thể sử dụng các CSS framework và các thư viện JavaScript để viết ứng dụng Web của mình trở nên sinh động và dễ sử dụng.</p> <h2 id=thao-tac-voi-json>Thao tác với JSON<a class=headerlink href=#thao-tac-voi-json title="Permanent link">&para;</a></h2> <p>Khi lập trình Web, thường xuyên bạn sẽ gặp trường hợp server cần trả về kết quả kiểu JSON thay vì HTML truyền thống. Ví dụ như bạn lập trình API cho các ứng dụng di động hay đơn giản là trả kết quả cho request từ AJAX.</p> <p>CherryPy cho phép bạn thực hiện điều này dễ dàng nhờ có decorator <code>@cherypy.tools.json_out()</code>. Ví dụ như sau:</p> <div class=codehilite><pre><span></span><span class=nd>@cherrypy</span><span class=o>.</span><span class=n>expose</span>
<span class=nd>@cherrypy</span><span class=o>.</span><span class=n>tools</span><span class=o>.</span><span class=n>json_out</span><span class=p>()</span>
<span class=k>def</span> <span class=nf>some_func</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>):</span>
    <span class=c1># Some process</span>
    <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;status&quot;</span><span class=p>:</span> <span class=s2>&quot;success&quot;</span><span class=p>,</span> <span class=s2>&quot;result&quot;</span><span class=p>:</span> <span class=n>result</span><span class=p>}</span>
</pre></div> <p>Ví dụ với hàm trên, decorator <code>@cherrypy.expose</code> sẽ cho phép hàm <code>some_func</code> được truy cập thông qua các request HTTP, decorator <code>@cherypy.tools.json_out()</code> sẽ làm hàm trả kết quả là dữ liệu kiểu JSON thay vì HTML mặc định. Kết quả trả về của hàm phải là kiểu dict của Python, ví dụ <code>{"status": "success", "result": result}</code>, khi đó, server Web sẽ trả kết quả cho request là dữ liệu kiểu JSON, giống như <code>{status: success, result: result}</code> cùng với header của gói tin HTTP.</p> <p>Với decorator này, bạn có thể dễ dàng lập trình các API trả kết quả JSON dùng cho các ứng dụng đi động hay AJAX.</p> <p>CherryPy còn cung cấp 1 decorator nữa, đó là <code>@cherrypy.tools.json_in()</code>. Decorator này sẽ khiến hàm sẽ nhận tham số dầu vào là dữ liệu kiểu JSON thay vì request HTTP mặc định. Tuy nhiên cần lưu ý rằng, trong phát triển các Web thông thường, các submit từ form hay AJAX đều sử dụng các request HTTP thông thường (GET, POST, ...) chứ ít khi gửi dữ liệu JSON. Trường hợp dữ liệu gửi đi là JSON ít gặp nên tôi sẽ không đi sâu ở đây. Nếu quan tâm, bạn có thể tham khảo ở docs của CherryPy.</p> <h2 id=i18n-cho-jinja2>I18n cho Jinja2<a class=headerlink href=#i18n-cho-jinja2 title="Permanent link">&para;</a></h2> <p>Có 1 công cụ i18n được viết cho CherryPy ở <a href=http://tools.cherrypy.org/wiki/LocalizationTranslation>đây</a>. Tuy nhiên, đây là công cụ được viết cho CherryPy, tức là sẽ được dùng với các Web chỉ dùng CherryPy đơn thuần. Ở trong bài viết này, tôi sử dụng Jinja2 là template engine nên công cụ trên không sử dụng được.</p> <p>Jinja2 có hỗ trợ phần mở rộng i18n, bạn có thể tham khảo phần mở rộng này ở <a href=http://jinja.pocoo.org/docs/dev/extensions/#i18n-extension>đây</a>. Tài liệu viết rất đầy đủ những gì Jinja2 hỗ trợ. Tuy nhiên, họ không đưa ra ví dụ cụ thể cách sử dụng nên khá khó khăn với những người mới bắt đầu. Dưới đây, tôi sẽ giới thiệu chi tiết về i18n đối với Jinja2.</p> <p>Để sử dụng i18n, yêu cầu cần là phải có 1 translator, nó sẽ giúp dịch các đoạn text và Jinja2 sẽ tích hợp chúng vào HTML. Có thể sử dụng GNU gettext để làm translator. Tuy nhiên, tôi sẽ sử dụng babel, vì đơn giản, babel được viết cho Python nên dùng trong Python sẽ dễ dàng hơn. Thông tin về babel bạn có thể tham khảo ở <a href=http://babel.pocoo.org>đây</a>.</p> <p>Trước hết để sử dụng, bạn cần cài đặt babel</p> <div class=codehilite><pre><span></span><span class=gp>$</span> pip install babel
</pre></div> <p>Ở trong controller chính của app, bạn hãy khởi tạo i18n cho Jinja2 tương tự như sau (có thể khởi tạo trong hàm <code>__init__</code>)</p> <div class=codehilite><pre><span></span><span class=kn>import</span> <span class=nn>babel.support</span>

<span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
    <span class=n>_tmp_loader</span> <span class=o>=</span> <span class=n>jinja2</span><span class=o>.</span><span class=n>FileSystemLoader</span><span class=p>(</span><span class=n>searchpath</span><span class=o>=</span><span class=s2>&quot;template&quot;</span><span class=p>)</span>
    <span class=n>translations</span> <span class=o>=</span> <span class=n>babel</span><span class=o>.</span><span class=n>support</span><span class=o>.</span><span class=n>Translations</span><span class=o>.</span><span class=n>load</span><span class=p>(</span>
        <span class=s2>&quot;locale&quot;</span><span class=p>,</span>
        <span class=p>[</span><span class=s2>&quot;vi_VN&quot;</span><span class=p>]</span>
    <span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>language</span> <span class=o>=</span> <span class=s2>&quot;vi_VN&quot;</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>tmp_env</span> <span class=o>=</span> <span class=n>jinja2</span><span class=o>.</span><span class=n>Environment</span><span class=p>(</span>
        <span class=n>loader</span><span class=o>=</span><span class=n>_tmp_loader</span><span class=p>,</span>
        <span class=n>extensions</span><span class=o>=</span><span class=p>[</span>
            <span class=s2>&quot;jinja2.ext.i18n&quot;</span><span class=p>,</span>
            <span class=s2>&quot;jinja2.ext.autoescape&quot;</span><span class=p>,</span>
            <span class=s2>&quot;jinja2.ext.with_&quot;</span>
        <span class=p>]</span>
    <span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>tmp_env</span><span class=o>.</span><span class=n>install_gettext_translations</span><span class=p>(</span><span class=n>translations</span><span class=p>)</span>
</pre></div> <p>Với khởi tạo như trên, Jinja2 sẽ tìm kiếm các file template trong thư mục <code>tempalte</code> và tìm cách file ngôn ngữ đã được dịch trong thư mục <code>locale</code>, ngôn ngữ được khởi tạo là <code>vi_VN</code>. Tất cả các khởi tạo này đều có thể thay đổi tùy theo nhu cầu và mục đích trang Web của bạn. Thậm chí, bạn có thể khởi tạo ngôn ngữ tùy theo setting hay IP của người dùng, nhằm giúp họ có được sự thoải mái khi truy cập trang Web của bạn.</p> <p>Đến đây, sau khi đã khởi tạo translator đầy đủ, bạn có thể sử dụng các thẻ <code>{% trans %}</code> trong file template. Với các thể này, Jinja2 sẽ biết thay thế bằng cách đoạn văn bản tương ứng với ngôn ngữ. Ví dụ.</p> <div class=codehilite><pre><span></span><span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span><span class=cp>{%</span> <span class=k>trans</span> <span class=cp>%}</span>hello<span class=cp>{%</span> <span class=k>endtrans</span> <span class=cp>%}</span><span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</pre></div> <p>Việc cần làm bây giờ là bạn cần định nghĩa các đoạn văn bản tương ứng với các thẻ <code>trans</code> trên. Với babel, công việc này khá là đơn giản. Babel sẽ giúp bạn đưa ra danh sách các cụm từ cần dịch một cách tự động. Trước hết bạn cần cầu hình cho babel</p> <div class=codehilite><pre><span></span><span class=p>[</span><span class=n>jinja2</span><span class=p>:</span> <span class=o>**/</span><span class=n>template</span><span class=o>/**.</span><span class=n>jinja</span><span class=p>]</span>
<span class=n>encoding</span> <span class=o>=</span> <span class=n>utf</span><span class=o>-</span><span class=mi>8</span>
<span class=p>[</span><span class=n>python</span><span class=p>:</span> <span class=n>source</span><span class=o>/*.</span><span class=n>py</span><span class=p>]</span>
<span class=p>[</span><span class=n>extractors</span><span class=p>]</span>
<span class=n>jinja2</span> <span class=o>=</span> <span class=n>jinja2</span><span class=o>.</span><span class=n>ext</span><span class=p>:</span><span class=n>babel_extract</span>
</pre></div> <p>Với config trên, babel sẽ tìm thẻ <code>trans</code> ở tất cả các file <code>.jinja</code> và file <code>.py</code> và đưa ra danh sách các cụm từ cần dịch. Sau đó, bạn chạy lệnh dưới đây, babel sẽ tập hợp danh sách thành 1 file (lệnh này sẽ nhận config từ file <code>./babel.cfg</code> và ghi kết quả ra file <code>./locale/messages.pot</code>). Bạn có thể thay đổi đường dẫn của chúng nếu muốn.</p> <div class=codehilite><pre><span></span><span class=gp>$</span> pybabel extract -F ./babel.cfg -o ./locale/messages.pot ./
</pre></div> <p>Bây giờ là đến công việc, gọi là địa phương hóa ngôn ngữ. Câu lệnh dưới đây sẽ khởi tạo ngôn ngữ <code>vi_VN</code>.</p> <div class=codehilite><pre><span></span><span class=gp>$</span> pybabel init -l vi_VN -d ./locale -i ./locale/messages.pot
</pre></div> <p>Lệnh trên chỉ sử dụng khi khởi tạo, nếu đã từng khởi tạo rồi, thì chỉ cần update nội dung các file dịch với lệnh dưới đây (dùng lệnh trên cũng được nhưng nó sẽ xóa những gì bạn làm trước đó đi và bạn phải làm lại từ đầu):</p> <div class=codehilite><pre><span></span><span class=gp>$</span> pybabel update -l vi_VN -d ./locale -i ./locale/messages.pot
</pre></div> <p>Các lệnh này sẽ cập nhật kết quả vào file <code>locale\vi_VN\LC_MESSAGES\messages.po</code>. Ở file này, bạn cần quan tâm đến những thông tin tương tự như sau:</p> <div class=codehilite><pre><span></span><span class=go>msgid: &quot;hello&quot;</span>
<span class=go>msgstr: &quot;&quot;</span>
</pre></div> <p><code>msgid</code> là text bên trong thẻ <code>trans</code> và <code>msgstr</code> là đoạn text tương ứng trong ngôn ngữ cần dịch, ở đây là <code>vi_VN</code>. Việc cần làm lúc này là sửa file trên, thêm lời dịch cho đoạn văn bản. Ví dụ:</p> <div class=codehilite><pre><span></span><span class=go>msgid: &quot;hello&quot;</span>
<span class=go>msgstr: &quot;xin chào&quot;</span>
</pre></div> <p>Vậy là đã xong, bây giờ bạn cần biên dịch file trên thành 1 file mà Jinja2 có thể hiểu và tích hợp vào HTML:</p> <div class=codehilite><pre><span></span><span class=gp>$</span> pybabel compile -f -d ./locale
</pre></div> <p>Đến đây là đã hoàn thành công việc. Bây giờ, mỗi thẻ <code>trans</code> trên file template khi hiển thị sẽ được thay thế bằng đoạn văn tương ứng. Ví dụ</p> <div class=codehilite><pre><span></span><span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span><span class=cp>{%</span> <span class=k>trans</span> <span class=cp>%}</span>hello<span class=cp>{%</span> <span class=k>endtrans</span> <span class=cp>%}</span><span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</pre></div> <p>sẽ được thay bằng</p> <div class=codehilite><pre><span></span><span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>xin chào<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</pre></div> <p>như với ví dụ của tôi.</p> <p>Trên đây tôi chỉ nêu ra 1 ví dụ với ngôn ngữ <code>vi_VN</code>. Bạn có thể mở rộng với các ngôn ngữ khác. Jinja2 không giới hạn bạn có thể dùng bao nhiêu ngôn ngữ. Điều đó là tùy thuộc vào bạn.</p> <h2 id=authentication>Authentication<a class=headerlink href=#authentication title="Permanent link">&para;</a></h2> <p>Nếu trên trang Web của bạn, có những nơi bạn muốn giới hạn với mọi người, chỉ một số người được quyền truy cập. Bạn có thể sử dụng Authentication. CherryPy cung cấp cả 2 hình thức authentication là Basic và Digest. Dưới đây tôi sẽ trình bày về cách sử dụng Digest authentication, Basic cũng tương tự như vậy. Để bảo vệ trong trang Web của bạn, rất đơn giản, hay thêm vào file config như sau (với trang web của tôi, config là <code>conf/app.conf</code>)</p> <div class=codehilite><pre><span></span><span class=p>[</span><span class=o>/</span><span class=n>protected</span><span class=p>]</span>
<span class=n>tools</span><span class=o>.</span><span class=n>auth_digest</span><span class=o>.</span><span class=n>on</span><span class=p>:</span> <span class=kc>True</span>
<span class=n>tools</span><span class=o>.</span><span class=n>auth_digest</span><span class=o>.</span><span class=n>realm</span><span class=p>:</span> <span class=s2>&quot;vpyeu&quot;</span>
<span class=n>tools</span><span class=o>.</span><span class=n>auth_digest</span><span class=o>.</span><span class=n>get_ha1</span><span class=p>:</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>auth_digest</span><span class=o>.</span><span class=n>get_ha1_dict_plain</span><span class=p>({</span><span class=s2>&quot;user&quot;</span><span class=p>:</span> <span class=s2>&quot;passwd&quot;</span><span class=p>})</span>
<span class=n>tools</span><span class=o>.</span><span class=n>auth_digest</span><span class=o>.</span><span class=n>key</span><span class=p>:</span> <span class=s2>&quot;a565c27146791cfb&quot;</span>
</pre></div> <p>Với config như vậy thì khi truy cập <code>/protected</code> trang Web sẽ yêu cầu người dùng điền username và password để xác thực.</p> <p>CherryPy cho phép bạn có thể config authentication khác nhau với những đường dẫn khác nhau. Tuy nhiên, có 1 hạn chế là nếu nhiều đường dẫn có cùng authentication thì CherryPy không cung cấp config theo regex hay wildcard nên bạn sẽ phải copy paste những đoạn config giống nhau cho các đường dẫn khác nhau.</p> <h1 id=su-dung-sqlalchemy-lam-orm>Sử dụng SQLAlchemy làm ORM<a class=headerlink href=#su-dung-sqlalchemy-lam-orm title="Permanent link">&para;</a></h1> <p>Như đã được giới thiệu, CherryPy là một Web server đơn thuần. Nó không cung cấp bất cứ một template engine nào cũng như ORM nào. Và chúng ta đã sử dụng Jinja2 làm template engine để phát triển Web. Ở phần này, tôi sẽ giới thiệu việc sử dụng SQLAlchemy làm ORM trong ứng dụng Web viết bằng CherryPy.</p> <h2 id=gioi-thieu-sqlalchemy>Giới thiệu SQLAlchemy<a class=headerlink href=#gioi-thieu-sqlalchemy title="Permanent link">&para;</a></h2> <p>SQLAlchemy là một bộ công cụ SQL của Python và nó cũng là một ORM (Object Relational Mapper) cung cấp cho những người lập trình ứng dụng đầy đủ sức mạnh và sự mềm dẻo của SQL.</p> <p>Nó cung cấp một bộ đầy đủ các pattern nổi tiếng. Nó được thiết kế cho việc truy cập cơ sở dữ liệu hiệu quả và hiệu suất cao, đồng thời cho phép lập trình với phong cách Pythonic.</p> <h2 id=tai-sao-lai-dung-sqlalchemy>Tại sao lại dùng SQLALchemy<a class=headerlink href=#tai-sao-lai-dung-sqlalchemy title="Permanent link">&para;</a></h2> <p>Thực ra, lần đầu tiên dữ dụng ORM cho Python, tôi đã sử dụng SQLAlchemy, lúc đầu nó cũng không dễ dùng cho lắm. Nhưng càng đi sâu tìm hiểu, tôi càng thấy nó thú vị. Nó có rất nhiều tính năng hay. Bạn có thể tham khảo ở <a href=http://www.sqlalchemy.org/features.html>đây</a>. Ngoài ra SQLAlchemy được sử dụng với rất nhiều hãng công nghệ nổi tiếng như Reddit, Mozilla. Thực sự nó quá đầy đủ và mạnh mẽ. Nó đủ tốt tới mức tôi không tìm thấy lý do gì để phải tìm kiếm một ORM tốt hơn nữa. Vì vậy tôi đã quyết định dùng SQLAlchemy.</p> <h2 id=cai-at-vao-su-dung>Cài đặt vào sử dụng<a class=headerlink href=#cai-at-vao-su-dung title="Permanent link">&para;</a></h2> <p>Cài đặt SQLAlchemy rất đơn giản thông qua <code>pip</code>. Với virtualenv đã được kích hoạt, bạn có thể cài SQLAlchemy với lệnh sau:</p> <div class=codehilite><pre><span></span><span class=gp>$</span> pip install sqlalchemy
</pre></div> <p>Sau khi cài đặt, bạn có thể import nó giống như các package Python khác.</p> <h3 id=su-dung-sqlalchemy-lam-plugin-cho-cherrypy>Sử dụng SQLAlchemy làm plugin cho CherryPy<a class=headerlink href=#su-dung-sqlalchemy-lam-plugin-cho-cherrypy title="Permanent link">&para;</a></h3> <p>Sau khi tham khảo một vài nơi, có nhiều người đã viết các tool dùng để tích hợp SQLAlchemy vào CherryPy. Một ví dụ là ở <a href=http://tools.cherrypy.org/wiki/SQLA>đây</a>. Thường thì các tool này khá giống nhau. Và bạn có thể sử dụng bất cứ tool nào bạn thích. Tất nhiên, tôi chọn các tool có sẵn vì chúng rất đầy đủ và giúp chúng ta có thêm thời gian để tập trung vào phát triển app. Nếu muốn tìm hiểu sâu hơn cũng như muốn sử dụng tool của riêng mình, bạn hoàn toàn có thể tự phát triển nó, không sao cả. Dưới đây là tool tôi sử dụng. Tôi lưu nó trong file <code>lib/tool/db.py</code></p> <div class=codehilite><pre><span></span><span class=kn>import</span> <span class=nn>cherrypy</span>

<span class=n>__all__</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;SATool&#39;</span><span class=p>]</span>

<span class=k>class</span> <span class=nc>SATool</span><span class=p>(</span><span class=n>cherrypy</span><span class=o>.</span><span class=n>Tool</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        The SA tool is responsible for associating a SA session</span>
<span class=sd>        to the SA engine and attaching it to the current request.</span>
<span class=sd>        Since we are running in a multithreaded application,</span>
<span class=sd>        we use the scoped_session that will create a session</span>
<span class=sd>        on a per thread basis so that you don&#39;t worry about</span>
<span class=sd>        concurrency on the session object itself.</span>
<span class=sd>        This tools binds a session to the engine each time</span>
<span class=sd>        a requests starts and commits/rollbacks whenever</span>
<span class=sd>        the request terminates.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>cherrypy</span><span class=o>.</span><span class=n>Tool</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s1>&#39;on_start_resource&#39;</span><span class=p>,</span>
                               <span class=bp>self</span><span class=o>.</span><span class=n>bind_session</span><span class=p>,</span>
                               <span class=n>priority</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>_setup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>cherrypy</span><span class=o>.</span><span class=n>Tool</span><span class=o>.</span><span class=n>_setup</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
        <span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>hooks</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=s1>&#39;on_end_resource&#39;</span><span class=p>,</span>
                                      <span class=bp>self</span><span class=o>.</span><span class=n>commit_transaction</span><span class=p>,</span>
                                      <span class=n>priority</span><span class=o>=</span><span class=mi>80</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>bind_session</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Attaches a session to the request&#39;s scope by requesting</span>
<span class=sd>        the SA plugin to bind a session to the SA engine.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>session</span> <span class=o>=</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>engine</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s1>&#39;bind-session&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>pop</span><span class=p>()</span>
        <span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>db</span> <span class=o>=</span> <span class=n>session</span>

    <span class=k>def</span> <span class=nf>commit_transaction</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Commits the current transaction or rolls back</span>
<span class=sd>        if an error occurs.  Removes the session handle</span>
<span class=sd>        from the request&#39;s scope.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=p>,</span> <span class=s1>&#39;db&#39;</span><span class=p>):</span>
            <span class=k>return</span>
        <span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>db</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=n>cherrypy</span><span class=o>.</span><span class=n>engine</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s1>&#39;commit-session&#39;</span><span class=p>)</span>
</pre></div> <p>Tool này cần 1 plugin cho CherryPy. Nội dung plugin như sau (<code>lib/plugin/db_plugin.py</code>):</p> <div class=codehilite><pre><span></span><span class=kn>import</span> <span class=nn>cherrypy</span>
<span class=kn>from</span> <span class=nn>cherrypy.process</span> <span class=k>import</span> <span class=n>wspbus</span><span class=p>,</span> <span class=n>plugins</span>
<span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=k>import</span> <span class=n>create_engine</span>
<span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=k>import</span> <span class=n>scoped_session</span><span class=p>,</span> <span class=n>sessionmaker</span>

<span class=kn>from</span> <span class=nn>lib.model</span> <span class=k>import</span> <span class=n>ORBase</span>
<span class=kn>from</span> <span class=nn>conf</span> <span class=k>import</span> <span class=n>db</span>

<span class=n>__all__</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;SAEnginePlugin&#39;</span><span class=p>]</span>

<span class=k>class</span> <span class=nc>SAEnginePlugin</span><span class=p>(</span><span class=n>plugins</span><span class=o>.</span><span class=n>SimplePlugin</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>bus</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        The plugin is registered to the CherryPy engine and therefore</span>
<span class=sd>        is part of the bus (the engine *is* a bus) registery.</span>
<span class=sd>        We use this plugin to create the SA engine.  At the same time,</span>
<span class=sd>        when the plugin starts we create the tables into the database</span>
<span class=sd>        using the mapped class of the global metadata.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>plugins</span><span class=o>.</span><span class=n>SimplePlugin</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>bus</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>sa_engine</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>session</span> <span class=o>=</span> <span class=n>scoped_session</span><span class=p>(</span><span class=n>sessionmaker</span><span class=p>(</span><span class=n>autoflush</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
                                                   <span class=n>autocommit</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>

    <span class=k>def</span> <span class=nf>start</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=s1>&#39;Starting up DB access&#39;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>sa_engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>url</span><span class=p>,</span> <span class=n>echo</span><span class=o>=</span><span class=n>db</span><span class=o>.</span><span class=n>echo</span><span class=p>)</span>
        <span class=c1>#TODO: Make this configurable</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>create_all</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&quot;bind-session&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>bind</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&quot;commit-session&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>commit</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>stop</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=s1>&#39;Stopping down DB access&#39;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=o>.</span><span class=n>unsubscribe</span><span class=p>(</span><span class=s2>&quot;bind-session&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>bind</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=o>.</span><span class=n>unsubscribe</span><span class=p>(</span><span class=s2>&quot;commit-session&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>commit</span><span class=p>)</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>sa_engine</span><span class=p>:</span>
            <span class=c1>#self.destroy_all()</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>sa_engine</span><span class=o>.</span><span class=n>dispose</span><span class=p>()</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>sa_engine</span> <span class=o>=</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>bind</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Whenever this plugin receives the &#39;bind-session&#39; command, it applies</span>
<span class=sd>        this method and to bind the current session to the engine.</span>
<span class=sd>        It then returns the session to the caller.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>configure</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>sa_engine</span><span class=p>)</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>session</span>

    <span class=k>def</span> <span class=nf>commit</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Commits the current transaction or rollbacks if an error occurs.</span>
<span class=sd>        In all cases, the current session is unbound and therefore</span>
<span class=sd>        not usable any longer.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
        <span class=k>except</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
            <span class=k>raise</span>
        <span class=k>finally</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>remove</span><span class=p>()</span>

    <span class=k>def</span> <span class=nf>create_all</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=s1>&#39;Creating database&#39;</span><span class=p>)</span>
        <span class=kn>from</span> <span class=nn>lib.model.user</span> <span class=k>import</span> <span class=n>User</span>
        <span class=n>ORBase</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>create_all</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sa_engine</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>destroy_all</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=s1>&#39;Destroying database&#39;</span><span class=p>)</span>
        <span class=n>ORBase</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>drop_all</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sa_engine</span><span class=p>)</span>
</pre></div> <p>Sau khi có tool trên rồi, bạn cần kích hoạt database cho CherryPy bằng config như sau (<code>conf/app.conf</code>):</p> <div class=codehilite><pre><span></span><span class=p>[</span><span class=o>/</span><span class=p>]</span>
<span class=n>tools</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>on</span><span class=p>:</span> <span class=kc>True</span>
</pre></div> <p>Và ở file <code>server.py</code>, bạn cần import và khởi tạo tool này.</p> <div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>lib.tool</span> <span class=k>import</span> <span class=n>db</span>
<span class=kn>from</span> <span class=nn>lib.plugin</span> <span class=k>import</span> <span class=n>db_plugin</span>

<span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
    <span class=n>engine</span> <span class=o>=</span> <span class=n>cherrypy</span><span class=o>.</span><span class=n>engine</span>
    <span class=n>cherrypy</span><span class=o>.</span><span class=n>tools</span><span class=o>.</span><span class=n>db</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>SATool</span><span class=p>()</span>
    <span class=n>engine</span><span class=o>.</span><span class=n>db</span> <span class=o>=</span> <span class=n>db_plugin</span><span class=o>.</span><span class=n>SAEngine</span><span class=p>(</span><span class=n>engine</span><span class=p>)</span>
    <span class=n>engine</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>subscribe</span><span class=p>()</span>
</pre></div> <p>Vậy là bạn đã có thể sử dụng SQLALchemy làm ORM như một plug in cho CherryPy. Bây giờ bạn có thể tạo các model và controller cho chúng.</p> <h3 id=tao-model>Tạo model<a class=headerlink href=#tao-model title="Permanent link">&para;</a></h3> <p>Tôi sẽ tạo các model trong thư mục <code>lib/model</code>. Trước hết, tôi khởi tạo những ORBase để sử dụng sau này</p> <div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>sqlalchemy.ext.declarative</span> <span class=k>import</span> <span class=n>declarative_base</span>

<span class=n>__all__</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;ORBase&quot;</span><span class=p>]</span>

<span class=n>ORBase</span> <span class=o>=</span> <span class=n>declarative_base</span><span class=p>()</span>
</pre></div> <p>Bây giờ, thử tạo 1 model user như sau:</p> <div class=codehilite><pre><span></span><span class=kn>import</span> <span class=nn>cherrypy</span>
<span class=kn>import</span> <span class=nn>sqlalchemy</span>
<span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=k>import</span> <span class=n>Column</span><span class=p>,</span> <span class=n>UniqueConstraint</span><span class=p>,</span> <span class=n>Index</span>
<span class=kn>from</span> <span class=nn>sqlalchemy.types</span> <span class=k>import</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>String</span><span class=p>,</span> <span class=n>Boolean</span>

<span class=kn>from</span> <span class=nn>lib.model</span> <span class=k>import</span> <span class=n>ORBase</span>

<span class=n>__all__</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;User&quot;</span><span class=p>]</span>


<span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>ORBase</span><span class=p>):</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&quot;users&quot;</span>

    <span class=n>user_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>name</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>20</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
    <span class=n>fullname</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>50</span><span class=p>))</span>
    <span class=n>email</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>50</span><span class=p>))</span>
    <span class=n>password</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>128</span><span class=p>))</span>
    <span class=n>Index</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</pre></div> <p>Với khởi tạo model user như trên, SQLAlchemy như tạo một table trên database là <code>users</code> với các trường được định nghĩa và đánh index cho trường <code>user_id</code>. Ngoài ra, trong file model này, bạn có thể định nghĩa các thuộc tính cũng như phương thức của model sau này chúng sẽ được sử dụng trên controller.</p> <h3 id=tuong-tac-voi-database>Tương tác với database<a class=headerlink href=#tuong-tac-voi-database title="Permanent link">&para;</a></h3> <p>Bây giờ, SQLAlchemy đã được plug vào CherryPy, nên bạn có thể thao tác các query với database thông qua <code>cherrypy.request.db</code>. Dưới đây, tôi sẽ giới thiệu một số thao tác cơ bản với database.</p> <h4 id=lay-cac-ban-ghi-tu-database>Lấy các bản ghi từ database<a class=headerlink href=#lay-cac-ban-ghi-tu-database title="Permanent link">&para;</a></h4> <div class=codehilite><pre><span></span><span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>User</span><span class=p>)</span>
</pre></div> <p>Nếu muốn thêm điều kiện nào đó, bạn có thể sử dụng thêm <code>filter</code>. Ví dụ</p> <div class=codehilite><pre><span></span><span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>User</span><span class=o>.</span><span class=n>user_id</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>)</span>
</pre></div> <p>Kết quả trả về của các câu query trên sẽ là object chứ danh sách các đối tượng tương ứng với các bản ghi trên database. Nếu muốn lấy bản ghi đầu tiên, bạn có thể thêm <code>.first()</code>.</p> <div class=codehilite><pre><span></span><span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>User</span><span class=o>.</span><span class=n>user_id</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</pre></div> <p>Nếu muốn sắp xếp, bạn có thể dùng <code>order_by</code>.</p> <div class=codehilite><pre><span></span><span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>User</span><span class=o>.</span><span class=n>user_id</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>)</span><span class=o>.</span><span class=n>order_by</span><span class=p>(</span><span class=n>User</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>desc</span><span class=p>())</span>
</pre></div> <p>Nếu muốn sử dụng các điều kiện phức tạp hơn, bạn có thể kết hợp chúng bằng các phép toán logic như <code>and_</code>, <code>or_</code>, <code>not_</code>...</p> <h4 id=them-ban-ghi-vao-database>Thêm bản ghi vào database<a class=headerlink href=#them-ban-ghi-vao-database title="Permanent link">&para;</a></h4> <div class=codehilite><pre><span></span><span class=c1># khởi tạo object ở đây</span>
<span class=n>new_user</span> <span class=o>=</span> <span class=n>User</span><span class=p>()</span>
<span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>new_user</span><span class=p>)</span>
<span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</pre></div> <h4 id=xoa-ban-ghi-khoi-database>Xóa bản ghi khỏi database<a class=headerlink href=#xoa-ban-ghi-khoi-database title="Permanent link">&para;</a></h4> <div class=codehilite><pre><span></span><span class=n>user</span> <span class=o>=</span> <span class=c1># lấy user từ database</span>
<span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
<span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</pre></div> <h4 id=update-ban-ghi-ang-co>Update bản ghi đang có<a class=headerlink href=#update-ban-ghi-ang-co title="Permanent link">&para;</a></h4> <div class=codehilite><pre><span></span><span class=n>user</span> <span class=o>=</span> <span class=c1># lấy user từ trong database.</span>
<span class=n>user</span><span class=o>.</span><span class=n>update</span><span class=p>()</span>
<span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
<span class=n>cherrypy</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</pre></div> <p>Như các bạn đã thấy, mọi thao tác với database đều kết thực với <code>cherrypy.request.db.commit()</code>. Thao tác này sẽ yêu cầu SQLAlchemy thao tác lệnh với database, trong khi các thao trước đó mới chỉ được lưu tạm thời. Nếu không có bước commit này, tất cả các thao tác trước đó sẽ không làm thay đổi database. SQLAlchemy không yêu cầu bạn phải commit từng thao tác của mình. Bạn có thể để một vài thay đổi được commit cùng 1 lúc cũng không sao cả. Điều đó phụ thuộc vào bạn và app của bạn.</p> <p>Nếu bạn không muốn phải thực hiện commit bằng tay như vậy, bạn có thể config cho SQLAlchemy tự động thực hiện điều đó, bằng cách sử dụng option <code>autocommit=True</code> khi tạo session cho SQLAlchemy.</p> <div class=codehilite><pre><span></span><span class=n>scoped_session</span><span class=p>(</span><span class=n>sessionmaker</span><span class=p>(</span><span class=n>autoflush</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>autocommit</span><span class=o>=</span><span class=kc>True</span><span class=p>))</span>
</pre></div> <p>Các thông tin về SQLAlchemy bạn có thể xem thêm tại <a href=http://www.sqlalchemy.org>http://www.sqlalchemy.org</a>.</p> <h1 id=demo>Demo<a class=headerlink href=#demo title="Permanent link">&para;</a></h1> <p>Bạn có thể xem một demo ở <a href=http://vpyeu-bank.herokuapp.com>đây</a>.</p> <p>Đây là demo một trang Web đơn giản sử dụng các kiến thức trong bài viết này. Sử dụng Cherrypy, Jinja2 và SQLALchemy. Trang Web có thể chuyển đổi 2 ngôn ngữ Việt và Anh.</p> <h1 id=ket-luan>Kết luận<a class=headerlink href=#ket-luan title="Permanent link">&para;</a></h1> <p>CherryPy cùng với Jinja2 và SQLALchemy tạo thành 1 bộ công cụ rất tốt để phát triển Web. Có thể nó hơi khó khăn khi mới bắt đầu. Nhưng sau khi tìm hiểu kỹ, tôi tìn rằng, bạn sẽ thích nó ngay. Và biết thêm framework mới, bạn có nhiều lựa chọn hơn khi muốn viết một trang Web cho riêng mình, và bạn sẽ tìm được framework thích hợ nhất. Chúc thành công.</p> <h1 id=tai-lieu-tham-khao>Tài liệu tham khảo<a class=headerlink href=#tai-lieu-tham-khao title="Permanent link">&para;</a></h1> <ul> <li><a href=http://docs.cherrypy.org/en/latest/ >CherryPy docs</a></li> <li><a href=http://jinja.pocoo.org/docs/dev/ >Jinja2 docs</a></li> <li><a href=http://docs.sqlalchemy.org/en/rel_1_0/ >SQLAlchemy docs</a></li> <li><a href=https://bitbucket.org/Lawouach/twiseless/src>Sample project</a></li> <li><a href=http://babel.pocoo.org/docs/ >Babel docs</a></li> </ul> </div> <div class=post-footer> <div class=tags> <i class="fa fa-tags"></i> <span>#Python</span> <span>#Cherrypy</span> <span>#Jinja2</span> <span>#SQLAlchemy</span> <span>#Web</span> </div> </div> </div><div class=blog-pager> <span class=newer-link> <a href=/2015/Sep/30/hash-length-extension-attacks.html> Newer Post </a> </span> <span class=older-link> <a href=/2015/Jul/30/ksnctf-write-up.html> Older Post </a> </span> </div><div class=comments> <div class=finally> <p><em>I apologise for any typos. If you notice a problem, please let me know.</em> <p>Thank you all for your attention. </div> <div id=disqus_thread></div> <script src=/theme/js/disqus.min.js?81e8a5f5></script> <noscript> Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript> comments powered by Disqus. </a> </noscript> </div></div> </div> </div> <div class=sidebar-wrapper> <div class=widget> <h2>Welcome</h2> <div> <img src=/theme/images/banner.gif alt=Welcome> </div> </div><div class="widget recent-posts"> <h2>Recent Posts</h2> <ul> <li> <a href=/2019/May/20/elasticsearch-data-organization.html> <img alt="Elasticsearch: Data organization" src=https://i.imgur.com/JT4y7Qf.jpg> </a> <a href=/2019/May/20/elasticsearch-data-organization.html>Elasticsearch: Data organization</a> <li> <a href=/2019/May/20/elasticsearch-intro.html> <img alt="Elasticsearch: Intro" src=https://i.imgur.com/JT4y7Qf.jpg> </a> <a href=/2019/May/20/elasticsearch-intro.html>Elasticsearch: Intro</a> <li> <a href=/2019/Apr/20/javascript-popups.html> <img alt="JavaScript: Popups" src=https://i.imgur.com/FxmcwPy.png> </a> <a href=/2019/Apr/20/javascript-popups.html>JavaScript: Popups</a> <li> <a href=/2019/Mar/20/javascript-iterator-and-generator.html> <img alt="JavaScript: Iterator and generator" src=https://i.imgur.com/lev8iT9.jpg> </a> <a href=/2019/Mar/20/javascript-iterator-and-generator.html>JavaScript: Iterator and generator</a> <li> <a href=/2019/Feb/20/javascript-decorator.html> <img alt="JavaScript decorator" src=https://i.imgur.com/Sh3yLI0.png> </a> <a href=/2019/Feb/20/javascript-decorator.html>JavaScript decorator</a> </ul> </div><div class="widget labels"> <h2>Blog Archive</h2> <ul> <li> <a href=/2019/ > 2019 </a> <li> <a href=/2018/ > 2018 </a> <li> <a href=/2017/ > 2017 </a> <li> <a href=/2016/ > 2016 </a> <li> <a href=/2015/ > 2015 </a> <li> <a href=/2014/ > 2014 </a> <li> <a href=/2013/ > 2013 </a> <li> <a href=/2012/ > 2012 </a> <li> <a href=/2011/ > 2011 </a> <li> <a href=/2010/ > 2010 </a> </ul> </div><div class=widget> <h2>Twitter timeline</h2> <a class=twitter-timeline data-height=500 data-dnt=true data-theme=light href=https://twitter.com/_naa_4f data-chrome="noheader nofooter transparent noborders"> Tweets by manhhomienbienthuy </a> </div> </div> </div> <a href=# class="smooth-scroll back-to-top"> <i class="fa fa-arrow-circle-up fa-3x"></i> </a> </main> <footer> <div class=infos> <div class=wrapper> <div class=widget> <a href=/ title="manhhomienbienthuy's space" class=logo> <img alt="manhhomienbienthuy's space" src=/theme/images/logo_white.png> </a> <span class=right>I'm a hacker, enter my world...</span> </div><div class=widget> <p> Created with all my ♥ and soul, dedicated to my love, yunachan <p> Powered by <a href=http://blog.getpelican.com/ target=_blank>Pelican</a>, which takes great advantage of <a href=https://www.python.org/ target=_blank>Python</a> <p> This site content is licensed under a <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank> CC BY-NC-ND 4.0 </a> License. <p> Updated at <a target=_blank href="http://www.timeanddate.com/worldclock/fixedtime.html?iso=2019-06-20T02:42:55"> 2019-06-20 02:42:55 </a> </div><div class=widget> <p> Hosting by <a href=https://manhhomienbienthuy.bitbucket.io/ >Bitbucket</a> and <a href=https://manhhomienbienthuy.github.io/ >Github</a>, image hosting by <a href=https://manhhomienbienthuy.imgur.com/ target=_blank>imgur</a>, <a href=https://instagram.com/manhhomienbienthuy/ target=_blank>Instagram</a> and <a href=https://photos.google.com/ target=_blank>Google Photo</a> <p> Theme based on <a href=https://vanice-veethemes.blogspot.com/ target=_blank>Vanice theme</a>, icons from <a href=https://fontawesome.com/ target=_blank>Font Awesome</a>, comments powered by <a href=https://disqus.com/home/forums/manhhomienbienthuy/ target=_blank>Disqus</a> </div> </div> </div> <div class=credits> <div class=wrapper> <div class=left> <!--
          Regarding copyright, in general, standalone pages (as
          opposed to files generated as part of manuals) on the GNU
          web server should be under CC BY-ND 4.0.  Please do NOT
          change or remove this without talking with the webmasters or
          licensing team first.  Please make sure the copyright date
          is consistent with the document.  For web pages, it is ok to
          list just the latest year the document was modified, or
          published.

          If you wish to list earlier years, that is ok too.  Either
          "2001, 2002, 2003" or "2001-2003" are ok for specifying
          years, as long as each year in the range is in fact a
          copyrightable year, i.e., a year in which the document was
          published (including being publicly visible on the web or in
          a revision control system).
        --> Copyright © 2010-2019 <a href=/pages/about-me.html><strong>manhhomienbienthuy</strong></a>. All rights reserved. </div> <div class=right> <ul> <li><a href=/ >Home</a> <li><a href=/pages/about-me.html>About</a> <li><a href=# class=smooth-scroll>Top ↑</a> </ul> </div> </div> </div></footer> <script src=https://code.jquery.com/jquery-3.2.1.js></script> <script src=//cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js></script> <script src=//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.2/imagesloaded.pkgd.min.js></script> <script src=/theme/js/vpyeu.min.js?d72c87bd></script> <script id=dsq-count-scr src=https://manhhomienbienthuy.disqus.com/count.js async></script>